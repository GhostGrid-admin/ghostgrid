<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kod & Projekt ‚Äì GhostGrid</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
  <div class="forum-container">
    <h1>üíª Kod & Projekt</h1>
    <div id="thread-list"></div>
    <form id="newThreadForm" style="display: none">
      <input type="text" id="threadTitle" placeholder="Rubrik p√• tr√•den" required><br>
      <textarea id="threadContent" placeholder="Vad vill du diskutera?"></textarea><br>
      <input type="file" id="threadImage" accept="image/*"><br>
      <button type="submit">Skicka</button>
    </form>
    <p id="loginMessage" style="color: red; display: none">Du m√•ste vara inloggad f√∂r att skapa en tr√•d.</p>
  </div>

  <script>
    const threadList = document.getElementById("thread-list");
    const form = document.getElementById("newThreadForm");
    const loginMsg = document.getElementById("loginMessage");

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        form.style.display = "block";
        loginMsg.style.display = "none";
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const title = document.getElementById("threadTitle").value;
          const content = document.getElementById("threadContent").value;
          const imageFile = document.getElementById("threadImage").files[0];
          let imageUrl = "";

          if (imageFile) {
            const storageRef = firebase.storage().ref("threadImages/" + Date.now() + "_" + imageFile.name);
            await storageRef.put(imageFile);
            imageUrl = await storageRef.getDownloadURL();
          }

          await firebase.firestore().collection("forumThreads").add({
            title,
            content,
            image: imageUrl,
            created: Date.now(),
            category: "Kod & Projekt",
            user: user.email || user.uid,
            comments: [],
            userReactions: {}
          });

          form.reset();
        });
      } else {
        form.style.display = "none";
        loginMsg.style.display = "block";
      }
    });

    firebase.firestore().collection("forumThreads")
      .where("category", "==", "Kod & Projekt")
      .orderBy("created", "desc")
      .onSnapshot(snapshot => {
        threadList.innerHTML = "";
        if (snapshot.empty) {
          const p = document.createElement("p");
          p.textContent = "Det finns √§nnu inga tr√•dar i denna kategori.";
          threadList.appendChild(p);
        } else {
          snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement("div");
            div.className = "thread-box";
            const threadId = doc.id;
            const reactionHTML = [
              "üëç", "üëé", "‚ù§Ô∏è", "üíî", "üòÄ", "üò¢", "üò≤", "üò°", "üòê"
            ].map(icon => `<span class="react" data-id="${threadId}" data-icon="${icon}">${icon}</span>`).join(" ");

            div.innerHTML = `
              <h3>${data.title}</h3>
              ${data.content ? `<p>${data.content}</p>` : ""}
              ${data.image ? `<img src="${data.image}" style="max-width:100%;margin-top:10px;border-radius:8px;">` : ""}
              <div class="reactions">${reactionHTML}</div>
              <div class="comments">
                <h4>Kommentarer:</h4>
                <div id="comments-${threadId}"></div>
                <textarea placeholder="Skriv en kommentar..." id="comment-${threadId}"></textarea>
                <button onclick="submitComment('${threadId}')">Kommentera</button>
              </div>
            `;
            threadList.appendChild(div);

            if (data.comments) {
              const commentDiv = document.getElementById(`comments-${threadId}`);
              data.comments.forEach(c => {
                const p = document.createElement("p");
                p.textContent = `üí¨ ${c.user}: ${c.text}`;
                commentDiv.appendChild(p);
              });
            }
          });
        }
      });

    async function submitComment(threadId) {
      const textarea = document.getElementById(`comment-${threadId}`);
      const comment = textarea.value.trim();
      if (!comment) return;

      const user = firebase.auth().currentUser;
      if (!user) return alert("Du m√•ste vara inloggad f√∂r att kommentera.");

      const threadRef = firebase.firestore().collection("forumThreads").doc(threadId);
      await threadRef.update({
        comments: firebase.firestore.FieldValue.arrayUnion({
          user: user.email || user.uid,
          text: comment,
          created: Date.now()
        })
      });
      textarea.value = "";
    }

    document.addEventListener("click", async function(e) {
      if (e.target.classList.contains("react")) {
        const icon = e.target.dataset.icon;
        const id = e.target.dataset.id;
        const user = firebase.auth().currentUser;
        if (!user) return alert("Du m√•ste vara inloggad f√∂r att reagera.");

        const threadRef = firebase.firestore().collection("forumThreads").doc(id);
        await threadRef.update({
          [`userReactions.${user.uid}`]: icon
        });
      }
    });
  </script>
</body>
</html>
