<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GhostGrid ‚Äì Ladda upp</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ... Din tidigare CSS ... */
    body { background: #0a0a0a; color: #e0ffff; font-family: 'Courier New', monospace; min-height: 100vh; margin: 0; padding-top: 85px; position: relative; overflow-x: hidden;}
    /* ...Resten av din CSS... */
    .logout-btn {
      background: #10191f;
      color: #00ffcc;
      border: 2px solid #00ffcc;
      padding: 7px 20px;
      border-radius: 9px;
      font-weight: bold;
      font-size: 1.08em;
      box-shadow: 0 0 10px #00ffcc77;
      cursor: pointer;
      margin-left: 20px;
      transition: background 0.2s, color 0.2s;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .logout-btn:hover { background: #00ffcc; color: #14171c;}
    /* Desktop: placerad l√§ngst till h√∂ger i navbaren */
    .logout-btn.navbar { position: absolute; right: 24px; top: 13px; z-index: 2002; }
    /* Mobil: syns sist i hamburgermenyn */
    @media (max-width: 700px) {
      .logout-btn.navbar { display: none; }
      .logout-btn.menu { display: block; width: 94vw; margin: 19px auto 2px auto; }
    }
    @media (min-width: 701px) {
      .logout-btn.menu { display: none; }
    }
  </style>
</head>
<body>
  <div class="glow-left"></div>
  <div class="glow-right"></div>
  <div class="side-banner left"><div class="banner-inner"><a id="leftBannerLink" href="#" target="_blank"><img id="leftBannerImg" src="https://dummyimage.com/120x1800/7b00ff/fff&text=Reklam+1" alt="Reklam" /></a></div></div>
  <div class="side-banner right"><div class="banner-inner"><a id="rightBannerLink" href="#" target="_blank"><img id="rightBannerImg" src="https://dummyimage.com/120x1800/222299/fff&text=Reklam+2" alt="Reklam" /></a></div></div>
  <!-- LOGGA UT-KNAPP: desktop-l√§ge -->
  <button class="logout-btn navbar" id="logoutBtnNavbar" style="display:none;">Logga ut</button>
  <nav class="navbar">
    <div class="hamburger" id="hamburgerBtn" aria-label="Meny" tabindex="0"><span></span><span></span><span></span></div>
    <div class="nav-content" id="navMenu">
      <a href="forum.html" id="forumTab"></a>
      <a href="wall.html" id="wallTab"></a>
      <a href="upload.html" id="uploadTab"></a>
      <a href="profile.html" id="profileTab"></a>
      <a href="friends.html" id="friendsTab"></a>
      <a href="ghostglow.html" id="ghostglowTab"></a>
      <a href="store.html" id="storeTab"></a>
      <!-- LOGGA UT-KNAPP: mobil-l√§ge (sist i hamburgermenyn) -->
      <button class="logout-btn menu" id="logoutBtnMenu" style="display:none;">Logga ut</button>
    </div>
  </nav>
  <div class="upload-box" id="uploadBox">
    <div class="upload-title" id="uploadTitle"></div>
    <img id="spinner" src="spinner-asg.png" alt="Laddar..." />
    <div class="upload-switcher">
      <button class="switch-btn active" data-section="text" id="btnText"></button>
      <button class="switch-btn" data-section="image" id="btnImage"></button>
      <button class="switch-btn" data-section="video" id="btnVideo"></button>
      <button class="switch-btn" data-section="audio" id="btnAudio"></button>
      <button class="switch-btn" data-section="mic" id="btnMic"></button>
    </div>
    <form id="uploadForm">
      <!-- TEXT -->
      <div class="upload-section active" data-section="text">
        <label for="text" id="labelText"></label>
        <textarea id="text" placeholder="" maxlength="1500"></textarea>
      </div>
      <!-- BILD -->
      <div class="upload-section" data-section="image">
        <label for="image" id="labelImage"></label>
        <input type="file" id="image" accept="image/*" />
        <div class="desc-section">
          <label for="imageDesc" id="labelImageDesc"></label>
          <input type="text" id="imageDesc" maxlength="140" placeholder="" />
        </div>
      </div>
      <!-- VIDEO -->
      <div class="upload-section" data-section="video">
        <label for="video" id="labelVideo"></label>
        <input type="file" id="video" accept="video/mp4,video/webm,video/ogg" />
        <div class="desc-section">
          <label for="videoDesc" id="labelVideoDesc"></label>
          <input type="text" id="videoDesc" maxlength="140" placeholder="" />
        </div>
      </div>
      <!-- AUDIO -->
      <div class="upload-section" data-section="audio">
        <label for="audio" id="labelAudio"></label>
        <input type="file" id="audio" accept="audio/*" />
        <div class="desc-section">
          <label for="audioDesc" id="labelAudioDesc"></label>
          <input type="text" id="audioDesc" maxlength="140" placeholder="" />
        </div>
      </div>
      <!-- R√ñSTINSPELNING -->
      <div class="upload-section" data-section="mic">
        <label id="labelMic"></label>
        <button type="button" id="recordButton"></button>
        <button type="button" id="stopButton" disabled></button>
        <audio id="audioPreview" controls></audio>
        <div class="desc-section">
          <label for="micDesc" id="labelMicDesc"></label>
          <input type="text" id="micDesc" maxlength="140" placeholder="" />
        </div>
      </div>
      <label style="margin-top:18px;">
        <input type="checkbox" id="temporary" />
        <span id="tempLabel"></span>
      </label>
      <button type="submit" style="margin-top:18px;" id="uploadBtn"></button>
    </form>
  </div>
  <script>
    // SIDBANNER ROTATION (v√§nster och h√∂ger)
    const banners = [
      { left: { src: "https://dummyimage.com/120x1800/7b00ff/fff&text=Reklam+1", alt: "Reklam Banner 1", url: "#" }, right: { src: "https://dummyimage.com/120x1800/222299/fff&text=Reklam+2", alt: "Reklam Banner 2", url: "#" }},
      { left: { src: "https://dummyimage.com/120x1800/ff0088/fff&text=Bli+medlem!", alt: "Bli medlem", url: "register.html" }, right: { src: "https://dummyimage.com/120x1800/0077ff/fff&text=Annonsera+H√§r", alt: "Annonsera", url: "#" }}
    ];
    let bannerIndex = 0;
    function updateBanners() {
      const left = banners[bannerIndex].left, right = banners[bannerIndex].right;
      document.getElementById('leftBannerImg').src = left.src; document.getElementById('leftBannerImg').alt = left.alt; document.getElementById('leftBannerLink').href = left.url;
      document.getElementById('rightBannerImg').src = right.src; document.getElementById('rightBannerImg').alt = right.alt; document.getElementById('rightBannerLink').href = right.url;
    }
    updateBanners(); setInterval(() => { bannerIndex = (bannerIndex + 1) % banners.length; updateBanners(); }, 6000);

    // --- Hamburgermeny logik ---
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const navMenu = document.getElementById('navMenu');
    hamburgerBtn.addEventListener('click', function() {
      navMenu.classList.toggle('show');
    });
    navMenu.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        navMenu.classList.remove('show');
      });
    });

    // Spr√•kv√§xling f√∂r hela UI:t
    const dict = {
      sv: {
        forum: "Forum", wall: "V√§ggen", upload: "Ladda upp", profile: "Profil", friends: "V√§nner", ghostglow: "Ghost&Glow", store: "Butik",
        uploadTitle: "Ladda upp inneh√•ll", textBtn: "üìù Inl√§gg", imageBtn: "üñºÔ∏è Bild", videoBtn: "üé¨ Klipp", audioBtn: "üéµ Ljud", micBtn: "üé§ R√∂st",
        labelText: "Skriv ett inl√§gg:", labelImage: "Ladda upp en bild (max 5 MB):", labelVideo: "Ladda upp ett klipp (max 30 MB):",
        labelAudio: "Ladda upp ljudfil (max 5 MB):", labelMic: "Mikrofoninspelning (max 2 MB):",
        labelImageDesc: "Beskrivning:", labelVideoDesc: "Beskrivning:", labelAudioDesc: "Beskrivning:", labelMicDesc: "Beskrivning:",
        placeholderText: "Vad vill du dela med dig av?", placeholderImage: "Beskriv bilden...", placeholderVideo: "Beskriv klippet...",
        placeholderAudio: "Beskriv ljudet...", placeholderMic: "Beskriv r√∂stinspelningen...",
        tempLabel: "G√∂r detta till ett tillf√§lligt inl√§gg (f√∂rsvinner om 24h)", uploadBtn: "Ladda upp",
        recordBtn: "üé§ Starta inspelning", stopBtn: "üõë Stoppa", logout: "Logga ut"
      },
      en: {
        forum: "Forum", wall: "Wall", upload: "Upload", profile: "Profile", friends: "Friends", ghostglow: "Ghost&Glow", store: "Store",
        uploadTitle: "Upload Content", textBtn: "üìù Post", imageBtn: "üñºÔ∏è Image", videoBtn: "üé¨ Clip", audioBtn: "üéµ Audio", micBtn: "üé§ Voice",
        labelText: "Write a post:", labelImage: "Upload an image (max 5 MB):", labelVideo: "Upload a clip (max 30 MB):",
        labelAudio: "Upload audio file (max 5 MB):", labelMic: "Voice recording (max 2 MB):",
        labelImageDesc: "Description:", labelVideoDesc: "Description:", labelAudioDesc: "Description:", labelMicDesc: "Description:",
        placeholderText: "What do you want to share?", placeholderImage: "Describe the image...", placeholderVideo: "Describe the clip...",
        placeholderAudio: "Describe the audio...", placeholderMic: "Describe the voice recording...",
        tempLabel: "Make this a temporary post (disappears after 24h)", uploadBtn: "Upload",
        recordBtn: "üé§ Start recording", stopBtn: "üõë Stop", logout: "Sign out"
      }
    };
    const lang = localStorage.lang === "en" ? "en" : "sv";
    function i18n() {
      document.getElementById("forumTab").textContent = dict[lang].forum;
      document.getElementById("wallTab").textContent = dict[lang].wall;
      document.getElementById("uploadTab").textContent = dict[lang].upload;
      document.getElementById("profileTab").textContent = dict[lang].profile;
      document.getElementById("friendsTab").textContent = dict[lang].friends;
      document.getElementById("ghostglowTab").textContent = dict[lang].ghostglow;
      document.getElementById("storeTab").textContent = dict[lang].store;
      document.getElementById("logoutBtnNavbar").textContent = dict[lang].logout;
      document.getElementById("logoutBtnMenu").textContent = dict[lang].logout;
      document.getElementById("uploadTitle").textContent = dict[lang].uploadTitle;
      document.getElementById("btnText").textContent = dict[lang].textBtn;
      document.getElementById("btnImage").textContent = dict[lang].imageBtn;
      document.getElementById("btnVideo").textContent = dict[lang].videoBtn;
      document.getElementById("btnAudio").textContent = dict[lang].audioBtn;
      document.getElementById("btnMic").textContent = dict[lang].micBtn;
      document.getElementById("labelText").textContent = dict[lang].labelText;
      document.getElementById("labelImage").textContent = dict[lang].labelImage;
      document.getElementById("labelImageDesc").textContent = dict[lang].labelImageDesc;
      document.getElementById("labelVideo").textContent = dict[lang].labelVideo;
      document.getElementById("labelVideoDesc").textContent = dict[lang].labelVideoDesc;
      document.getElementById("labelAudio").textContent = dict[lang].labelAudio;
      document.getElementById("labelAudioDesc").textContent = dict[lang].labelAudioDesc;
      document.getElementById("labelMic").textContent = dict[lang].labelMic;
      document.getElementById("labelMicDesc").textContent = dict[lang].labelMicDesc;
      document.getElementById("text").placeholder = dict[lang].placeholderText;
      document.getElementById("imageDesc").placeholder = dict[lang].placeholderImage;
      document.getElementById("videoDesc").placeholder = dict[lang].placeholderVideo;
      document.getElementById("audioDesc").placeholder = dict[lang].placeholderAudio;
      document.getElementById("micDesc").placeholder = dict[lang].placeholderMic;
      document.getElementById("tempLabel").textContent = dict[lang].tempLabel;
      document.getElementById("uploadBtn").textContent = dict[lang].uploadBtn;
      document.getElementById("recordButton").textContent = dict[lang].recordBtn;
      document.getElementById("stopButton").textContent = dict[lang].stopBtn;
    }
    i18n();

    // Visa logga ut-knappen n√§r anv√§ndaren √§r inloggad
    let userLoggedIn = false;
    function showLogout() {
      userLoggedIn = true;
      document.getElementById("logoutBtnNavbar").style.display = window.innerWidth > 700 ? "flex" : "none";
      document.getElementById("logoutBtnMenu").style.display = window.innerWidth <= 700 ? "block" : "none";
    }
    window.addEventListener("resize", () => {
      if (userLoggedIn) {
        document.getElementById("logoutBtnNavbar").style.display = window.innerWidth > 700 ? "flex" : "none";
        document.getElementById("logoutBtnMenu").style.display = window.innerWidth <= 700 ? "block" : "none";
      }
    });

    // NAVBAR HIDE p√• mobil
    if (window.innerWidth <= 600) {
      let lastScrollY = window.scrollY;
      let navbar = document.querySelector('.navbar');
      window.addEventListener('scroll', function () {
        if (window.scrollY > lastScrollY && window.scrollY > 70) { navbar.classList.add('hide-navbar'); } else { navbar.classList.remove('hide-navbar'); }
        lastScrollY = window.scrollY;
      });
    }

  </script>
  <!-- FIREBASE-INIT (du kan ha din vanliga scripts/firebase-init.js h√§r) -->
  <script type="module">
    import { auth, db, storage } from "./scripts/firebase-init.js";
    import {
      collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import {
      ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    const MAX_IMAGE_SIZE = 5 * 1024 * 1024;
    const MAX_VIDEO_SIZE = 30 * 1024 * 1024;
    const MAX_AUDIO_SIZE = 5 * 1024 * 1024;
    const MAX_MIC_SIZE = 2 * 1024 * 1024;

    const uploadForm = document.getElementById("uploadForm");
    const spinner = document.getElementById("spinner");
    const uploadBox = document.getElementById("uploadBox");

    // Logga ut
    document.getElementById("logoutBtnNavbar").onclick = () => signOut(auth).then(() => location.href = "login.html");
    document.getElementById("logoutBtnMenu").onclick = () => signOut(auth).then(() => location.href = "login.html");

    // Visa logga ut om inloggad
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        uploadBox.innerHTML = `
          <div style="text-align:center;padding:36px 0;font-size:1.23em;color:#ff7788;">
            ${lang === "en" ? "You must be logged in to upload content." : "Du m√•ste vara inloggad f√∂r att ladda upp inneh√•ll."}<br><br>
            <a href="login.html" style="color:#00ffcc;font-weight:bold;">${lang === "en" ? "Login here" : "Logga in h√§r"}</a>
          </div>
        `;
      } else {
        showLogout();
      }
    });

    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!auth.currentUser) {
        alert(lang === "en" ? "You must be logged in to upload." : "Du m√•ste vara inloggad f√∂r att ladda upp.");
        return;
      }
      spinner.style.display = "block";
      const activeSection = document.querySelector('.switch-btn.active').getAttribute('data-section');
      let postData = {
        createdAt: serverTimestamp(),
        user: auth.currentUser.uid,
        type: activeSection,
        temporary: document.getElementById("temporary").checked,
      };
      let filesToUpload = [];

      if (activeSection === "text") {
        postData.text = document.getElementById("text").value;
      }
      if (activeSection === "image") {
        const img = document.getElementById("image").files[0];
        if (img && img.size > MAX_IMAGE_SIZE) {
          spinner.style.display = "none";
          return alert(lang === "en" ? "Image too large! Max size: 5 MB." : "Bilden √§r f√∂r stor! Maxstorlek: 5 MB.");
        }
        filesToUpload.push({ file: img, key: "imageUrl" });
        postData.description = document.getElementById("imageDesc").value || "";
      }
      if (activeSection === "video") {
        const vid = document.getElementById("video").files[0];
        if (vid && vid.size > MAX_VIDEO_SIZE) {
          spinner.style.display = "none";
          return alert(lang === "en" ? "Video too large! Max size: 30 MB." : "Videoklippet √§r f√∂r stort! Maxstorlek: 30 MB.");
        }
        filesToUpload.push({ file: vid, key: "videoUrl" });
        postData.description = document.getElementById("videoDesc").value || "";
      }
      if (activeSection === "audio") {
        const aud = document.getElementById("audio").files[0];
        if (aud && aud.size > MAX_AUDIO_SIZE) {
          spinner.style.display = "none";
          return alert(lang === "en" ? "Audio too large! Max size: 5 MB." : "Ljudfilen √§r f√∂r stor! Maxstorlek: 5 MB.");
        }
        filesToUpload.push({ file: aud, key: "audioUrl" });
        postData.description = document.getElementById("audioDesc").value || "";
      }
      if (activeSection === "mic") {
        const micBlob = window.lastRecordedAudioBlob;
        if (micBlob && micBlob.size > MAX_MIC_SIZE) {
          spinner.style.display = "none";
          return alert(lang === "en" ? "Voice recording too large! Max size: 2 MB." : "R√∂stinspelningen √§r f√∂r stor! Maxstorlek: 2 MB.");
        }
        if (micBlob) filesToUpload.push({ file: micBlob, key: "micAudioUrl" });
        postData.description = document.getElementById("micDesc").value || "";
      }

      // Ladda upp filer (om det finns)
      for (let upload of filesToUpload) {
        if (!upload.file) continue;
        const storageRef = ref(storage, `uploads/${Date.now()}_${upload.file.name}`);
        await uploadBytes(storageRef, upload.file);
        const url = await getDownloadURL(storageRef);
        postData[upload.key] = url;
      }

      // Spara posten p√• "v√§ggen"
      await addDoc(collection(db, "wall"), postData);

      spinner.style.display = "none";
      alert(lang === "en" ? "‚úÖ Post uploaded!" : "‚úÖ Inl√§gget har laddats upp!");
      uploadForm.reset();
      window.location.href = "wall.html";
    });

    // --- R√∂stinspelning ---
    let mediaRecorder, audioChunks = [];
    const recordBtn = document.getElementById("recordButton");
    const stopBtn = document.getElementById("stopButton");
    const audioPreview = document.getElementById("audioPreview");
    if (recordBtn && stopBtn && audioPreview) {
      recordBtn.onclick = async function () {
        audioChunks = [];
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        recordBtn.disabled = true;
        stopBtn.disabled = false;

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
          window.lastRecordedAudioBlob = audioBlob;
          audioPreview.src = URL.createObjectURL(audioBlob);
          recordBtn.disabled = false;
          stopBtn.disabled = true;
        };
      };
      stopBtn.onclick = function () {
        mediaRecorder && mediaRecorder.stop();
      };
    }
  </script>
</body>
</html>
