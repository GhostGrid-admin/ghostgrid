<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GhostGrid ‚Äì Ladda upp</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      margin: 0;
      padding-top: 85px;
      background-color: #0a0a0a;
      color: #e0ffff;
      font-family: 'Courier New', monospace;
      min-height: 100vh;
    }
    nav.navbar {
      background-color: #000;
      border-bottom: 2px solid #00ffcc;
      padding: 12px 0;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
      box-shadow: 0 0 20px #bb00ff;
      display: flex;
      justify-content: center;
      transition: top 0.3s;
    }
    .nav-content {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 16px;
      max-width: 900px;
      width: 100%;
      align-items: center;
      text-align: center;
    }
    .nav-content a {
      color: white;
      text-decoration: none;
      font-size: 1.2em;
      padding: 7px 10px;
      border-radius: 4px;
      text-shadow: 0 0 8px #00ffcc, 0 0 6px #bb00ff;
      transition: 0.3s;
    }
    .nav-content a:hover {
      background-color: #00ffcc;
      color: #000;
      box-shadow: 0 0 10px #ffffff;
    }
    .search-container {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-left: 10px;
    }
    .search-container input {
      padding: 8px 14px;
      font-size: 1.1em;
      font-family: 'Courier New', monospace;
      background-color: #111;
      border: 2px solid #00ffcc;
      border-radius: 8px;
      color: #ffffff;
      box-shadow: 0 0 8px #7b00ff, 0 0 3px #00ffcc;
      text-shadow: 0 0 2px #7b00ff, 0 0 2px #00ffcc;
      width: 90%;
      max-width: 250px;
    }
    .upload-box {
      border: 2px solid #66ffcc;
      border-radius: 12px;
      padding: 30px 20px 22px 20px;
      margin: 36px auto 32px auto;
      max-width: 440px;
      background-color: rgba(0, 0, 0, 0.88);
      box-shadow: 0 0 15px #00ffcc33;
      position: relative;
      z-index: 2;
      min-width: 0;
    }
    .upload-box h1 {
      text-align: center;
      color: #80ffcc;
      text-shadow: 0 0 4px #ffffff;
      margin-bottom: 18px;
    }
    .upload-switcher {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 22px;
      flex-wrap: wrap;
    }
    .switch-btn {
      background: #111;
      color: #80ffcc;
      border: 1px solid #66ffcc;
      border-radius: 5px;
      padding: 6px 14px;
      font-size: 1em;
      cursor: pointer;
      transition: 0.18s;
      font-family: 'Courier New', monospace;
    }
    .switch-btn.active,
    .switch-btn:hover {
      background: #00ffcc;
      color: #000;
      font-weight: bold;
      box-shadow: 0 0 8px #00ffcc;
    }
    textarea, input[type="file"], button[type="submit"], label {
      display: block;
      width: 100%;
      margin-top: 1rem;
      font-family: inherit;
      font-size: 1rem;
      color: #b8f6ff;
      background-color: #111;
      border: 1px solid #66ffcc;
      padding: 0.6rem;
      border-radius: 6px;
      box-sizing: border-box;
    }
    label {margin-bottom: -0.7rem;}
    button[type="submit"] {
      background-color: #00ffcc;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    button[type="submit"]:hover {
      background-color: #00ccaa;
    }
    #spinner {
      display: none;
      width: 50px;
      margin: 10px auto;
    }
    audio { margin-top: 10px; }
    .upload-section { display: none; }
    .upload-section.active { display: block; }
    @media (max-width: 600px) {
      nav.navbar {
        transition: top 0.3s;
      }
      nav.navbar.hide-navbar {
        top: -70px;
      }
      .nav-content { font-size: 1em; gap: 7px; }
      .upload-box {
        padding: 14px 2vw 12px 2vw;
        max-width: 99vw;
        margin: 18px 0 18px 0;
        border-radius: 10px;
      }
      .upload-box h1 { font-size: 1.1em; }
      .switch-btn { font-size: 0.97em; }
      .search-container input { width: 98vw; max-width: 98vw;}
    }
    @media (max-width: 390px) {
      .upload-box { padding: 8px 0 8px 0; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-content">
      <a href="forum.html">Forum</a>
      <a href="store.html">Store</a>
      <a href="wall.html">V√§ggen</a>
      <a href="upload.html">Ladda upp</a>
      <a href="profile.html">Profil</a>
      <a href="friends.html">V√§nner</a>
      <div class="search-container">
        <input type="text" placeholder="S√∂k..." id="searchInput" />
      </div>
    </div>
  </nav>
  <div class="upload-box">
    <h1>Ladda upp inneh√•ll</h1>
    <img id="spinner" src="spinner-asg.png" alt="Laddar..." />
    <div class="upload-switcher">
      <button class="switch-btn active" data-section="text">üìù Inl√§gg</button>
      <button class="switch-btn" data-section="image">üñºÔ∏è Bild</button>
      <button class="switch-btn" data-section="video">üé¨ Klipp</button>
      <button class="switch-btn" data-section="audio">üéµ Ljud</button>
      <button class="switch-btn" data-section="mic">üé§ R√∂st</button>
      <button class="switch-btn" data-section="combo">üîÄ Kombinera</button>
    </div>
    <form id="uploadForm">
      <!-- TEXT -->
      <div class="upload-section active" data-section="text">
        <label for="text">Skriv ett inl√§gg:</label>
        <textarea id="text" placeholder="Vad vill du dela med dig av?" maxlength="1500"></textarea>
      </div>
      <!-- BILD -->
      <div class="upload-section" data-section="image">
        <label for="image">Ladda upp en bild (max 5 MB):</label>
        <input type="file" id="image" accept="image/*" />
      </div>
      <!-- VIDEO -->
      <div class="upload-section" data-section="video">
        <label for="video">Ladda upp ett klipp (max 30 MB):</label>
        <input type="file" id="video" accept="video/mp4,video/webm,video/ogg" />
      </div>
      <!-- AUDIO -->
      <div class="upload-section" data-section="audio">
        <label for="audio">Ladda upp ljudfil (max 5 MB):</label>
        <input type="file" id="audio" accept="audio/*" />
      </div>
      <!-- R√ñSTINSPELNING -->
      <div class="upload-section" data-section="mic">
        <label>Mikrofoninspelning (max 2 MB):</label>
        <button type="button" id="recordButton">üé§ Starta inspelning</button>
        <button type="button" id="stopButton" disabled>üõë Stoppa</button>
        <audio id="audioPreview" controls></audio>
      </div>
      <!-- KOMBINERA -->
      <div class="upload-section" data-section="combo">
        <label for="comboText">Text till inl√§gget (valfritt):</label>
        <textarea id="comboText" placeholder="Skriv n√•got till din uppladdning..."></textarea>
        <label for="comboImage">Bild (max 5 MB, valfritt):</label>
        <input type="file" id="comboImage" accept="image/*" />
        <label for="comboVideo">Klipp (max 30 MB, valfritt):</label>
        <input type="file" id="comboVideo" accept="video/mp4,video/webm,video/ogg" />
        <label for="comboAudio">Ljudfil (max 5 MB, valfritt):</label>
        <input type="file" id="comboAudio" accept="audio/*" />
      </div>
      <label style="margin-top:18px;">
        <input type="checkbox" id="temporary" />
        G√∂r detta till ett tillf√§lligt inl√§gg (f√∂rsvinner om 24h)
      </label>
      <button type="submit" style="margin-top:18px;">Ladda upp</button>
    </form>
  </div>
  <script>
    // V√§xla mellan sektionerna
    document.querySelectorAll('.switch-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        document.querySelectorAll('.switch-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const section = this.getAttribute('data-section');
        document.querySelectorAll('.upload-section').forEach(sec => {
          sec.classList.remove('active');
          if (section === 'combo') {
            if (sec.getAttribute('data-section') === 'combo') sec.classList.add('active');
          } else {
            if (sec.getAttribute('data-section') === section) sec.classList.add('active');
          }
        });
      });
    });
    // S√∂k-f√§lt
    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.getElementById("searchInput");
      if (searchInput) {
        searchInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (query.length >= 2) {
              window.location.href = `search.html?q=${encodeURIComponent(query)}`;
            }
          }
        });
      }
    });
    // Navbar hide vid scroll p√• mobil
    if (window.innerWidth <= 600) {
      let lastScrollY = window.scrollY;
      let navbar = document.querySelector('.navbar');
      window.addEventListener('scroll', function () {
        if (window.scrollY > lastScrollY && window.scrollY > 70) {
          navbar.classList.add('hide-navbar');
        } else {
          navbar.classList.remove('hide-navbar');
        }
        lastScrollY = window.scrollY;
      });
    }
  </script>
  <script type="module">
    import { auth, db, storage } from "./scripts/firebase-init.js";
    import {
      collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import {
      ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";
    const MAX_IMAGE_SIZE = 5 * 1024 * 1024;
    const MAX_VIDEO_SIZE = 30 * 1024 * 1024;
    const MAX_AUDIO_SIZE = 5 * 1024 * 1024;
    const MAX_MIC_SIZE = 2 * 1024 * 1024;

    const uploadForm = document.getElementById("uploadForm");
    const spinner = document.getElementById("spinner");

    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      spinner.style.display = "block";
      const activeSection = document.querySelector('.upload-section.active').getAttribute('data-section');
      let postData = {
        createdAt: serverTimestamp(),
        user: auth.currentUser ? auth.currentUser.uid : "guest",
        type: activeSection,
        temporary: document.getElementById("temporary").checked,
      };
      let filesToUpload = [];

      if (activeSection === "text") {
        postData.text = document.getElementById("text").value;
      }
      if (activeSection === "image") {
        const img = document.getElementById("image").files[0];
        if (img && img.size > MAX_IMAGE_SIZE) {
          spinner.style.display = "none";
          return alert(`Bilden √§r f√∂r stor! Maxstorlek: 5 MB.`);
        }
        filesToUpload.push({ file: img, key: "imageUrl" });
      }
      if (activeSection === "video") {
        const vid = document.getElementById("video").files[0];
        if (vid && vid.size > MAX_VIDEO_SIZE) {
          spinner.style.display = "none";
          return alert(`Videoklippet √§r f√∂r stort! Maxstorlek: 30 MB.`);
        }
        filesToUpload.push({ file: vid, key: "videoUrl" });
      }
      if (activeSection === "audio") {
        const aud = document.getElementById("audio").files[0];
        if (aud && aud.size > MAX_AUDIO_SIZE) {
          spinner.style.display = "none";
          return alert(`Ljudfilen √§r f√∂r stor! Maxstorlek: 5 MB.`);
        }
        filesToUpload.push({ file: aud, key: "audioUrl" });
      }
      if (activeSection === "mic") {
        const micBlob = window.lastRecordedAudioBlob;
        if (micBlob && micBlob.size > MAX_MIC_SIZE) {
          spinner.style.display = "none";
          return alert(`R√∂stinspelningen √§r f√∂r stor! Maxstorlek: 2 MB.`);
        }
        if (micBlob) filesToUpload.push({ file: micBlob, key: "micAudioUrl" });
      }
      if (activeSection === "combo") {
        postData.text = document.getElementById("comboText").value;
        const comboImage = document.getElementById("comboImage").files[0];
        const comboVideo = document.getElementById("comboVideo").files[0];
        const comboAudio = document.getElementById("comboAudio").files[0];
        if (comboImage && comboImage.size > MAX_IMAGE_SIZE) {
          spinner.style.display = "none";
          return alert(`Bilden √§r f√∂r stor! Maxstorlek: 5 MB.`);
        }
        if (comboVideo && comboVideo.size > MAX_VIDEO_SIZE) {
          spinner.style.display = "none";
          return alert(`Videoklippet √§r f√∂r stort! Maxstorlek: 30 MB.`);
        }
        if (comboAudio && comboAudio.size > MAX_AUDIO_SIZE) {
          spinner.style.display = "none";
          return alert(`Ljudfilen √§r f√∂r stor! Maxstorlek: 5 MB.`);
        }
        if (comboImage) filesToUpload.push({ file: comboImage, key: "imageUrl" });
        if (comboVideo) filesToUpload.push({ file: comboVideo, key: "videoUrl" });
        if (comboAudio) filesToUpload.push({ file: comboAudio, key: "audioUrl" });
      }

      // Ladda upp filer (om det finns)
      for (let upload of filesToUpload) {
        if (!upload.file) continue;
        const storageRef = ref(storage, `uploads/${Date.now()}_${upload.file.name}`);
        await uploadBytes(storageRef, upload.file);
        const url = await getDownloadURL(storageRef);
        postData[upload.key] = url;
      }

      // Spara posten p√• "v√§ggen"
      await addDoc(collection(db, "wall"), postData);

      spinner.style.display = "none";
      alert("‚úÖ Inl√§gget har laddats upp!");
      uploadForm.reset();
      window.location.href = "wall.html";
    });

    // --- R√∂stinspelning ---
    let mediaRecorder, audioChunks = [];
    const recordBtn = document.getElementById("recordButton");
    const stopBtn = document.getElementById("stopButton");
    const audioPreview = document.getElementById("audioPreview");
    if (recordBtn && stopBtn && audioPreview) {
      recordBtn.onclick = async function () {
        audioChunks = [];
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        recordBtn.disabled = true;
        stopBtn.disabled = false;

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
          window.lastRecordedAudioBlob = audioBlob; // F√∂r uploaden!
          audioPreview.src = URL.createObjectURL(audioBlob);
          recordBtn.disabled = false;
          stopBtn.disabled = true;
        };
      };
      stopBtn.onclick = function () {
        mediaRecorder && mediaRecorder.stop();
      };
    }
  </script>
</body>
</html>
