<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GhostGrid – Ladda upp</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background: #0a0a0a;
      color: #e0ffff;
      font-family: 'Courier New', monospace;
      min-height: 100vh;
      margin: 0;
      padding-top: 85px;
      position: relative;
      overflow-x: hidden;
      opacity: 0; /* Dölj tills språk är satt */
      transition: opacity 0.13s;
    }
    body.ready {
      opacity: 1;
    }

    .glow-left, .glow-right {
      position: fixed;
      top: 0;
      width: 170px;
      height: 100vh;
      pointer-events: none;
      z-index: 0;
    }
    .glow-left {
      left: 0;
      background: radial-gradient(circle at left, #d900ff 0%, #7200ffcc 40%, transparent 85%);
      box-shadow: 0 0 80px 40px #d900ffbb, 0 0 240px 80px #00ffe0aa, 0 0 400px 120px #9400ff66;
    }
    .glow-right {
      right: 0;
      background: radial-gradient(circle at right, #d900ff 0%, #7200ffcc 40%, transparent 85%);
      box-shadow: 0 0 80px 40px #d900ffbb, 0 0 240px 80px #00ffe0aa, 0 0 400px 120px #9400ff66;
    }

    .side-banner {
      position: fixed;
      top: 87px;
      bottom: 0;
      width: 170px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      z-index: 1002;
      background: none;
      pointer-events: none;
    }
    .side-banner .banner-inner {
      width: 150px;
      height: 100%;
      background: transparent;
      border-radius: 12px;
      box-shadow: 0 0 18px #7b00ff99;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: auto;
    }
    .side-banner img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
      background: #220043;
      cursor: pointer;
      transition: box-shadow 0.3s;
      box-shadow: 0 0 10px #8800ff70;
      pointer-events: auto;
      min-height: 200px;
    }
    .side-banner.left { left: 0; }
    .side-banner.right { right: 0; }
    @media (max-width: 1100px) {
      .side-banner, .glow-left, .glow-right { width: 85px; }
      .side-banner .banner-inner { width: 75px; }
    }
    @media (max-width: 900px) {
      .side-banner, .glow-left, .glow-right { display: none; }
    }

    nav.navbar {
      background: #000;
      border-bottom: 2px solid #00ffcc;
      padding: 0;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      z-index: 1000;
      box-shadow: 0 0 20px #bb00ff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 60px;
      transition: top 0.3s, border-bottom 0.3s;
    }

.nav-center {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1200; /* se till att länkar ligger ovanför andra element */
}

.nav-links {
  display: flex;
  gap: 26px;
  list-style: none;
  margin: 0 auto;
  padding: 0;
  align-items: center;
}
.nav-links li { display: flex; }
.nav-links a {
  color: white;
  text-decoration: none;
  font-size: 1.2em;
  padding: 7px 10px;
  border-radius: 4px;
  text-shadow: 0 0 8px #00ffcc, 0 0 6px #bb00ff;
  transition: 0.3s;
  font-family: inherit;
}
.nav-links a:hover {
  background-color: #00ffcc;
  color: #000;
  box-shadow: 0 0 10px #ffffff;
}

.logout-btn {
  position: fixed;
  top: 12px;
  right: 12px;
  background: #000;
  color: #00ffcc;
  border: 2px solid #00ffcc;
  padding: 8px 24px 7px 24px;
  font-size: 1.1em;
  border-radius: 9px;
  font-family: 'Courier New', monospace;
  font-weight: bold;
  box-shadow: 0 0 15px #00ffcc88, 0 0 8px #bb00ff99;
  transition: 0.18s;
  cursor: pointer;
  opacity: 0.98;
  margin: 0;
  z-index: 1500;
  display: block;
}

.hamburger {
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 60px;
  height: 55px;
  z-index: 2002;
  background: none;
  border: none;
  cursor: pointer;
}

.hamburger span {
  width: 32px;
  height: 4px;
  background: #00ffcc;
  margin: 5px 0;
  border-radius: 2px;
  transition: 0.3s;
  display: block;
}

/* Anpassa padding när skärm är mindre */
@media (max-width: 1100px) {
  nav.navbar {
    padding: 0 80px 0 0;
  }
}

/* När skärm är liten byter vi till hamburgermeny och döljer vanliga länkar och logout */
@media (max-width: 900px) {
  nav.navbar {
    padding: 0;
  }
  .nav-center, .logout-btn {
    display: none !important;
  }
  .hamburger {
    display: flex !important;
  }
}

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-24px) translateX(-50%); }
      to { opacity: 1; transform: translateY(0) translateX(-50%); }
    }

    .nav-mobile {
      display: none;
      flex-direction: column;
      align-items: center;
      position: absolute;
      top: 55px;
      left: 50%;
      transform: translateX(-50%);
      min-width: 220px;
      width: 92vw;
      max-width: 400px;
      background: #181f26;
      box-shadow: 0 4px 28px #00ffcc77;
      z-index: 1201;
      padding-bottom: 20px;
      border-radius: 0 0 16px 16px;
      animation: dropin 0.16s;
      text-align: center;
    }
    .nav-mobile.show { display: flex; }
    .nav-mobile a, .nav-mobile .logout-link-mobile {
      padding: 18px 0px;
      font-size: 1.15em;
      width: 100%;
      border-radius: 0;
      text-align: center;
      border-bottom: 1px solid #3fffd966;
      background: none;
      color: #00ffcc;
      font-weight: bold;
      border: none;
      box-shadow: none;
      display: block;
      margin: 0;
      font-family: inherit;
    }
    .nav-mobile .logout-link-mobile {
      cursor: pointer;
      background: none;
    }
    .nav-mobile a:last-child {
      margin-top: 8px;
      background: #000;
      color: #00ffcc;
      border-bottom: 1px solid #3fffd966;
      font-weight: bold;
    }
    .nav-mobile a:hover { background: #00ffcc; color: #000; }

    @media (max-width: 900px) {
      .nav-center, .logout-btn { display: none !important; }
      .hamburger { display: flex !important; }
      nav.navbar { min-height: 55px; border-bottom-width: 2px; }
    }
    @media (max-width: 600px) {
      nav.navbar { transition: top 0.3s; }
      nav.navbar.hide-navbar { top: -70px; }
      .nav-mobile { min-width: 160px; width: 98vw; }
    }

    /* Upload box styling */
    .upload-box {
      border: 2px solid #66ffcc;
      border-radius: 12px;
      padding: 30px 20px 22px 20px;
      margin: 36px auto 32px auto;
      max-width: 440px;
      background-color: rgba(0, 0, 0, 0.88);
      box-shadow: 0 0 15px #00ffcc33;
      position: relative;
      z-index: 2;
      min-width: 0;
      width: 100%;
    }
    @media (max-width: 700px) {
      .upload-box {
        padding: 12px 2vw 10px 2vw;
        max-width: 99vw;
      }
    }
    .upload-title {
      font-size: 2.6em;
      text-align: center;
      color: #f5f5f5;
      margin: 16px 0 28px 0;
      text-shadow: 0 2px 12px #222, 0 1px 0 #fff;
      font-weight: bold;
      letter-spacing: 0.04em;
    }
    .upload-switcher {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 22px;
      flex-wrap: wrap;
      width: 100%;
      min-width: 0;
      align-items: center;
      transition: none;
    }
    .switch-btn {
      background: #111;
      color: #80ffcc;
      border: 1px solid #66ffcc;
      border-radius: 5px;
      padding: 6px 14px;
      font-size: 1em;
      cursor: pointer;
      transition: 0.18s;
      font-family: 'Courier New', monospace;
      min-width: 110px;
      margin: 0;
    }
    .switch-btn.active,
    .switch-btn:hover {
      background: #00ffcc;
      color: #000;
      font-weight: bold;
      box-shadow: 0 0 8px #00ffcc;
    }

    .upload-box form {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      width: 100%;
    }

    .upload-box textarea,
    .upload-box input[type="file"],
    .upload-box button[type="submit"],
    .upload-box label {
      display: block;
      width: 100%;
      max-width: 390px;
      margin-left: auto;
      margin-right: auto;
      margin-top: 1rem;
      font-family: inherit;
      font-size: 1rem;
      color: #b8f6ff;
      background-color: #111;
      border: 1px solid #66ffcc;
      padding: 0.6rem;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .upload-box label { margin-bottom: -0.7rem; }
    .upload-box button[type="submit"] {
      background-color: #00ffcc;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      display: block;
      margin-top: 1.3rem;
    }
    .upload-box button[type="submit"]:hover {
      background-color: #00ccaa;
    }
    #spinner {
      display: none;
      width: 50px;
      margin: 10px auto;
    }
    audio { margin-top: 10px; }
    .upload-section { display: none; }
    .upload-section.active { display: block; }
    .desc-label, .desc-field { display: none; }
    .show-desc .desc-label, .show-desc .desc-field { display: block; }
  </style>
</head>
<body>
  <div class="glow-left"></div>
  <div class="glow-right"></div>
  <div class="side-banner left">
    <div class="banner-inner">
      <a id="leftBannerLink" href="#" target="_blank">
        <img id="leftBannerImg" src="https://dummyimage.com/150x1800/7b00ff/fff&text=Reklam+1" alt="Reklam" />
      </a>
    </div>
  </div>
  <div class="side-banner right">
    <div class="banner-inner">
      <a id="rightBannerLink" href="#" target="_blank">
        <img id="rightBannerImg" src="https://dummyimage.com/150x1800/222299/fff&text=Reklam+2" alt="Reklam" />
      </a>
    </div>
  </div>
  <nav class="navbar">
    <div class="hamburger" id="hamburgerBtn" aria-label="Meny" tabindex="0">
      <span></span><span></span><span></span>
    </div>
    <div class="nav-center">
      <ul class="nav-links">
        <li><a href="forum.html">Forum</a></li>
        <li><a href="wall.html">Väggen</a></li>
        <li><a href="upload.html">Ladda upp</a></li>
        <li><a href="profile.html">Profil</a></li>
        <li><a href="friends.html">Vänner</a></li>
        <li><a href="ghostglow.html">Ghost&Glow</a></li>
        <li><a href="store.html">Butik</a></li>
      </ul>
    </div>
    <button class="logout-btn" id="logoutDesktopBtn">Logga ut</button>
    <div class="nav-mobile" id="navMobile">
      <a href="forum.html">Forum</a>
      <a href="wall.html">Väggen</a>
      <a href="upload.html">Ladda upp</a>
      <a href="profile.html">Profil</a>
      <a href="friends.html">Vänner</a>
      <a href="ghostglow.html">Ghost&Glow</a>
      <a href="store.html">Butik</a>
      <a href="#" class="logout-link-mobile" id="logoutMobileBtn">Logga ut</a>
    </div>
  </nav>
  <div class="upload-box" id="uploadBox">
    <div class="upload-title">Ladda upp innehåll</div>
    <div class="upload-switcher">
      <button class="switch-btn active" data-section="text">📝 Inlägg</button>
      <button class="switch-btn" data-section="image">🖼️ Bild</button>
      <button class="switch-btn" data-section="video">🎬 Klipp</button>
      <button class="switch-btn" data-section="audio">🎵 Ljud</button>
      <button class="switch-btn" data-section="mic">🎤 Röst</button>
    </div>
    <img id="spinner" src="spinner-asg.png" alt="Laddar..." onerror="this.style.display='none'" />
    <form id="uploadForm">
      <div class="upload-section active" data-section="text">
        <label id="textLabel_sv" for="text_sv">Skriv ett inlägg (svenska):</label>
        <textarea id="text_sv" placeholder="Skriv på svenska..." maxlength="1500"></textarea>
        <label id="textLabel_en" for="text_en" style="display:none;">Write a post (English):</label>
        <textarea id="text_en" placeholder="Write in English..." maxlength="1500" style="display:none;"></textarea>
      </div>
      <div class="upload-section" data-section="image">
        <label for="image">Ladda upp en bild (max 5 MB):</label>
        <input type="file" id="image" accept="image/*" />
      </div>
      <div class="upload-section" data-section="video">
        <label for="video">Ladda upp ett klipp (max 30 MB):</label>
        <input type="file" id="video" accept="video/mp4,video/webm,video/ogg" />
      </div>
      <div class="upload-section" data-section="audio">
        <label for="audio">Ladda upp ljudfil (max 5 MB):</label>
        <input type="file" id="audio" accept="audio/*" />
      </div>
      <div class="upload-section" data-section="mic">
        <label>Mikrofoninspelning (max 2 MB):</label>
        <button type="button" id="recordButton">🎤 Starta inspelning</button>
        <button type="button" id="stopButton" disabled>🛑 Stoppa</button>
        <audio id="audioPreview" controls></audio>
      </div>
      <label style="margin-top:18px;">
        <input type="checkbox" id="temporary" />
        <span id="tmp_sv">Gör detta till ett tillfälligt inlägg (försvinner om 24h)</span>
        <span id="tmp_en" style="display:none;">Make this a temporary post (disappears in 24h)</span>
      </label>
      <button type="submit" id="submitBtn">Ladda upp</button>
    </form>
  </div>

  <script>
    // SÄKER DOM-UPPDATERARE
    function safeSet(selector, prop, val) {
      var el = document.querySelector(selector);
      if (el) el[prop] = val;
    }
    function safeSetHTML(selector, html) {
      var el = document.querySelector(selector);
      if (el) el.innerHTML = html;
    }

    function setLanguage() {
      const lang = (localStorage.lang || localStorage.language || "sv");
      const navLinks = document.querySelectorAll('.nav-links a');
      const navMobileLinks = document.querySelectorAll('#navMobile a:not(.logout-link-mobile)');
      if (lang === 'en') {
        const texts = ['Forum', 'Wall', 'Upload', 'Profile', 'Friends', 'Ghost&Glow', 'Store'];
        navLinks.forEach((a,i) => a.textContent = texts[i]);
        navMobileLinks.forEach((a,i) => a.textContent = texts[i]);
        safeSet('#logoutDesktopBtn', 'textContent', 'Log out');
        safeSet('#logoutMobileBtn', 'textContent', 'Log out');
        safeSet('.upload-title', 'textContent', 'Upload content');
        safeSet('.switch-btn[data-section="text"]', 'textContent', '📝 Post');
        safeSet('.switch-btn[data-section="image"]', 'textContent', '🖼️ Image');
        safeSet('.switch-btn[data-section="video"]', 'textContent', '🎬 Clip');
        safeSet('.switch-btn[data-section="audio"]', 'textContent', '🎵 Audio');
        safeSet('.switch-btn[data-section="mic"]', 'textContent', '🎤 Voice');
        safeSet('#text_sv', 'style.display', 'none');
        safeSet('#text_en', 'style.display', 'block');
        safeSet('#textLabel_sv', 'style.display', 'none');
        safeSet('#textLabel_en', 'style.display', 'block');
        safeSet('#text_en', 'placeholder', 'Write in English...');
        safeSet('#desc_sv', 'style.display', 'none');
        safeSet('#desc_en', 'style.display', 'block');
        safeSet('.desc-label.sv', 'style.display', 'none');
        safeSet('.desc-label.en', 'style.display', 'block');
        safeSet('#desc_en', 'placeholder', 'Describe in English...');
        safeSet('label[for="image"]', 'textContent', 'Upload an image (max 5 MB):');
        safeSet('label[for="video"]', 'textContent', 'Upload a clip (max 30 MB):');
        safeSet('label[for="audio"]', 'textContent', 'Upload an audio file (max 5 MB):');
        safeSet('.upload-section[data-section="mic"] label', 'textContent', 'Microphone recording (max 2 MB):');
        safeSetHTML('label[for="temporary"]', `<input type="checkbox" id="temporary" /> Make this a temporary post (disappears in 24h)`);
        safeSet('button[type="submit"]', 'textContent', 'Upload');
      } else {
        const texts = ['Forum', 'Väggen', 'Ladda upp', 'Profil', 'Vänner', 'Ghost&Glow', 'Butik'];
        navLinks.forEach((a,i) => a.textContent = texts[i]);
        navMobileLinks.forEach((a,i) => a.textContent = texts[i]);
        safeSet('#logoutDesktopBtn', 'textContent', 'Logga ut');
        safeSet('#logoutMobileBtn', 'textContent', 'Logga ut');
        safeSet('.upload-title', 'textContent', 'Ladda upp innehåll');
        safeSet('.switch-btn[data-section="text"]', 'textContent', '📝 Inlägg');
        safeSet('.switch-btn[data-section="image"]', 'textContent', '🖼️ Bild');
        safeSet('.switch-btn[data-section="video"]', 'textContent', '🎬 Klipp');
        safeSet('.switch-btn[data-section="audio"]', 'textContent', '🎵 Ljud');
        safeSet('.switch-btn[data-section="mic"]', 'textContent', '🎤 Röst');
        safeSet('#text_sv', 'style.display', 'block');
        safeSet('#text_en', 'style.display', 'none');
        safeSet('#textLabel_sv', 'style.display', 'block');
        safeSet('#textLabel_en', 'style.display', 'none');
        safeSet('#text_sv', 'placeholder', 'Skriv på svenska...');
        safeSet('#desc_sv', 'style.display', 'block');
        safeSet('#desc_en', 'style.display', 'none');
        safeSet('.desc-label.sv', 'style.display', 'block');
        safeSet('.desc-label.en', 'style.display', 'none');
        safeSet('#desc_sv', 'placeholder', 'Beskriv på svenska...');
        safeSet('label[for="image"]', 'textContent', 'Ladda upp en bild (max 5 MB):');
        safeSet('label[for="video"]', 'textContent', 'Ladda upp ett klipp (max 30 MB):');
        safeSet('label[for="audio"]', 'textContent', 'Ladda upp ljudfil (max 5 MB):');
        safeSet('.upload-section[data-section="mic"] label', 'textContent', 'Mikrofoninspelning (max 2 MB):');
        safeSetHTML('label[for="temporary"]', `<input type="checkbox" id="temporary" /> Gör detta till ett tillfälligt inlägg (försvinner om 24h)`);
        safeSet('button[type="submit"]', 'textContent', 'Ladda upp');
      }
      document.body.classList.add('ready');
    }

    function updateMenuMode() {
      const hamburgerBtn = document.getElementById('hamburgerBtn');
      const navCenter = document.querySelector('.nav-center');
      const logoutBtn = document.getElementById('logoutDesktopBtn');
      const navMobile = document.getElementById('navMobile');
      if (window.innerWidth <= 900) {
        hamburgerBtn.style.display = "flex";
        navCenter.style.display = "none";
        logoutBtn.style.display = "none";
        navMobile.classList.remove('show');
      } else {
        hamburgerBtn.style.display = "none";
        navCenter.style.display = "flex";
        logoutBtn.style.display = "block";
        navMobile.classList.remove('show');
      }
    }

    document.addEventListener("DOMContentLoaded", function() {
      updateMenuMode();
      setLanguage();

      // Hamburgermenyn togglas
      const hamburgerBtn = document.getElementById('hamburgerBtn');
      const navMobile = document.getElementById('navMobile');
      hamburgerBtn.onclick = function() {
        navMobile.classList.toggle('show');
      };

      // Logga ut-knappar
      document.getElementById("logoutMobileBtn").onclick = function(e) {
        e.preventDefault();
        navMobile.classList.remove('show');
        doLogout();
      };
      document.getElementById("logoutDesktopBtn").onclick = doLogout;
    });

    window.addEventListener("resize", updateMenuMode);

    // Banner-rotation (vänster och höger)
    const banners = [
      {
        left: { src: "https://dummyimage.com/150x1800/7b00ff/fff&text=Reklam+1", alt: "Reklam Banner 1", url: "#" },
        right: { src: "https://dummyimage.com/150x1800/222299/fff&text=Reklam+2", alt: "Reklam Banner 2", url: "#" }
      },
      {
        left: { src: "https://dummyimage.com/150x1800/ff0088/fff&text=Bli+medlem!", alt: "Bli medlem", url: "register.html" },
        right: { src: "https://dummyimage.com/150x1800/0077ff/fff&text=Annonsera+Här", alt: "Annonsera", url: "#" }
      }
    ];
    let bannerIndex = 0;
    function updateBanners() {
      const left = banners[bannerIndex].left;
      const right = banners[bannerIndex].right;
      document.getElementById('leftBannerImg').src = left.src;
      document.getElementById('leftBannerImg').alt = left.alt;
      document.getElementById('leftBannerLink').href = left.url;
      document.getElementById('rightBannerImg').src = right.src;
      document.getElementById('rightBannerImg').alt = right.alt;
      document.getElementById('rightBannerLink').href = right.url;
    }
    updateBanners();
    setInterval(() => {
      bannerIndex = (bannerIndex + 1) % banners.length;
      updateBanners();
    }, 6000);

    // Visa beskrivning bara för allt utom inlägg
    document.querySelectorAll('.switch-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        document.querySelectorAll('.switch-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const section = this.getAttribute('data-section');
        document.querySelectorAll('.upload-section').forEach(sec => {
          sec.classList.remove('active');
          if (sec.getAttribute('data-section') === section) sec.classList.add('active');
        });
        let form = document.getElementById('uploadForm');
        if (section !== "text") {
          form.classList.add('show-desc');
        } else {
          form.classList.remove('show-desc');
        }
      });
    });
  </script>

  <!-- Firebase-upload script -->
  <script type="module">
    import { auth, db, storage } from "./scripts/firebase-init.js";
    import {
      collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import {
      ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    const MAX_IMAGE_SIZE = 5 * 1024 * 1024;
    const MAX_VIDEO_SIZE = 30 * 1024 * 1024;
    const MAX_AUDIO_SIZE = 5 * 1024 * 1024;
    const MAX_MIC_SIZE = 2 * 1024 * 1024;

    const uploadForm = document.getElementById("uploadForm");
    const spinner = document.getElementById("spinner");
    const uploadBox = document.getElementById("uploadBox");

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        uploadBox.innerHTML =
          `<div style="text-align:center;padding:36px 0;font-size:1.23em;color:#ff7788;">
            Du måste vara inloggad för att ladda upp innehåll.<br><br>
            <a href="login.html" style="color:#00ffcc;font-weight:bold;">Logga in här</a>
          </div>`;
      }
    });

    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!auth.currentUser) {
        alert("Du måste vara inloggad för att ladda upp.");
        return;
      }
      spinner.style.display = "block";
      const activeSection = document.querySelector('.switch-btn.active').getAttribute('data-section');
      let postData = {
        createdAt: serverTimestamp(),
        user: auth.currentUser.uid,
        type: activeSection,
        temporary: document.getElementById("temporary").checked,
      };
      let filesToUpload = [];

      if (activeSection === "text") {
        postData.text_sv = document.getElementById("text_sv").value || "";
        postData.text_en = document.getElementById("text_en").value || "";
      }
      if (["image", "video", "audio", "mic"].includes(activeSection)) {
        postData.desc_sv = document.getElementById("desc_sv")?.value || "";
        postData.desc_en = document.getElementById("desc_en")?.value || "";
      }

      if (activeSection === "image") {
        const img = document.getElementById("image").files[0];
        if (img && img.size > MAX_IMAGE_SIZE) {
          spinner.style.display = "none";
          return alert("Bilden är för stor! Maxstorlek: 5 MB.");
        }
        filesToUpload.push({ file: img, key: "imageUrl" });
      }
      if (activeSection === "video") {
        const vid = document.getElementById("video").files[0];
        if (vid && vid.size > MAX_VIDEO_SIZE) {
          spinner.style.display = "none";
          return alert("Videoklippet är för stort! Maxstorlek: 30 MB.");
        }
        filesToUpload.push({ file: vid, key: "videoUrl" });
      }
      if (activeSection === "audio") {
        const aud = document.getElementById("audio").files[0];
        if (aud && aud.size > MAX_AUDIO_SIZE) {
          spinner.style.display = "none";
          return alert("Ljudfilen är för stor! Maxstorlek: 5 MB.");
        }
        filesToUpload.push({ file: aud, key: "audioUrl" });
      }
      if (activeSection === "mic") {
        const micBlob = window.lastRecordedAudioBlob;
        if (micBlob && micBlob.size > MAX_MIC_SIZE) {
          spinner.style.display = "none";
          return alert("Röstinspelningen är för stor! Maxstorlek: 2 MB.");
        }
        if (micBlob) filesToUpload.push({ file: micBlob, key: "micAudioUrl" });
      }

      for (let upload of filesToUpload) {
        if (!upload.file) continue;
        const storageRef = ref(storage, `uploads/${Date.now()}_${upload.file.name || 'mic.wav'}`);
        await uploadBytes(storageRef, upload.file);
        const url = await getDownloadURL(storageRef);
        postData[upload.key] = url;
      }

      await addDoc(collection(db, "wall"), postData);

      spinner.style.display = "none";
      alert("✅ Inlägget har laddats upp!");
      uploadForm.reset();
      window.location.href = "wall.html";
    });

    // Röstinspelning
    let mediaRecorder, audioChunks = [];
    const recordBtn = document.getElementById("recordButton");
    const stopBtn = document.getElementById("stopButton");
    const audioPreview = document.getElementById("audioPreview");
    if (recordBtn && stopBtn && audioPreview) {
      recordBtn.onclick = async function () {
        audioChunks = [];
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        recordBtn.disabled = true;
        stopBtn.disabled = false;
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
          window.lastRecordedAudioBlob = audioBlob;
          audioPreview.src = URL.createObjectURL(audioBlob);
          recordBtn.disabled = false;
          stopBtn.disabled = true;
        };
      };
      stopBtn.onclick = function () {
        mediaRecorder && mediaRecorder.stop();
      };
    }

    // Logga ut-funktion
    function doLogout() {
      signOut(auth).then(() => {
        window.location.href = "login.html";
      });
    }
  </script>
</body>
</html>
