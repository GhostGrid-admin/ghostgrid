<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forum – GhostGrid</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      margin: 0;
      padding-top: 76px;
      background: #0a0a0a;
      color: #e0ffff;
      font-family: 'Courier New', monospace;
      min-height: 100vh;
    }
    nav.navbar {
      background: #000;
      width: 100vw;
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 2000;
      border-bottom: 4px solid #ad30fa;
      box-shadow: 0 0 20px #ad30fa;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 62px;
    }
    .nav-content {
      display: flex;
      gap: 34px;
      padding: 12px 0 10px 0;
      align-items: center;
      justify-content: center;
      width: 100%;
      transition: 0.18s;
    }
    .nav-content a {
      color: #e0ffff;
      text-decoration: none;
      font-size: 1.32em;
      font-family: monospace;
      padding: 5px 22px;
      border-radius: 7px;
      margin: 0 5px;
      background: transparent;
      transition: background 0.18s, color 0.18s, box-shadow 0.22s;
      text-shadow: 0 0 8px #ad30fa, 0 0 3px #fff;
    }
    .nav-content a:hover, .nav-content a.active {
      background: #ad30fa;
      color: #000;
      box-shadow: 0 0 16px #ad30fa, 0 0 5px #fff;
    }
    #menuBtn {
      display: none;
      background: none;
      border: none;
      color: #fff;
      font-size: 2.3em;
      position: absolute;
      right: 18px;
      top: 10px;
      cursor: pointer;
      z-index: 3000;
    }
    @media (max-width: 900px) {
      .nav-content {
        flex-direction: column;
        background: #170b1aee;
        position: absolute;
        left: 0; top: 60px;
        width: 100vw;
        gap: 14px;
        padding: 15px 0 10px 0;
        display: none;
        z-index: 2050;
        box-shadow: 0 8px 24px #ad30fa90;
      }
      .nav-content.active { display: flex; }
      #menuBtn { display: block; }
    }
    /* Reklambanners på SIDORNA */
    .side-ad {
      position: fixed;
      top: 76px;
      bottom: 0;
      width: 120px;
      z-index: 1300;
      background: #1a0033cc;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      border-radius: 0 0 30px 30px;
      overflow: hidden;
      box-shadow: 0 0 24px #7b00ff60;
    }
    .side-ad img {
      width: 110px;
      height: 90vh;
      object-fit: cover;
      border-radius: 0 0 24px 24px;
      background: #15002a;
    }
    .side-ad.left { left: 0; }
    .side-ad.right { right: 0; }
    @media (max-width: 1100px) {
      .side-ad { display: none !important; }
    }
    .forum-wrapper {
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      background: rgba(18,0,24,0.05);
      box-sizing: border-box;
      padding: 28px 15px 40px 15px;
    }
    .forum-title {
      font-size: 2.1em;
      text-align: center;
      color: #aaffee;
      margin: 12px 0 24px 0;
      text-shadow: 0 0 8px #ffffff;
      letter-spacing: 2px;
    }
    .search-bar {
      display: flex;
      justify-content: center;
      margin-bottom: 18px;
    }
    .search-bar input {
      padding: 8px;
      width: 72vw;
      max-width: 370px;
      border-radius: 6px;
      border: 1px solid #7b00ff;
      background-color: #1a1a1a;
      color: #fff;
      font-size: 1em;
      margin-top: 2px;
      margin-bottom: 2px;
      text-align: center;
    }
    .new-thread-form {
      margin: 30px 0 16px 0;
      padding: 17px 10px 12px 10px;
      border: 2px dashed #00ffcc;
      border-radius: 10px;
      background-color: rgba(255,255,255,0.025);
      max-width: 520px;
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
      overflow: hidden;
    }
    .new-thread-form input,
    .new-thread-form textarea {
      width: 94%;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #00ffcc;
      background-color: #111;
      color: #00ffcc;
      font-family: 'Courier New', monospace;
      box-sizing: border-box;
      padding: 10px;
    }
    .new-thread-form button {
      background-color: #00ffcc;
      color: #000;
      border: none;
      padding: 10px 20px;
      font-size: 1em;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 6px;
    }
    .forum-thread {
      margin: 32px auto 36px auto;
      border: 2px solid #bb00ff55;
      background: #13151a99;
      border-radius: 12px;
      padding: 18px 18px 12px 18px;
      box-shadow: 0 0 14px #bb00ff33;
      max-width: 650px;
      position: relative;
    }
    .thread-title {
      color: #ffb8ff;
      font-size: 1.35em;
      font-weight: bold;
      margin-bottom: 6px;
      letter-spacing: 1px;
      text-shadow: 0 0 8px #ad30fa, 0 0 2px #fff;
    }
    .thread-content {
      color: #e0ffff;
      font-size: 1.13em;
      margin-bottom: 5px;
      white-space: pre-line;
    }
    .reactions-bar {
      margin: 7px 0 5px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .reaction-btn {
      background: #181929;
      border: 1px solid #7b00ff;
      color: #fff;
      border-radius: 5px;
      padding: 4px 10px 4px 8px;
      font-size: 1.08em;
      margin-right: 2px;
      cursor: pointer;
      box-shadow: 0 0 4px #bb00ff44;
      transition: background 0.12s, color 0.12s, border 0.12s;
      outline: none;
      position: relative;
      min-width: 36px;
    }
    .reaction-btn.selected, .reaction-btn:focus {
      background: #ad30fa;
      color: #fff;
      border: 2px solid #00ffcc;
      box-shadow: 0 0 8px #ad30fa;
      z-index: 3;
    }
    .reaction-count {
      font-size: 0.98em;
      margin-left: 2px;
      color: #ffebfb;
      font-weight: bold;
    }
    /* Kommentarer */
    .comments-section {
      margin: 18px 0 6px 0;
      background: #20102944;
      border-radius: 10px;
      padding: 11px 12px 7px 14px;
    }
    .comment {
      border-left: 3px solid #00ffccaa;
      margin-bottom: 9px;
      padding-left: 11px;
      padding-bottom: 4px;
      color: #d4ffff;
      background: #25113722;
      border-radius: 7px;
      font-size: 1em;
      position: relative;
    }
    .comment-author {
      font-weight: bold;
      color: #ad30fa;
      font-size: 0.98em;
    }
    .comment-actions {
      margin-top: 2px;
      margin-bottom: 3px;
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 0.93em;
    }
    .edit-btn, .delete-btn {
      background: #1c1933;
      color: #ffb8ff;
      border: none;
      border-radius: 4px;
      padding: 3px 10px;
      font-size: 1em;
      cursor: pointer;
      margin-right: 3px;
    }
    .edit-btn:hover, .delete-btn:hover { background: #ad30fa; color: #fff; }
    .new-comment-form textarea {
      width: 98%;
      min-height: 36px;
      margin-bottom: 7px;
      border-radius: 6px;
      border: 1px solid #00ffcc;
      background-color: #191919;
      color: #00ffcc;
      font-family: 'Courier New', monospace;
      box-sizing: border-box;
      padding: 7px;
      font-size: 1em;
      resize: vertical;
    }
    .new-comment-form button {
      background-color: #00ffcc;
      color: #000;
      border: none;
      padding: 7px 18px;
      font-size: 1em;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    @media (max-width: 900px) {
      .side-ad { display: none !important; }
      .forum-wrapper { padding: 13px 2vw 20px 2vw; }
      .forum-title { font-size: 1.3em; }
    }
  </style>

  <!-- FIREBASE INIT -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCR8q40Dc4wcfYBDlxdpOriA2e3RTmAesg",
      authDomain: "ghostgrid-fb278.firebaseapp.com",
      projectId: "ghostgrid-fb278",
      storageBucket: "ghostgrid-fb278.firebasestorage.app",
      messagingSenderId: "283208202937",
      appId: "1:283208202937:web:11c0cea81fd81a31163968",
      measurementId: "G-B0WCKJCNT9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
  </script>
</head>
<body>
  <!-- SIDOREKLAM desktop -->
  <div class="side-ad left"><img src="https://dummyimage.com/110x1100/7b00ff/fff&text=Reklam+1" alt="Reklam vänster"></div>
  <div class="side-ad right"><img src="https://dummyimage.com/110x1100/00ffcc/222&text=Reklam+2" alt="Reklam höger"></div>

  <nav class="navbar">
    <button id="menuBtn" aria-label="Meny">&#9776;</button>
    <div class="nav-content" id="navLinks">
      <a href="forum.html">Forum</a>
      <a href="store.html">Store</a>
      <a href="wall.html">Väggen</a>
      <a href="upload.html">Ladda upp</a>
      <a href="profile.html">Profil</a>
      <a href="friends.html">Vänner</a>
      <div class="search-container">
        <input type="text" id="globalSearchInput" placeholder="Sök på hela sidan...">
      </div>
    </div>
  </nav>

  <div class="forum-wrapper">
    <h1 class="forum-title" id="forumTitle">Forum</h1>
    <div class="search-bar">
      <input type="text" id="threadSearchInput" placeholder="Sök trådar...">
    </div>
    <div class="new-thread-form" id="newThreadForm" style="display:none;">
      <h3 id="createThreadTitle">Skapa ny tråd</h3>
      <input type="text" id="newThreadTitle" placeholder="Titel">
      <textarea id="newThreadContent" rows="3" placeholder="Beskrivning..."></textarea>
      <button onclick="createNewThread()" id="addThreadBtn">Lägg upp tråd</button>
    </div>
    <div id="threadsContainer"></div>
  </div>
   <!-- Popup för bekräftelse vid radering -->
  <div id="deletePopup" class="popup-bg" style="display:none;">
    <div class="popup-dialog">
      <div id="deletePopupText" style="font-size:1.11em; margin-bottom:8px;"></div>
      <button id="popupYesBtn">Ja / Yes</button>
      <button id="popupNoBtn" class="no-btn">Nej / No</button>
    </div>
  </div>

  <style>
    .popup-bg {
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .popup-dialog {
      background: #18192a;
      color: #fff;
      border-radius: 14px;
      box-shadow: 0 0 24px #00ffcc66;
      padding: 34px 38px 26px 38px;
      min-width: 220px;
      text-align: center;
    }
    .popup-dialog button {
      margin: 22px 16px 0 16px;
      padding: 6px 20px;
      font-size: 1.07em;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 4px #00ffcc77;
      background: #00ffcc;
      color: #18192a;
      transition: background 0.16s, color 0.16s;
    }
    .popup-dialog .no-btn {
      background: #111;
      color: #ccc;
      box-shadow: none;
      border: 1px solid #aaa;
    }
  </style>

  <script>
    // ----------------- Hamburgermeny centrerad ----------------
    const menuBtn = document.getElementById("menuBtn");
    const navLinks = document.getElementById("navLinks");
    menuBtn.onclick = () => navLinks.classList.toggle("active");
    document.querySelectorAll('.nav-content a').forEach(a =>
      a.onclick = () => navLinks.classList.remove("active")
    );
    // ----------------------------------------------------------

    // ----- Språkstöd -----
    const translations = {
      sv: {
        forumTitle: "Forum",
        createThreadTitle: "Skapa ny tråd",
        newThreadPlaceholder: "Titel",
        newDescPlaceholder: "Beskrivning...",
        addThreadBtn: "Lägg upp tråd",
        deleteQuestion: "Vill du ta bort detta?",
        yes: "Ja",
        no: "Nej",
        edit: "Redigera",
        delete: "Ta bort",
        comment: "Kommentera",
        addComment: "Skicka kommentar",
        placeholderComment: "Skriv kommentar...",
        needLogin: "Du måste vara inloggad.",
        fillAllFields: "Fyll i alla fält!",
        maxComment: "Max 200 ord per kommentar.",
        onlyOwnEdit: "Du kan bara redigera eller ta bort dina egna kommentarer.",
        confirmDeleteComment: "Vill du ta bort denna kommentar?",
        confirmDeleteThread: "Vill du ta bort denna tråd?",
        edited: "(redigerad)",
        reactions: "Reagera",
        spamBlock: "Vänta 20 sekunder innan du postar igen.",
      },
      en: {
        forumTitle: "Forum",
        createThreadTitle: "Create New Thread",
        newThreadPlaceholder: "Title",
        newDescPlaceholder: "Description...",
        addThreadBtn: "Post Thread",
        deleteQuestion: "Do you want to delete this?",
        yes: "Yes",
        no: "No",
        edit: "Edit",
        delete: "Delete",
        comment: "Comment",
        addComment: "Post Comment",
        placeholderComment: "Write a comment...",
        needLogin: "You must be logged in.",
        fillAllFields: "Fill in all fields!",
        maxComment: "Max 200 words per comment.",
        onlyOwnEdit: "You can only edit or delete your own comments.",
        confirmDeleteComment: "Do you want to delete this comment?",
        confirmDeleteThread: "Do you want to delete this thread?",
        edited: "(edited)",
        reactions: "React",
        spamBlock: "Wait 20 seconds before posting again.",
      }
    };
    let lang = localStorage.language === "en" ? "en" : "sv";

    function t(key) { return translations[lang][key] || key; }
    function setLangUI() {
      document.getElementById("forumTitle").textContent = t("forumTitle");
      document.getElementById("createThreadTitle").textContent = t("createThreadTitle");
      document.getElementById("newThreadTitle").placeholder = t("newThreadPlaceholder");
      document.getElementById("newThreadContent").placeholder = t("newDescPlaceholder");
      document.getElementById("addThreadBtn").textContent = t("addThreadBtn");
    }
    setLangUI();
    window.addEventListener('storage', function(e){
      if(e.key === 'language') {
        lang = localStorage.language === "en" ? "en" : "sv";
        setLangUI();
        renderThreads();
      }
    });

    // --------------- Emoji REACTIONS ---------------
    const REACTIONS = [
      { emoji: "👍", key: "thumbsup" },
      { emoji: "👎", key: "thumbsdown" },
      { emoji: "🙂", key: "smile" },
      { emoji: "😃", key: "bigsmile" },
      { emoji: "😂", key: "laugh" },
      { emoji: "😕", key: "confused" },
      { emoji: "🙁", key: "sad" },
      { emoji: "😢", key: "cry" },
      { emoji: "😡", key: "angry" },
      { emoji: "😳", key: "embarrassed" },
      { emoji: "😇", key: "angel" }
    ];

    // --------- USER ---------
    let currentUser = null;
    let threadsCache = [];
    let canPost = true;
    auth.onAuthStateChanged(user => {
      currentUser = user;
      document.getElementById("newThreadForm").style.display = user ? "block" : "none";
      renderThreads();
    });

    // --------- THREADS ---------
    async function createNewThread() {
      if (!currentUser) return alert(t("needLogin"));
      const title = document.getElementById("newThreadTitle").value.trim();
      const content = document.getElementById("newThreadContent").value.trim();
      if (!title || !content) return alert(t("fillAllFields"));
      if (!canPost) return alert(t("spamBlock"));
      canPost = false; setTimeout(()=>canPost=true, 20000);

      try {
        await db.collection("forumThreads").add({
          title,
          content,
          creatorUid: currentUser.uid,
          creatorEmail: currentUser.email,
          created: new Date(),
          reactions: {},
        });
        document.getElementById("newThreadTitle").value = "";
        document.getElementById("newThreadContent").value = "";
        renderThreads();
      } catch (e) {
        alert("Error!");
      }
    }

    async function renderThreads() {
      const threadsContainer = document.getElementById("threadsContainer");
      threadsContainer.innerHTML = "";
      const snap = await db.collection("forumThreads").orderBy("created", "desc").get();
      threadsCache = snap.docs.map(d => ({...d.data(), id: d.id}));
      threadsCache.forEach(thread => {
        const div = document.createElement("div");
        div.className = "forum-thread";
        div.innerHTML = `
          <div class="thread-title">${thread.title}</div>
          <div class="thread-content">${thread.content}</div>
          <div class="reactions-bar">
            ${REACTIONS.map(r => {
              const userReaction = thread.reactions?.[currentUser?.uid];
              const counts = Object.values(thread.reactions||{}).filter(x=>x===r.key).length;
              return `<button class="reaction-btn${userReaction===r.key?" selected":""}" data-id="${thread.id}" data-reaction="${r.key}">${r.emoji}<span class="reaction-count">${counts||""}</span></button>`;
            }).join("")}
            ${currentUser && thread.creatorUid === currentUser.uid
              ? `<button class="delete-btn" data-id="${thread.id}" style="margin-left:8px">${t("delete")}</button>`
              : ""}
          </div>
          <div class="comments-section" id="comments-${thread.id}">
            <div id="comments-list-${thread.id}"></div>
            ${currentUser ? `
              <form class="new-comment-form" data-id="${thread.id}">
                <textarea maxlength="1000" placeholder="${t("placeholderComment")}" required></textarea>
                <button type="submit">${t("addComment")}</button>
              </form>
            ` : ""}
          </div>
        `;
        threadsContainer.appendChild(div);
        // Render kommentarer:
        renderComments(thread.id);
      });

      // --- Reaktioner på trådar ---
      document.querySelectorAll(".reaction-btn").forEach(btn => {
        btn.onclick = async function() {
          if (!currentUser) return alert(t("needLogin"));
          const id = this.getAttribute("data-id");
          const reaction = this.getAttribute("data-reaction");
          const ref = db.collection("forumThreads").doc(id);
          const snap = await ref.get();
          let reactions = snap.data().reactions || {};
          if (reactions[currentUser.uid] === reaction) {
            delete reactions[currentUser.uid];
          } else {
            reactions[currentUser.uid] = reaction;
          }
          await ref.update({ reactions });
          renderThreads();
        }
      });

      // --- Ta bort tråd ---
      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.onclick = async function() {
          if (!currentUser) return;
          const id = btn.getAttribute("data-id");
          if (confirm(t("confirmDeleteThread"))) {
            await db.collection("forumThreads").doc(id).delete();
            renderThreads();
          }
        }
      });

      // --- Lägg kommentar ---
      document.querySelectorAll(".new-comment-form").forEach(form => {
        form.onsubmit = async function(e) {
          e.preventDefault();
          if (!currentUser) return alert(t("needLogin"));
          const id = this.getAttribute("data-id");
          const textarea = this.querySelector("textarea");
          let text = textarea.value.trim();
          if (!text) return;
          if (text.split(/\s+/).length > 200) return alert(t("maxComment"));
          if (!canPost) return alert(t("spamBlock"));
          canPost = false; setTimeout(()=>canPost=true, 20000);

          await db.collection("forumThreads").doc(id)
            .collection("comments").add({
              text,
              authorUid: currentUser.uid,
              authorEmail: currentUser.email,
              created: new Date(),
              reactions: {},
              edited: false
            });
          textarea.value = "";
          renderComments(id);
        };
      });
    }

    // ---------- KOMMENTARER ----------
    async function renderComments(threadId) {
      const list = document.getElementById("comments-list-"+threadId);
      if (!list) return;
      list.innerHTML = "";
      const snap = await db.collection("forumThreads").doc(threadId)
        .collection("comments").orderBy("created","asc").get();
      snap.forEach(doc => {
        const comment = doc.data();
        const div = document.createElement("div");
        div.className = "comment";
        let userReaction = comment.reactions?.[currentUser?.uid];
        let counts = {};
        for(const r of Object.values(comment.reactions||{})) counts[r]=(counts[r]||0)+1;
        div.innerHTML = `
          <div>
            <span class="comment-author">${comment.authorEmail||"Anonym"}</span>
            ${comment.edited ? `<span style="color:#aaa;font-size:0.88em;margin-left:4px;">${t("edited")}</span>` : ""}
          </div>
          <div>${comment.text}</div>
          <div class="reactions-bar" style="margin-bottom:2px;">
            ${REACTIONS.map(r=>`
              <button class="reaction-btn${userReaction===r.key?" selected":""}" 
                data-thread="${threadId}" data-cid="${doc.id}" data-reaction="${r.key}">
                ${r.emoji}<span class="reaction-count">${counts[r.key]||""}</span>
              </button>
            `).join("")}
            ${currentUser && comment.authorUid === currentUser.uid
              ? `
              <button class="edit-btn" data-thread="${threadId}" data-cid="${doc.id}">${t("edit")}</button>
              <button class="delete-btn" data-thread="${threadId}" data-cid="${doc.id}">${t("delete")}</button>
              ` : ""}
          </div>
        `;
        list.appendChild(div);

        // Reaktioner på kommentar:
        div.querySelectorAll(".reaction-btn").forEach(btn => {
          btn.onclick = async function() {
            if (!currentUser) return alert(t("needLogin"));
            const thread = this.getAttribute("data-thread");
            const cid = this.getAttribute("data-cid");
            const reaction = this.getAttribute("data-reaction");
            const ref = db.collection("forumThreads").doc(thread).collection("comments").doc(cid);
            const snap = await ref.get();
            let reactions = snap.data().reactions || {};
            if (reactions[currentUser.uid] === reaction) {
              delete reactions[currentUser.uid];
            } else {
              reactions[currentUser.uid] = reaction;
            }
            await ref.update({ reactions });
            renderComments(thread);
          };
        });
        // Redigera kommentar
        div.querySelectorAll(".edit-btn").forEach(btn => {
          btn.onclick = async function() {
            if (!currentUser) return alert(t("needLogin"));
            const thread = btn.getAttribute("data-thread");
            const cid = btn.getAttribute("data-cid");
            const ref = db.collection("forumThreads").doc(thread).collection("comments").doc(cid);
            const snap = await ref.get();
            if (snap.data().authorUid !== currentUser.uid) return alert(t("onlyOwnEdit"));
            let newText = prompt("Redigera kommentar:", snap.data().text);
            if (newText && newText.trim().length > 0 && newText.split(/\s+/).length <= 200) {
              await ref.update({ text: newText.trim(), edited: true });
              renderComments(thread);
            }
          }
        });
        // Ta bort kommentar
        div.querySelectorAll(".delete-btn").forEach(btn => {
          btn.onclick = async function() {
            if (!currentUser) return alert(t("needLogin"));
            const thread = btn.getAttribute("data-thread");
            const cid = btn.getAttribute("data-cid");
            if (confirm(t("confirmDeleteComment"))) {
              await db.collection("forumThreads").doc(thread).collection("comments").doc(cid).delete();
              renderComments(thread);
            }
          }
        });
      });
    }

    // ----------- Sökning lokal på sidan (thread) -----------
    document.getElementById("threadSearchInput").addEventListener("input", function() {
      const val = this.value.toLowerCase();
      document.querySelectorAll('.forum-thread').forEach(thread => {
        const text = thread.innerText.toLowerCase();
        thread.style.display = (!val || text.includes(val)) ? "" : "none";
      });
    });

    // ----------- Global sökning (enter) -----------
    document.getElementById("globalSearchInput").addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        const query = this.value.trim();
        if (query) {
          window.location.href = "search.html?q=" + encodeURIComponent(query);
        }
      }
    });

  </script>
</body>
</html>
