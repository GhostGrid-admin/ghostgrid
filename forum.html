<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forum ‚Äì GhostGrid</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    html { overflow-y: scroll; }
    body { background: #0a0a0a; color: #e0ffff; font-family: 'Courier New', monospace; min-height: 100vh; margin: 0; padding-top: 85px; position: relative; overflow-x: hidden;}
    .glow-left, .glow-right { position: fixed; top: 0; width: 170px; height: 100vh; pointer-events: none; z-index: 0; }
    .glow-left { left: 0; background: radial-gradient(circle at left, #d900ff 0%, #7200ffcc 40%, transparent 85%); box-shadow: 0 0 80px 40px #d900ffbb, 0 0 240px 80px #00ffe0aa, 0 0 400px 120px #9400ff66; }
    .glow-right { right: 0; background: radial-gradient(circle at right, #d900ff 0%, #7200ffcc 40%, transparent 85%); box-shadow: 0 0 80px 40px #d900ffbb, 0 0 240px 80px #00ffe0aa, 0 0 400px 120px #9400ff66; }
    .side-banner { position: fixed; top: 87px; bottom: 0; width: 170px; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; z-index: 1002; background: none; pointer-events: none; }
    .side-banner .banner-inner { width: 150px; height: 100%; background: transparent; border-radius: 12px; box-shadow: 0 0 18px #7b00ff99; overflow: hidden; display: flex; flex-direction: column; align-items: center; pointer-events: auto; }
    .side-banner img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; background: #220043; cursor: pointer; transition: box-shadow 0.3s; box-shadow: 0 0 10px #8800ff70; pointer-events: auto; min-height: 200px; }
    .side-banner.left { left: 0; } .side-banner.right { right: 0; }
    @media (max-width: 1100px) { .side-banner, .glow-left, .glow-right { width: 85px; } .side-banner .banner-inner { width: 75px; } }
    @media (max-width: 700px) { .side-banner, .glow-left, .glow-right { display: none; } }
    nav.navbar { background: #000; border-bottom: 2px solid #00ffcc; padding: 0; position: fixed; width: 100%; top: 0; left: 0; z-index: 1000; box-shadow: 0 0 20px #bb00ff; display: flex; align-items: center; justify-content: center; min-height: 60px; transition: top 0.3s, border-bottom 0.3s; }
    .nav-center { flex: 1; display: flex; justify-content: center; align-items: center; }
    .nav-links { display: flex; gap: 26px; list-style: none; margin: 0 auto; padding: 0; align-items: center; }
    .nav-links li { display: flex; }
    .nav-links a { color: white; text-decoration: none; font-size: 1.2em; padding: 7px 10px; border-radius: 4px; text-shadow: 0 0 8px #00ffcc, 0 0 6px #bb00ff; transition: 0.3s; font-family: inherit; }
    .nav-links a.active, .nav-links a:hover { background-color: #00ffcc; color: #000; box-shadow: 0 0 10px #ffffff; }
    .logout-btn { position: fixed; top: 12px; right: 12px; background: #000; color: #00ffcc; border: 2px solid #00ffcc; padding: 8px 24px 7px 24px; font-size: 1.1em; border-radius: 9px; font-family: 'Courier New', monospace; font-weight: bold; box-shadow: 0 0 15px #00ffcc88, 0 0 8px #bb00ff99; transition: 0.18s; cursor: pointer; opacity: 0.98; margin: 0; z-index: 1500; display: block;}
    .hamburger { display: none; flex-direction: column; justify-content: center; align-items: center; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 60px; height: 55px; z-index: 2002; background: none; border: none; cursor: pointer;}
    .hamburger span { width: 32px; height: 4px; background: #00ffcc; margin: 5px 0; border-radius: 2px; transition: 0.3s; display: block; }
    @media (max-width: 900px) { .nav-center, .logout-btn { display: none !important; } .hamburger { display: flex !important; } nav.navbar { min-height: 55px; border-bottom-width: 2px;}}
    .nav-mobile { display: none; flex-direction: column; align-items: center; position: absolute; top: 55px; left: 50%; transform: translateX(-50%); min-width: 220px; width: 92vw; max-width: 400px; background: #181f26; box-shadow: 0 4px 28px #00ffcc77; z-index: 1201; padding-bottom: 20px; border-radius: 0 0 16px 16px; animation: dropin 0.16s; text-align: center; }
    .nav-mobile.show { display: flex; }
    .nav-mobile a, .nav-mobile .logout-link-mobile { padding: 18px 0px; font-size: 1.15em; width: 100%; border-radius: 0; text-align: center; border-bottom: 1px solid #3fffd966; background: none; color: #00ffcc; font-weight: bold; border: none; box-shadow: none; display: block; margin: 0; font-family: inherit; }
    .nav-mobile .logout-link-mobile { cursor: pointer; background: none; }
    .nav-mobile a.active, .nav-mobile a:hover { background: #00ffcc; color: #000; }
    .nav-mobile a:last-child { margin-top: 8px; background: #000; color: #00ffcc; border-bottom: 1px solid #3fffd966; font-weight: bold; }
    @media (max-width: 950px) { .nav-links { gap: 14px; } }
    @media (max-width: 900px) { .nav-center, .logout-btn { display: none !important; } .hamburger { display: flex !important; } }
    @media (max-width: 600px) { nav.navbar { transition: top 0.3s, border-bottom 0.3s;} nav.navbar.hide-navbar { top: -70px; border-bottom: 0 !important; } .nav-mobile { min-width: 160px; width: 98vw; } }
    .forum-box { border: 2px solid #66ffcc; border-radius: 12px; padding: 30px 20px 22px 20px; margin: 36px auto 32px auto; max-width: 650px; background-color: rgba(0, 0, 0, 0.88); box-shadow: 0 0 15px #00ffcc33; position: relative; z-index: 2;}
    .forum-title { font-size: 2.4em; text-align: center; color: #f5f5f5; margin: 16px 0 28px 0; text-shadow: 0 2px 12px #222, 0 1px 0 #fff; font-weight: bold; letter-spacing: 0.04em; }
    .thread-form { display: flex; flex-direction: column; gap: 9px; margin-bottom: 36px; }
    .thread-form input, .thread-form textarea { width: 100%; padding: 10px; font-size: 1.1em; border-radius: 6px; border: 1.5px solid #00ffcc; background: #181f26; color: #baffff; box-sizing: border-box;}
    .thread-form button { background: #00ffcc; color: #181f26; border: none; font-weight: bold; padding: 9px 0; border-radius: 7px; font-size: 1.13em; box-shadow: 0 0 8px #00ffcc99; cursor: pointer; margin-top: 3px; }
    .thread-list { margin-top: 12px; }
    .thread { border: 1.5px solid #00ffcc; border-radius: 9px; margin-bottom: 24px; background: #181f26; box-shadow: 0 0 9px #00ffcc22; }
    .thread-header { padding: 16px 18px 6px 18px; font-size: 1.32em; font-weight: bold; color: #00ffd9; display: flex; justify-content: space-between; align-items: center;}
    .thread-desc { font-size: 1.11em; color: #e0ffff; padding: 0 18px 8px 18px;}
    .thread-content { padding: 10px 18px 18px 18px; }
    .add-post-form textarea { width: 100%; padding: 7px; border-radius: 6px; background: #181f26; color: #fff; border: 1.5px solid #66ffcc; margin-bottom: 6px;}
    .add-post-form button { background: #00ffcc; color: #000; border-radius: 5px; font-weight: bold; border: none; padding: 7px 16px; box-shadow: 0 0 5px #00ffcc80; cursor: pointer;}
    .post { background: #13181f; border: 1.5px solid #66ffcc; border-radius: 9px; margin: 17px 0; padding: 12px 8px 8px 8px; }
    .post-header { font-size: 1em; color: #00ffd9; margin-bottom: 6px;}
    .post-content { font-size: 1.19em;}
    .emoji-row { margin: 7px 0 3px 0; display: flex; flex-wrap: wrap; gap: 7px; align-items: center;}
    .emoji-trigger-btn {
      border: none; background: #13181f; color: #0ff; border-radius: 10px; font-size: 1.38em;
      display: flex; align-items: center; gap: 4px; padding: 4px 13px 4px 10px; box-shadow: 0 0 11px #00ffd977;
      cursor: pointer; font-weight: bold; margin-right: 8px; border: 2px solid #00ffd9;
      transition: box-shadow 0.13s;
    }
    .emoji-trigger-btn .arrow { font-size: 0.92em; margin-left: 2px; }
    .emoji-trigger-btn:disabled { filter: grayscale(1); opacity: 0.38; cursor: default; }
    .emoji-panel {
      display: none; position: absolute; left: 0; top: 43px; z-index: 99;
      background: #181f26; box-shadow: 0 8px 28px #00ffd988, 0 2px 12px #7b00ff99;
      border: 2px solid #00ffd9; border-radius: 14px; padding: 9px 12px;
      gap: 11px; flex-direction: row; align-items: center;
      animation: fadein 0.13s;
    }
    @media (max-width: 700px) {
      .emoji-panel { flex-direction: column; left: -7px; top: 45px; padding: 8px 3px; }
    }
    .emoji-btn {
      background: none; border: none; font-size: 1.4em; cursor: pointer; position: relative;
      border-radius: 6px; padding: 4px 6px; margin: 0 1px;
      transition: filter 0.1s, background 0.1s;
    }
    .emoji-btn.selected, .emoji-btn:hover { filter: brightness(1.25) drop-shadow(0 0 7px #00ffcc); background: #21293b; }
    .emoji-count-btn {
      background: none; border: none; font-size: 1.01em; color: #00ffd9; font-weight: bold;
      margin-left: 2px; margin-right: 5px; padding: 1px 7px; border-radius: 8px;
      border: 1.5px solid #00ffd9; cursor: pointer; display: inline-flex; align-items: center; position: relative; z-index: 2;
    }
    .reaction-popup {
      display: none;
      position: absolute;
      left: 50%; transform: translateX(-50%);
      top: 110%;
      background: #181f26;
      border: 2px solid #00ffd9;
      border-radius: 10px;
      box-shadow: 0 8px 28px #00ffd988, 0 2px 12px #7b00ff88;
      padding: 12px 24px 10px 24px;
      min-width: 180px;
      max-width: 90vw;
      color: #fff;
      font-size: 1.07em;
      text-align: center;
      z-index: 200;
      animation: fadein 0.14s;
    }
    .emoji-count-btn:hover .reaction-popup,
    .emoji-count-btn:focus .reaction-popup,
    .emoji-count-btn.show .reaction-popup {
      display: block;
    }
    @keyframes fadein { from { opacity: 0; } to { opacity: 1; } }
    .thread { position: relative; }
  </style>
</head>
<body>
  <div class="glow-left"></div>
  <div class="glow-right"></div>
  <div class="side-banner left">
    <div class="banner-inner">
      <a id="leftBannerLink" href="#" target="_blank">
        <img id="leftBannerImg" src="https://dummyimage.com/150x1800/7b00ff/fff&text=Reklam+1" alt="Reklam" />
      </a>
    </div>
  </div>
  <div class="side-banner right">
    <div class="banner-inner">
      <a id="rightBannerLink" href="#" target="_blank">
        <img id="rightBannerImg" src="https://dummyimage.com/150x1800/222299/fff&text=Reklam+2" alt="Reklam" />
      </a>
    </div>
  </div>
  <!-- NAVBAR START -->
  <nav class="navbar">
    <div class="hamburger" id="hamburgerBtn" aria-label="Meny" tabindex="0">
      <span></span><span></span><span></span>
    </div>
    <div class="nav-center">
      <ul class="nav-links">
        <li><a href="forum.html" data-i18n="forum" class="active">Forum</a></li>
        <li><a href="wall.html" data-i18n="wall">V√§ggen</a></li>
        <li><a href="upload.html" data-i18n="upload">Ladda upp</a></li>
        <li><a href="profile.html" data-i18n="profile">Profil</a></li>
        <li><a href="friends.html" data-i18n="friends">V√§nner</a></li>
        <li><a href="ghost&glow.html" data-i18n="ghostglow">Ghost&Glow</a></li>
        <li><a href="store.html" data-i18n="store">Butik</a></li>
      </ul>
    </div>
    <button class="logout-btn" id="logoutDesktopBtn">Logga ut</button>
    <div class="nav-mobile" id="navMobile">
      <a href="forum.html" data-i18n="forum" class="active">Forum</a>
      <a href="wall.html" data-i18n="wall">V√§ggen</a>
      <a href="upload.html" data-i18n="upload">Ladda upp</a>
      <a href="profile.html" data-i18n="profile">Profil</a>
      <a href="friends.html" data-i18n="friends">V√§nner</a>
      <a href="ghost&glow.html" data-i18n="ghostglow">Ghost&Glow</a>
      <a href="store.html" data-i18n="store">Butik</a>
      <a href="#" class="logout-link-mobile" id="logoutMobileBtn">Logga ut</a>
    </div>
  </nav>
  <!-- NAVBAR END -->
  <div class="forum-box">
    <div class="forum-title" data-i18n="forum_title">Forum</div>
    <div class="search-bar">
      <input type="text" id="threadSearch" placeholder="S√∂k bland tr√•dar..." />
      <button id="clearSearch" type="button">‚úñ</button>
    </div>
    <form class="thread-form" id="threadForm">
      <input type="text" id="threadTitle" placeholder="Titel p√• tr√•d..." maxlength="60" required>
      <textarea id="threadDesc" placeholder="Beskrivning..." rows="4" maxlength="2000" required></textarea>
      <button type="submit" id="addThreadBtn">Skapa ny tr√•d</button>
    </form>
    <div id="threadList" class="thread-list"></div>
  </div>
  <script type="module">
    import { auth, db } from "./scripts/firebase-init.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { collection, query, orderBy, getDocs, addDoc, doc, setDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    // Hj√§rtan f√∂rst, krossat hj√§rta sist
    const emojis = [
      { emoji: "‚ù§Ô∏è", key: "heart" },
      { emoji: "üëç", key: "thumbsup" },
      { emoji: "üòÇ", key: "laugh" },
      { emoji: "üòÉ", key: "bigsmile" },
      { emoji: "üôÇ", key: "smile" },
      { emoji: "üòá", key: "angel" },
      { emoji: "üò≥", key: "embarrassed" },
      { emoji: "üòï", key: "confused" },
      { emoji: "üôÅ", key: "sad" },
      { emoji: "üò¢", key: "cry" },
      { emoji: "üò°", key: "angry" },
      { emoji: "üëé", key: "thumbsdown" },
      { emoji: "üíî", key: "brokenheart" }
    ];

    let currentUser = null;
    let userMap = {};
    let threadsGlobal = [];

    // H√§mta anv√§ndare (live f√∂r att byta namn √§ndras √∂verallt)
    async function fetchUsers() {
      userMap = {};
      const snap = await getDocs(collection(db, "profiles"));
      snap.docs.forEach(docu => userMap[docu.id] = docu.data().nickname || docu.data().displayName || "G√§st");
    }

    // Ladda tr√•dar
    async function loadThreads(searchTerm = "") {
      await fetchUsers();
      const q = query(collection(db, "forumThreads"), orderBy("createdAt", "desc"));
      const threadsSnap = await getDocs(q);
      const threads = threadsSnap.docs.map(docu => ({ id: docu.id, ...docu.data() }));
      threadsGlobal = threads;
      let filtered = threads;
      if (searchTerm.trim()) {
        const q = searchTerm.toLowerCase();
        filtered = threads.filter(thread =>
          (thread.title && thread.title.toLowerCase().includes(q)) ||
          (thread.description && thread.description.toLowerCase().includes(q))
        );
      }
      document.getElementById("threadList").innerHTML = filtered.map(thread => renderThreadListItem(thread)).join("");
      addThreadListeners(filtered);
    }

    // Rendera tr√•dlistan
    function renderThreadListItem(thread) {
      const name = userMap[thread.creatorUid] || "G√§st";
      return `
        <div class="thread" data-threadid="${thread.id}">
          <div class="thread-header" style="align-items:center;">
            <span>${escapeHTML(thread.title)}</span>
            <span style="margin-left:12px;font-size:0.9em;">
              <a href="profile-view.html?uid=${thread.creatorUid}" class="profile-link" style="color:#00ffd9;text-decoration:underline;">
                ${name}
              </a>
            </span>
            ${(currentUser && thread.creatorUid === currentUser.uid)
              ? `<button class="thread-delete-btn" data-threadid="${thread.id}" title="Radera tr√•d">‚úñ</button>`
              : ""}
          </div>
          <div class="thread-desc">${escapeHTML(thread.description)}</div>
          <div class="emoji-row" id="threadReactions-${thread.id}" style="margin-top:10px;margin-bottom:4px;position:relative;"></div>
          <div class="thread-content" id="threadContent-${thread.id}"></div>
          ${currentUser ? `
            <form class="add-post-form" data-threadid="${thread.id}">
              <textarea id="postDesc-${thread.id}" rows="4" maxlength="2000"></textarea>
              <button type="submit">L√§gg till inl√§gg</button>
            </form>
          ` : `
            <div style="padding:7px 0 0 0;color:#aaa;font-size:0.96em;text-align:center;">Logga in f√∂r att kommentera.</div>
          `}
        </div>
      `;
    }

    // Emoji-reaction/namnlist-rad (GhostGrid wall style!)
    async function renderThreadReactions(threadId) {
      const reactionsRef = collection(db, "forumThreads", threadId, "reactions");
      const reactionsSnap = await getDocs(reactionsRef);
      const reactions = reactionsSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));

      // Sortera reaktioner per emoji
      const grouped = {};
      reactions.forEach(r => {
        if (!grouped[r.emoji]) grouped[r.emoji] = [];
        grouped[r.emoji].push(r);
      });

      // Hitta om currentUser har reagerat
      let myReaction = "";
      if (currentUser) {
        const mine = reactions.find(r => r.id === currentUser.uid);
        if (mine) myReaction = mine.emoji;
      }

      // Emoji-smiley trigger + emojirad, med antal och popup under r√§tt emoji
      let html = "";
      if (currentUser) {
        html += `<button class="emoji-trigger-btn" id="emojiTrigger-${threadId}"><span>üòä</span><span class="arrow">‚ñº</span></button>`;
      }
      html += `<div class="emoji-panel" id="emojiPanel-${threadId}" style="display:none; position:absolute; left:60px; top:5px; z-index:999;">${
        emojis.map(e =>
          `<button class="emoji-btn${myReaction === e.key ? " selected" : ""}" data-emoji="${e.key}" data-threadid="${threadId}">${e.emoji}</button>
          ${(grouped[e.key]?.length > 0)
            ? `<button class="emoji-count-btn" tabindex="0">
                ${grouped[e.key].length}
                <span class="reaction-popup">
                  <b>${e.emoji} ${grouped[e.key].length} st:</b><br>
                  ${grouped[e.key].map(u => userMap[u.user] || "G√§st").join("<br>")}
                </span>
              </button>`
            : ""}`
        ).join("")
      }</div>`;

      document.getElementById(`threadReactions-${threadId}`).innerHTML = html;

      // Visa emojirad n√§r man klickar p√• smiley-trigger
      const triggerBtn = document.getElementById(`emojiTrigger-${threadId}`);
      const panel = document.getElementById(`emojiPanel-${threadId}`);
      if (triggerBtn && panel) {
        triggerBtn.onclick = e => {
          e.stopPropagation();
          panel.style.display = (panel.style.display === "flex") ? "none" : "flex";
          panel.style.justifyContent = "flex-start";
          // Panel positionering (v√§nster p√• desktop, ner√•t p√• mobil)
          if (window.innerWidth < 700) {
            panel.style.left = "-7px";
            panel.style.top = "45px";
            panel.style.flexDirection = "column";
          } else {
            panel.style.left = "60px";
            panel.style.top = "5px";
            panel.style.flexDirection = "row";
          }
          // St√§ng n√§r man klickar utanf√∂r
          const hidePanel = (evt) => {
            if (!panel.contains(evt.target) && evt.target !== triggerBtn) {
              panel.style.display = "none";
              document.removeEventListener("mousedown", hidePanel);
            }
          };
          if (panel.style.display === "flex")
            setTimeout(() => document.addEventListener("mousedown", hidePanel), 10);
        };
      }

      // Emoji-klick
      panel?.querySelectorAll(".emoji-btn").forEach(btn => {
        btn.onclick = async function (e) {
          e.stopPropagation();
          if (!currentUser) return alert("Logga in f√∂r att reagera!");
          const emojiKey = btn.dataset.emoji;
          const ref = doc(db, "forumThreads", threadId, "reactions", currentUser.uid);
          const snap = await getDoc(ref);
          if (snap.exists() && snap.data().emoji === emojiKey) {
            await deleteDoc(ref); // Ta bort reaktion
          } else {
            await setDoc(ref, { emoji: emojiKey, user: currentUser.uid });
          }
          renderThreadReactions(threadId);
          panel.style.display = "none";
        };
      });

      // Popup under emoji-count-btn (visas centrerat under knappen)
      panel?.querySelectorAll('.emoji-count-btn').forEach(btn => {
        btn.onmouseenter = () => btn.classList.add('show');
        btn.onmouseleave = () => btn.classList.remove('show');
        btn.onfocus = () => btn.classList.add('show');
        btn.onblur = () => btn.classList.remove('show');
        // Klick p√• mobil visar/d√∂ljer popup
        btn.onclick = e => {
          if (window.innerWidth < 800) btn.classList.toggle('show');
        };
      });
    }

    // Tr√•d-funktionalitet
    function addThreadListeners(threads) {
      threads.forEach(thread => {
        loadPosts(thread.id);
        renderThreadReactions(thread.id);

        // Delete thread
        const delBtn = document.querySelector(
          `.thread[data-threadid="${thread.id}"] .thread-delete-btn`
        );
        if (delBtn) {
          delBtn.onclick = async () => {
            if (confirm("Vill du verkligen ta bort tr√•den?")) {
              await deleteDoc(doc(db, "forumThreads", thread.id));
              loadThreads();
            }
          };
        }
        // Add post
        const postForm = document.querySelector(
          `.thread[data-threadid="${thread.id}"] .add-post-form`
        );
        if (postForm) {
          postForm.onsubmit = async function(e) {
            e.preventDefault();
            if (!currentUser) { alert("Logga in f√∂r att kommentera."); return; }
            const textarea = document.getElementById(`postDesc-${thread.id}`);
            const text = textarea.value.trim();
            if (!text) return;
            await addDoc(collection(db, "forumThreads", thread.id, "posts"), {
              text,
              creatorUid: currentUser.uid,
              createdAt: new Date()
            });
            textarea.value = "";
            loadPosts(thread.id);
          };
        }
      });
    }

    // Ladda och rendera inl√§gg
    async function loadPosts(threadId) {
      const q = query(collection(db, "forumThreads", threadId, "posts"), orderBy("createdAt", "asc"));
      const postsSnap = await getDocs(q);
      const posts = postsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      document.getElementById(`threadContent-${threadId}`).innerHTML =
        posts.map(post => renderPost(threadId, post)).join("");
      posts.forEach(post => addPostListeners(threadId, post));
    }

    function renderPost(threadId, post) {
      const name = userMap[post.creatorUid] || "G√§st";
      return `
        <div class="post" data-postid="${post.id}">
          <div class="post-header">
            <span style="color:#00ffd9;">Anv√§ndare: 
              <a href="profile-view.html?uid=${post.creatorUid}" class="profile-link" style="color:#00ffd9;text-decoration:underline;">
                ${name}
              </a>
            </span>
          </div>
          <div class="post-content">${escapeHTML(post.text)}</div>
          <div class="comments-block" id="postComments-${threadId}-${post.id}"></div>
          <form class="add-comment-form" data-threadid="${threadId}" data-postid="${post.id}">
            <textarea rows="1" placeholder="Kommentera..." maxlength="200"></textarea>
            <button type="submit">Kommentera</button>
          </form>
        </div>
      `;
    }
    function addPostListeners(threadId, post) { /* Kommentarlogik h√§r om du vill */ }

    // LOGOUT
    function doLogout() { signOut(auth).then(() => { window.location.href = "login.html"; }); }
    document.getElementById("logoutDesktopBtn").onclick = doLogout;
    document.getElementById("logoutMobileBtn").onclick = doLogout;

    // Skapa tr√•d
    document.getElementById("threadForm").onsubmit = async function (e) {
      e.preventDefault();
      if (!currentUser) { alert("Logga in f√∂r att skapa tr√•d."); return; }
      const title = document.getElementById("threadTitle").value.trim();
      const desc = document.getElementById("threadDesc").value.trim();
      if (!title || !desc) return alert("Alla f√§lt m√•ste fyllas i.");
      await addDoc(collection(db, "forumThreads"), {
        title,
        description: desc,
        creatorUid: currentUser.uid,
        createdAt: new Date(),
        lang: localStorage.lang || "sv"
      });
      document.getElementById("threadTitle").value = "";
      document.getElementById("threadDesc").value = "";
      loadThreads();
    };

    // S√∂kfunktion
    const searchInput = document.getElementById("threadSearch");
    const clearBtn = document.getElementById("clearSearch");
    if (searchInput) {
      searchInput.addEventListener("input", e => { loadThreads(searchInput.value); });
      clearBtn.addEventListener("click", () => { searchInput.value = ""; loadThreads(""); });
    }

    // Escape HTML
    function escapeHTML(str) {
      return str ? str.replace(/[<>&"]/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;' }[c])) : "";
    }

    // AUTH STATE/INIT
    onAuthStateChanged(auth, user => {
      currentUser = user;
      loadThreads();
    });

    // Sidbanners (exakt som din kod)
    const banners = [
      {
        left: { src: "https://dummyimage.com/150x1800/7b00ff/fff&text=Reklam+1", alt: "Reklam Banner 1", url: "#" },
        right: { src: "https://dummyimage.com/150x1800/222299/fff&text=Reklam+2", alt: "Reklam Banner 2", url: "#" }
      },
      {
        left: { src: "https://dummyimage.com/150x1800/ff0088/fff&text=Bli+medlem!", alt: "Bli medlem", url: "register.html" },
        right: { src: "https://dummyimage.com/150x1800/0077ff/fff&text=Annonsera+H√§r", alt: "Annonsera", url: "#" }
      }
    ];
    let bannerIndex = 0;
    function updateBanners() {
      const left = banners[bannerIndex].left, right = banners[bannerIndex].right;
      document.getElementById('leftBannerImg').src = left.src;
      document.getElementById('leftBannerImg').alt = left.alt;
      document.getElementById('leftBannerLink').href = left.url;
      document.getElementById('rightBannerImg').src = right.src;
      document.getElementById('rightBannerImg').alt = right.alt;
      document.getElementById('rightBannerLink').href = right.url;
    }
    updateBanners();
    setInterval(() => { bannerIndex = (bannerIndex + 1) % banners.length; updateBanners(); }, 6000);
  </script>
</body>
</html>
