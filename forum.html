<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forum ‚Äì GhostGrid</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      margin: 0;
      background: #080808;
      color: #e0ffff;
      font-family: 'Courier New', monospace;
      min-height: 100vh;
      overflow-x: hidden;
    }
    /* Reklamkolumner */
    .ad-col {
      position: fixed;
      top: 0; bottom: 0;
      width: 90px;
      background: linear-gradient(180deg, #6a11ea 80%, #00ffd0 100%);
      border-radius: 18px;
      box-shadow: 0 0 18px #ad30fa, 0 0 8px #00ffd0;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 1;
      padding: 0;
      justify-content: space-between;
    }
    .ad-col.left { left: 0; }
    .ad-col.right { right: 0; }
    .ad-label {
      writing-mode: vertical-lr;
      color: #fff;
      opacity: 0.7;
      margin-top: 10px;
      margin-bottom: 10px;
      font-size: 1em;
      text-shadow: 0 0 8px #000;
    }
    /* NAV */
    nav.navbar {
      background: #000;
      border-bottom: 4px solid #ad30fa;
      box-shadow: 0 0 20px #ad30fa;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100vw;
      left: 0; top: 0; position: fixed; right: 0;
      z-index: 99;
      padding: 0 0 0 0;
      height: 58px;
    }
    .nav-content {
      display: flex;
      gap: 60px;
      align-items: center;
      justify-content: center;
      width: 100%;
      transition: 0.18s;
    }
    .nav-content a {
      color: #fff;
      text-decoration: none;
      font-size: 1.25em;
      padding: 10px 20px;
      border-radius: 7px;
      margin: 0 5px;
      background: transparent;
      transition: background 0.18s, color 0.18s, box-shadow 0.22s;
      text-shadow: 0 0 10px #ad30fa, 0 0 3px #fff;
      font-weight: bold;
    }
    .nav-content a.active, .nav-content a:hover {
      background: #ad30fa;
      color: #000;
      box-shadow: 0 0 16px #ad30fa, 0 0 5px #fff;
    }
    #menuBtn {
      display: none;
      background: none;
      border: none;
      color: #fff;
      font-size: 2.2em;
      position: absolute;
      left: 18px; top: 8px;
      cursor: pointer;
      z-index: 200;
    }
    @media (max-width: 1100px) {
      .ad-col { display: none; }
    }
    @media (max-width: 900px) {
      .nav-content {
        flex-direction: column;
        background: #1e0024e8;
        position: absolute;
        left: 0; top: 58px;
        width: 100vw;
        gap: 24px;
        padding: 19px 0 12px 0;
        display: none;
        z-index: 150;
      }
      .nav-content.active { display: flex; }
      #menuBtn { display: block; }
      nav.navbar {
        height: 56px;
        justify-content: center;
      }
    }
    @media (max-width: 600px) {
      .nav-content a { font-size: 1.09em; }
    }

    /* Forum main layout */
    .forum-main-container {
      margin: 0 auto;
      max-width: 900px;
      padding: 92px 0 110px 0;
      position: relative;
      z-index: 10;
      min-height: 80vh;
    }
    .thread-form-box {
      margin: 0 auto 40px auto;
      padding: 30px 24px 26px 24px;
      border-radius: 18px;
      background: #0a0a0a;
      border: 2px solid #00ff00;
      box-shadow: 0 0 18px #00ff00, 0 0 12px #ad30fa90;
      text-align: center;
      max-width: 500px;
      color: #fff;
    }
    .thread-form-box h2 {
      font-family: 'Courier New', monospace;
      font-size: 2em;
      margin: 0 0 18px 0;
      color: #fff;
      text-shadow: 0 0 8px #00ffcc;
      letter-spacing: 1px;
    }
    .thread-form-box input, .thread-form-box textarea {
      width: 100%;
      margin: 12px 0;
      padding: 12px 10px;
      border-radius: 7px;
      border: 1.5px solid #00ff00;
      background: #000;
      color: #00ff00;
      font-size: 1.13em;
      font-family: 'Courier New', monospace;
      outline: none;
      transition: border 0.16s;
    }
    .thread-form-box button {
      background: #00ff00;
      color: #000;
      border: none;
      padding: 12px 32px;
      border-radius: 8px;
      font-size: 1.08em;
      margin-top: 13px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.16s;
      box-shadow: 0 0 6px #00ffcc;
    }
    .thread-form-box button:hover { background: #04df49; }
    /* Tr√•d/inl√§gg/kommentar struktur */
    .threads-list {
      margin: 0 auto 50px auto;
      max-width: 770px;
      min-height: 250px;
    }
    .thread-card, .comment-card {
      background: #141415;
      border: 2px solid #00ffcc;
      border-radius: 13px;
      margin: 28px 0 15px 0;
      box-shadow: 0 0 10px #ad30fa60, 0 0 2px #00ffcc;
      padding: 22px 19px 10px 19px;
      position: relative;
    }
    .thread-title { font-size: 1.2em; font-weight: bold; color: #00ffcc; margin-bottom: 7px;}
    .thread-desc { font-size: 1.01em; margin-bottom: 9px; color: #fff;}
    .thread-meta, .comment-meta { font-size: .98em; color: #93f3dc; margin-bottom: 6px;}
    .reactions-bar, .comment-reactions { margin: 4px 0 7px 0; }
    .reactions-bar button, .comment-reactions button {
      background: transparent;
      color: #fff;
      border: none;
      font-size: 1.4em;
      cursor: pointer;
      margin: 0 3px;
      transition: transform 0.13s;
      border-radius: 4px;
    }
    .reactions-bar button.selected, .comment-reactions button.selected {
      background: #00ffcc33;
      box-shadow: 0 0 8px #00ffcc, 0 0 3px #fff;
    }
    .edit-btn, .delete-btn, .save-btn, .cancel-btn {
      background: #ad30fa;
      color: #fff;
      border: none;
      border-radius: 5px;
      margin: 0 5px 0 0;
      padding: 5px 13px;
      font-size: .93em;
      cursor: pointer;
      font-weight: bold;
      transition: background .12s;
    }
    .delete-btn { background: #ff0e53; }
    .save-btn { background: #00ffcc; color: #111;}
    .cancel-btn { background: #333; color: #fff;}
    .edit-btn:hover, .delete-btn:hover, .save-btn:hover, .cancel-btn:hover {
      opacity: 0.9;
      filter: brightness(1.11);
    }
    .add-comment-box {
      margin: 9px 0 0 0;
      display: flex;
      flex-direction: column;
      gap: 7px;
    }
    .add-comment-box textarea {
      background: #0d0d0d;
      border: 1px solid #ad30fa;
      color: #00ffcc;
      border-radius: 7px;
      font-family: inherit;
      font-size: 1em;
      padding: 9px 10px;
      min-height: 37px;
      resize: vertical;
    }
    .add-comment-box button {
      background: #ad30fa;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 7px 0;
      width: 120px;
      align-self: flex-end;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 4px #ad30fa80;
      font-size: 1.01em;
      margin-top: 4px;
    }
    /* Ai assistenter nere */
    .ai-footer {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      width: 100vw;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      z-index: 200;
      gap: 110px;
      padding-bottom: 12px;
      pointer-events: none;
    }
    .ai-block {
      display: flex;
      align-items: flex-end;
      gap: 14px;
      min-width: 150px;
      pointer-events: auto;
    }
    .ai-info {
      color: #93f3dc;
      font-size: 1em;
      max-width: 190px;
      margin-bottom: 3px;
      line-height: 1.3;
      text-shadow: 0 0 6px #000;
    }
    .ai-block .ai-label {
      font-weight: bold;
      text-align: center;
      color: #00ffcc;
      font-size: 1.08em;
      margin-top: 2px;
      margin-bottom: 0;
    }
    .ai-block .ai-label.glow { color: #ffe700; }
    .ai-block .ai-icon {
      width: 41px; height: 41px;
      display: flex;
      align-items: center; justify-content: center;
      margin-bottom: 1px;
    }
    @media (max-width:900px) {
      .forum-main-container { padding-left: 3vw; padding-right: 3vw;}
      .ai-footer { gap: 25vw; }
    }
    @media (max-width:600px) {
      .ai-footer { gap: 10vw; }
      .ai-block .ai-info { max-width: 110px; font-size: 0.98em;}
    }
  </style>
  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script>
    // FIREBASE-CONFIG
    const firebaseConfig = { 
      apiKey: "AIzaSyCR8q40Dc4wcfYBDlxdpOriA2e3RTmAesg",
      authDomain: "ghostgrid-fb278.firebaseapp.com",
      projectId: "ghostgrid-fb278",
      storageBucket: "ghostgrid-fb278.firebasestorage.app",
      messagingSenderId: "283208202937",
      appId: "1:283208202937:web:11c0cea81fd81a31163968",
      measurementId: "G-B0WCKJCNT9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
  </script>
</head>
<body>
  <!-- REKLAM V√ÑNSTER/H√ñGER -->
  <div class="ad-col left">
    <div class="ad-label">REKLAM V√ÑNSTER</div>
    <div></div>
  </div>
  <div class="ad-col right">
    <div></div>
    <div class="ad-label">REKLAM H√ñGER</div>
  </div>
  <!-- NAVIGATION -->
  <nav class="navbar">
    <button id="menuBtn" aria-label="Meny">&#9776;</button>
    <div class="nav-content" id="navLinks">
      <a href="forum.html" class="active">Forum</a>
      <a href="store.html">Store</a>
      <a href="wall.html">V√§ggen</a>
      <a href="upload.html">Ladda upp</a>
      <a href="profile.html">Profil</a>
      <a href="friends.html">V√§nner</a>
      <div class="search-container">
        <input type="text" id="globalSearchInput" placeholder="S√∂k p√• hela sidan...">
      </div>
    </div>
  </nav>
  <!-- FORUM MAIN -->
  <div class="forum-main-container">
    <div class="thread-form-box" id="threadFormBox">
      <h2 id="threadFormTitle">Skapa ny tr√•d</h2>
      <input id="newThreadTitle" placeholder="Titel p√• tr√•d (t.ex. Matematik)">
      <textarea id="newThreadDesc" rows="3" placeholder="Beskrivning (valfritt)"></textarea>
      <button id="createThreadBtn">Skapa tr√•d</button>
    </div>
    <div class="threads-list" id="threadsList">
      <div style="text-align:center;color:#ad30fa;font-size:1.12em;" id="loadingMsg">Laddar...</div>
    </div>
  </div>
  <!-- AI-footer -->
  <div class="ai-footer">
    <div class="ai-block">
      <div class="ai-icon">
        <!-- GHOST SVG (fr√•n din tidigare bild, √§ndra ej) -->
        <svg width="44" height="44" viewBox="0 0 56 56" fill="none"><ellipse cx="28" cy="32" rx="16" ry="19" fill="#131b20" stroke="#00ffcc" stroke-width="3"/><ellipse cx="22" cy="32" rx="3.5" ry="3" fill="#fff"/><ellipse cx="34" cy="32" rx="3.5" ry="3" fill="#fff"/><rect x="19.5" y="39" width="17" height="6" rx="3" fill="#232d38"/><rect x="15.5" y="26" width="25" height="11" rx="11" fill="none" stroke="#00ffcc" stroke-width="1"/></svg>
      </div>
      <div>
        <div class="ai-label">Ghost</div>
        <div class="ai-info" id="ghostInfo">
          Jag √§r Ghost, din tekniska support som guidar dig r√§tt p√• plattformen och svarar p√• fr√•gor om funktioner, s√§kerhet och allt digitalt. Klicka p√• Ghost i menyn f√∂r att chatta!
        </div>
      </div>
    </div>
    <div class="ai-block">
      <div class="ai-icon">
        <!-- GLOW SVG (fr√•n din tidigare bild, √§ndra ej) -->
        <svg width="44" height="44" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="36" rx="14" ry="16" fill="#fffbe8" stroke="#ffe700" stroke-width="2"/><path d="M26 44 Q32 48 38 44" stroke="#ffcc1a" stroke-width="2" fill="none"/><ellipse cx="27" cy="36" rx="2" ry="2.5" fill="#555"/><ellipse cx="37" cy="36" rx="2" ry="2.5" fill="#555"/><g><circle cx="14" cy="28" r="2" fill="#ffe700" opacity="0.7"/><circle cx="48" cy="20" r="1.7" fill="#ffed60" opacity="0.5"/><circle cx="52" cy="40" r="1.3" fill="#fff780" opacity="0.7"/><circle cx="36" cy="17" r="1.1" fill="#fffbc0" opacity="0.6"/><circle cx="18" cy="50" r="1.2" fill="#fffdd2" opacity="0.5"/><circle cx="28" cy="14" r="1.3" fill="#fff780" opacity="0.7"/></g></svg>
      </div>
      <div>
        <div class="ai-label glow">Glow</div>
        <div class="ai-info" id="glowInfo">
          Jag √§r Glow! Om du beh√∂ver n√•gon att prata med, f√• st√∂d eller bara vill sprida lite positiv energi ‚Äì chatta med mig n√§r du vill!
        </div>
      </div>
    </div>
  </div>
  <script>
const EMOJIS = [
  { emoji: "üëç", key: "thumbsup" }, { emoji: "üëé", key: "thumbsdown" },
  { emoji: "üôÇ", key: "smile" }, { emoji: "üòÉ", key: "bigsmile" },
  { emoji: "üòÇ", key: "laugh" }, { emoji: "üòï", key: "confused" },
  { emoji: "üôÅ", key: "sad" }, { emoji: "üò¢", key: "cry" },
  { emoji: "üò°", key: "angry" }, { emoji: "üò≥", key: "embarrassed" }, { emoji: "üòá", key: "angel" }
];
const TRANSLATE = {
  sv: {
    createThread: "Skapa ny tr√•d",
    threadTitle: "Titel p√• tr√•d (t.ex. Matematik)",
    threadDesc: "Beskrivning (valfritt)",
    createBtn: "Skapa tr√•d",
    addComment: "Kommentera",
    edit: "Redigera", delete: "Ta bort", save: "Spara", cancel: "Avbryt",
    reply: "Svara", reactions: "Reaktioner", loading: "Laddar...",
    editComment: "Redigera kommentar",
    enterComment: "Skriv kommentar...",
    confirmDelete: "√Ñr du s√§ker p√• att du vill ta bort?",
    needLogin: "Du m√•ste vara inloggad f√∂r att g√∂ra detta.",
    fillTitle: "Fyll i titel p√• tr√•den!",
    fillComment: "Skriv n√•got i kommentaren!",
    showReplies: "Visa svar",
    hideReplies: "D√∂lj svar",
    showMore: "Visa fler", showLess: "Visa f√§rre"
  },
  en: {
    createThread: "Create new thread",
    threadTitle: "Thread title (e.g. Math)",
    threadDesc: "Description (optional)",
    createBtn: "Create thread",
    addComment: "Add comment",
    edit: "Edit", delete: "Delete", save: "Save", cancel: "Cancel",
    reply: "Reply", reactions: "Reactions", loading: "Loading...",
    editComment: "Edit comment",
    enterComment: "Write a comment...",
    confirmDelete: "Are you sure you want to delete?",
    needLogin: "You need to be logged in.",
    fillTitle: "Please enter a thread title!",
    fillComment: "Please write a comment!",
    showReplies: "Show replies",
    hideReplies: "Hide replies",
    showMore: "Show more", showLess: "Show less"
  }
};
let lang = (localStorage.language === "en" ? "en" : "sv");

function t(key) { return TRANSLATE[lang][key] || key; }

// Centrera hamburgermeny p√• mobil
const menuBtn = document.getElementById("menuBtn");
const navLinks = document.getElementById("navLinks");
menuBtn.onclick = () => navLinks.classList.toggle("active");
document.querySelectorAll('.nav-content a').forEach(a =>
  a.onclick = () => navLinks.classList.remove("active")
);

// --- Spr√•k p√• formul√§r
function setFormLang() {
  document.getElementById('threadFormTitle').textContent = t('createThread');
  document.getElementById('newThreadTitle').placeholder = t('threadTitle');
  document.getElementById('newThreadDesc').placeholder = t('threadDesc');
  document.getElementById('createThreadBtn').textContent = t('createBtn');
}
setFormLang();

// --- NAV f√§sts h√∂gst upp vid scroll (mobil)
if (window.innerWidth < 900) {
  let lastY = window.scrollY;
  let nav = document.querySelector('.navbar');
  window.addEventListener('scroll', function () {
    if (window.scrollY > lastY && window.scrollY > 56) {
      nav.classList.add('hide-navbar');
    } else {
      nav.classList.remove('hide-navbar');
    }
    lastY = window.scrollY;
  });
}

// --- Autentisering
let currentUser = null;
auth.onAuthStateChanged(user => {
  currentUser = user;
  renderThreads();
});

// --- Skapa ny tr√•d
document.getElementById("createThreadBtn").onclick = async function() {
  if (!currentUser) { alert(t('needLogin')); return; }
  let title = document.getElementById("newThreadTitle").value.trim();
  let desc = document.getElementById("newThreadDesc").value.trim();
  if (!title) { alert(t('fillTitle')); return; }
  await db.collection("forumThreads").add({
    title, desc, uid: currentUser.uid, name: currentUser.displayName || "Anonym",
    time: new Date(), reactions: {}, lang, deleted: false
  });
  document.getElementById("newThreadTitle").value = "";
  document.getElementById("newThreadDesc").value = "";
  renderThreads();
};

async function renderThreads() {
  const list = document.getElementById('threadsList');
  list.innerHTML = `<div style="text-align:center;color:#ad30fa;font-size:1.12em;">${t('loading')}</div>`;
  const qsnap = await db.collection("forumThreads").orderBy("time", "desc").get();
  list.innerHTML = '';
  if (qsnap.empty) {
    list.innerHTML = `<div style="color:#00ffcc;text-align:center;font-size:1.12em;margin-top:28px">Ingen tr√•d √§nnu ‚Äì skapa en!</div>`;
    return;
  }
  qsnap.forEach(doc => {
    if (doc.data().deleted) return;
    const data = doc.data();
    const el = renderThreadCard(doc.id, data);
    list.appendChild(el);
  });
}

// --- Rendera tr√•d (inkl inl√§gg och kommentarer, rekursivt)
function renderThreadCard(threadId, data) {
  let card = document.createElement("div");
  card.className = "thread-card";
  card.innerHTML = `
    <div class="thread-title">${escapeHtml(data.title)}</div>
    ${data.desc ? `<div class="thread-desc">${escapeHtml(data.desc)}</div>` : ""}
    <div class="thread-meta">${data.name} &ndash; ${formatDate(data.time)}</div>
    <div class="reactions-bar">${renderReactions(threadId, data.reactions || {}, "thread")}</div>
    ${currentUser && currentUser.uid === data.uid ? 
      `<button class="edit-btn" onclick="editThread('${threadId}')">${t('edit')}</button>
       <button class="delete-btn" onclick="deleteThread('${threadId}')">${t('delete')}</button>` : ""}
    <div id="comments-${threadId}" class="comments"></div>
    <div class="add-comment-box">
      <textarea id="comment-inp-${threadId}" placeholder="${t('enterComment')}"></textarea>
      <button onclick="addComment('${threadId}', null)">${t('addComment')}</button>
    </div>
  `;
  // Ladda kommentarer till tr√•d
  setTimeout(() => { loadComments(threadId, null, `comments-${threadId}`); }, 0);
  return card;
}

// Escape f√∂r XSS-skydd
function escapeHtml(s) {
  return s.replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}
// Datumformat
function formatDate(ts) {
  try {
    const d = ts?.toDate?.() || new Date(ts);
    return d.toLocaleString(lang === "sv" ? "sv-SE" : "en-GB", {dateStyle:"short", timeStyle:"short"});
  } catch { return ""; }
}

// --- Kommentar- & reply-funktion: laddar in (och renderar rekursivt)
async function loadComments(threadId, parentId, containerId, depth=0) {
  const box = document.getElementById(containerId);
  box.innerHTML = "";
  const ref = db.collection("forumThreads").doc(threadId).collection("comments");
  let qsnap;
  if (!parentId) {
    qsnap = await ref.where("parent", "==", null).orderBy("time").get();
  } else {
    qsnap = await ref.where("parent", "==", parentId).orderBy("time").get();
  }
  qsnap.forEach(doc => {
    if (doc.data().deleted) return;
    const cEl = renderComment(threadId, doc.id, doc.data(), depth);
    box.appendChild(cEl);
  });
}

// Rendera en kommentar (inkl. reply, edit, reaktion)
function renderComment(threadId, commentId, data, depth) {
  const cdiv = document.createElement("div");
  cdiv.className = "comment-card";
  cdiv.style.marginLeft = depth ? `${depth*23}px` : "";
  cdiv.innerHTML = `
    <div class="comment-meta">${data.name || "Anonym"} &ndash; ${formatDate(data.time)}</div>
    <div class="comment-content" id="content-${threadId}-${commentId}">${escapeHtml(data.content || "")}</div>
    <div class="comment-reactions">${renderReactions(commentId, data.reactions || {}, "comment", threadId)}</div>
    <div style="margin-bottom:4px">
      <button class="reply-btn" onclick="showReply('${threadId}','${commentId}',${depth+1})">${t('reply')}</button>
      ${currentUser && currentUser.uid === data.uid ?
        `<button class="edit-btn" onclick="editComment('${threadId}','${commentId}')">${t('edit')}</button>
         <button class="delete-btn" onclick="deleteComment('${threadId}','${commentId}')">${t('delete')}</button>` : ""}
    </div>
    <div id="replies-${threadId}-${commentId}"></div>
  `;
  // Ladda replies
  setTimeout(() => loadComments(threadId, commentId, `replies-${threadId}-${commentId}`, depth+1), 0);
  return cdiv;
}

// Reaktioner med emojis p√• tr√•dar/kommentarer
function renderReactions(itemId, reactions, type, threadId) {
  let html = "";
  EMOJIS.forEach(({emoji, key}) => {
    let count = Object.values(reactions || {}).filter(r=>r===key).length;
    let sel = currentUser && reactions && reactions[currentUser.uid] === key ? "selected" : "";
    html += `<button class="${sel}" title="${emoji}" onclick="reactTo('${itemId}','${key}','${type}','${threadId||""}')">${emoji}${count?'<span style=\'font-size:.8em;margin-left:1px\'>' + count + '</span>':''}</button>`;
  });
  return html;
}

// Global reaktions-funktion
window.reactTo = async function(itemId, reaction, type, threadId="") {
  if (!currentUser) { alert(t('needLogin')); return; }
  let ref;
  if (type==="thread") ref = db.collection("forumThreads").doc(itemId);
  else ref = db.collection("forumThreads").doc(threadId).collection("comments").doc(itemId);
  let snap = await ref.get();
  let reactions = snap.data().reactions || {};
  if (reactions[currentUser.uid] === reaction) delete reactions[currentUser.uid];
  else reactions[currentUser.uid] = reaction;
  await ref.update({reactions});
  if (type==="thread") renderThreads();
  else loadComments(threadId, null, `comments-${threadId}`);
};

// Kommentar: add, edit, delete, reply
window.addComment = async function(threadId, parentId) {
  if (!currentUser) { alert(t('needLogin')); return; }
  let inpId = parentId ? `reply-input-${threadId}-${parentId}` : `comment-inp-${threadId}`;
  let val = document.getElementById(inpId).value.trim();
  if (!val) { alert(t('fillComment')); return; }
  await db.collection("forumThreads").doc(threadId).collection("comments").add({
    content: val, parent: parentId || null,
    uid: currentUser.uid, name: currentUser.displayName || "Anonym",
    time: new Date(), reactions: {}, lang, deleted: false
  });
  document.getElementById(inpId).value = "";
  loadComments(threadId, null, `comments-${threadId}`);
};

window.showReply = function(threadId, commentId, depth) {
  let el = document.getElementById(`replies-${threadId}-${commentId}`);
  if (!el.querySelector('textarea')) {
    el.innerHTML = `<div class="add-comment-box">
      <textarea id="reply-input-${threadId}-${commentId}" placeholder="${t('enterComment')}"></textarea>
      <button onclick="addComment('${threadId}','${commentId}')">${t('addComment')}</button>
    </div>`;
  } else {
    el.innerHTML = "";
  }
};

window.editThread = function(threadId) {
  // ... Implementera edit tr√•d (du kan l√§gga till edit-funktion likt kommentars-edit)
  alert("Redigera tr√•d (kommer snart!)");
};
window.deleteThread = async function(threadId) {
  if (!confirm(t('confirmDelete'))) return;
  await db.collection("forumThreads").doc(threadId).update({deleted:true});
  renderThreads();
};

window.editComment = function(threadId, commentId) {
  // ... Implementera edit f√∂r kommentarer om du vill!
  alert("Redigera kommentar (kommer snart!)");
};
window.deleteComment = async function(threadId, commentId) {
  if (!confirm(t('confirmDelete'))) return;
  await db.collection("forumThreads").doc(threadId).collection("comments").doc(commentId).update({deleted:true});
  loadComments(threadId, null, `comments-${threadId}`);
};

// Spr√•kbyte live (om man byter spr√•k i localStorage fr√•n annan flik)
window.addEventListener('storage', function(e){
  if(e.key === 'language') {
    lang = (localStorage.language === "en" ? "en" : "sv");
    setFormLang();
    renderThreads();
  }
});

// S√∂k (global, men l√§gger bara till redirect nu)
document.getElementById("globalSearchInput").addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    const query = this.value.trim();
    if (query) window.location.href = "search.html?q=" + encodeURIComponent(query);
  }
});

// Starta tr√•dvisning direkt
renderThreads();

</script>
</body>
</html>
