<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forum – GhostGrid</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      margin: 0;
      padding-top: 74px;
      background-color: #0a0a0a;
      color: #e0ffff;
      font-family: 'Courier New', monospace;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    nav.navbar {
      background: #000;
      width: 100vw;
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 2000;
      border-bottom: 4px solid #ad30fa;
      box-shadow: 0 0 20px #ad30fa;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .nav-content {
      display: flex;
      gap: 40px;
      padding: 14px 0 12px 0;
      align-items: center;
      justify-content: center;
      width: 100%;
      transition: 0.18s;
    }
    .nav-content a {
      color: #e0ffff;
      text-decoration: none;
      font-size: 1.35em;
      font-family: monospace;
      padding: 5px 22px;
      border-radius: 7px;
      margin: 0 5px;
      background: transparent;
      transition: background 0.18s, color 0.18s, box-shadow 0.22s;
      text-shadow: 0 0 8px #ad30fa, 0 0 3px #fff;
    }
    .nav-content a:hover, .nav-content a.active {
      background: #ad30fa;
      color: #000;
      box-shadow: 0 0 16px #ad30fa, 0 0 5px #fff;
    }
    #menuBtn {
      display: none;
      background: none;
      border: none;
      color: #fff;
      font-size: 2.3em;
      position: absolute;
      right: 18px;
      top: 5px;
      cursor: pointer;
      z-index: 3000;
    }
    @media (max-width: 900px) {
      .nav-content {
        flex-direction: column;
        background: #0a0020f7;
        position: absolute;
        left: 0; top: 55px;
        width: 100vw;
        gap: 18px;
        padding: 15px 0 10px 0;
        display: none;
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }
      .nav-content.active { display: flex; }
      #menuBtn { display: block; }
    }
    @media (max-width: 600px) {
      .nav-content a { font-size: 1.11em; }
    }
    /* SIDREKLAM */
    .side-ads {
      position: fixed;
      top: 74px;
      bottom: 0;
      width: 110px;
      z-index: 1010;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      pointer-events: none;
    }
    .side-ads.left { left: 0; }
    .side-ads.right { right: 0; }
    .side-ad-img {
      width: 100%;
      height: 320px;
      object-fit: cover;
      margin: 20px 0;
      border-radius: 12px;
      box-shadow: 0 0 18px #7b00ff99;
      background: #11002a;
      pointer-events: auto;
      cursor: pointer;
      display: block;
    }
    @media (max-width: 1200px) {
      .side-ads { display: none; }
    }
    /* HUVUDINNEHÅLL */
    .forum-main-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 950px;
      margin: 0 auto 140px auto;
      width: 100%;
      padding: 0 15px;
      position: relative;
      z-index: 2;
    }
    .create-thread-form {
      margin-top: 12px;
      background: rgba(0,0,0,0.8);
      border: 2px solid #00ff00;
      border-radius: 10px;
      padding: 32px 25px 28px 25px;
      max-width: 530px;
      width: 100%;
      box-shadow: 0 0 15px #00ff00;
      margin-bottom: 36px;
      text-align: center;
    }
    .create-thread-form input, .create-thread-form textarea {
      width: 100%;
      margin-bottom: 13px;
      border-radius: 5px;
      border: 1px solid #00ff00;
      background-color: #111;
      color: #00ff00;
      font-family: 'Courier New', monospace;
      padding: 11px;
      font-size: 1.1em;
    }
    .create-thread-form button {
      background-color: #00ff00;
      color: #18191a;
      border: none;
      padding: 12px 40px;
      font-size: 1.12em;
      border-radius: 7px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 5px #00ff00;
      transition: background 0.18s;
    }
    .create-thread-form button:hover {
      background: #00cc00;
    }
    .thread-list { width: 100%; max-width: 850px; margin-bottom: 60px; }
    .thread-item {
      background: #14141f;
      border-radius: 13px;
      box-shadow: 0 0 9px #bb00ff80;
      margin-bottom: 25px;
      padding: 20px 16px 13px 16px;
      cursor: pointer;
      transition: box-shadow 0.2s, background 0.2s;
    }
    .thread-item:hover {
      box-shadow: 0 0 24px #00ffcc80;
      background: #181927;
    }
    .thread-title {
      font-size: 1.3em;
      color: #00ffcc;
      margin-bottom: 7px;
      font-weight: bold;
      text-shadow: 0 0 6px #fff, 0 0 10px #00ffcc88;
    }
    .thread-desc {
      color: #d8ffff;
      font-size: 1em;
      margin-bottom: 6px;
    }
    /* Ghost & Glow i botten */
    .ai-footer {
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      display: flex;
      justify-content: center;
      align-items: end;
      z-index: 2100;
      gap: 45px;
      padding: 6px 0 16px 0;
      pointer-events: none;
      background: none;
      height: 120px;
    }
    .ai-avatar {
      text-align: center;
      flex: 0 0 auto;
      pointer-events: auto;
      cursor: pointer;
    }
    .ai-label {
      color: #00ffcc;
      font-weight: bold;
      font-size: 1.11em;
    }
    .ai-label.glow { color: #ffe700; }
    @media (max-width: 600px) {
      .ai-footer { gap: 22px; height: 85px; }
    }
  </style>
  <!-- FIREBASE & MODULER -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script>
    // --- Firebase init ---
    const firebaseConfig = { 
      apiKey: "AIzaSyCR8q40Dc4wcfYBDlxdpOriA2e3RTmAesg",
      authDomain: "ghostgrid-fb278.firebaseapp.com",
      projectId: "ghostgrid-fb278",
      storageBucket: "ghostgrid-fb278.firebasestorage.app",
      messagingSenderId: "283208202937",
      appId: "1:283208202937:web:11c0cea81fd81a31163968",
      measurementId: "G-B0WCKJCNT9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
  </script>
</head>
<body>
  <!-- SIDOREKLAM -->
  <div class="side-ads left">
    <a href="#" class="side-ad-img" target="_blank">
      <img src="https://dummyimage.com/110x320/7b00ff/fff&text=Reklam+1" alt="Reklam vänster" />
    </a>
  </div>
  <div class="side-ads right">
    <a href="#" class="side-ad-img" target="_blank">
      <img src="https://dummyimage.com/110x320/00ffcc/222&text=Reklam+2" alt="Reklam höger" />
    </a>
  </div>

  <!-- MENY -->
  <nav class="navbar">
    <button id="menuBtn" aria-label="Meny">&#9776;</button>
    <div class="nav-content" id="navLinks">
      <a href="forum.html" class="active">Forum</a>
      <a href="store.html">Store</a>
      <a href="wall.html">Väggen</a>
      <a href="upload.html">Ladda upp</a>
      <a href="profile.html">Profil</a>
      <a href="friends.html">Vänner</a>
    </div>
  </nav>
  
  <!-- HUVUDINNEHÅLL -->
  <div class="forum-main-container">
    <!-- Skapa ny tråd -->
    <form class="create-thread-form" id="createThreadForm">
      <h2 id="createThreadTitle">Skapa ny tråd</h2>
      <input type="text" id="threadTitle" maxlength="64" placeholder="Titel på tråd (t.ex. Matematik)" required>
      <textarea id="threadDesc" rows="3" maxlength="220" placeholder="Beskrivning (valfritt)"></textarea>
      <button type="submit" id="createThreadBtn">Skapa tråd</button>
    </form>
    <!-- Lista på trådar -->
    <div class="thread-list" id="threadList"></div>
  </div>

  <!-- AI FOOTER -->
  <div class="ai-footer">
    <div class="ai-avatar" onclick="window.location='ghost.html'">
      <!-- Ghost ikon SVG -->
      <svg width="52" height="52" viewBox="0 0 56 56" fill="none">
        <ellipse cx="28" cy="32" rx="16" ry="19" fill="#131b20" stroke="#00ffcc" stroke-width="3"/>
        <ellipse cx="22" cy="32" rx="3.5" ry="3" fill="#fff"/>
        <ellipse cx="34" cy="32" rx="3.5" ry="3" fill="#fff"/>
        <rect x="19.5" y="39" width="17" height="6" rx="3" fill="#232d38"/>
        <rect x="15.5" y="26" width="25" height="11" rx="11" fill="none" stroke="#00ffcc" stroke-width="1"/>
      </svg>
      <div class="ai-label">Ghost</div>
    </div>
    <div class="ai-avatar" onclick="window.location='glow.html'">
      <!-- Glow ikon SVG -->
      <svg width="52" height="52" viewBox="0 0 64 64" fill="none">
        <ellipse cx="32" cy="36" rx="14" ry="16" fill="#fffbe8" stroke="#ffe700" stroke-width="2"/>
        <path d="M26 44 Q32 48 38 44" stroke="#ffcc1a" stroke-width="2" fill="none"/>
        <ellipse cx="27" cy="36" rx="2" ry="2.5" fill="#555"/>
        <ellipse cx="37" cy="36" rx="2" ry="2.5" fill="#555"/>
        <g>
          <circle cx="14" cy="28" r="2" fill="#ffe700" opacity="0.7"/>
          <circle cx="48" cy="20" r="1.7" fill="#ffed60" opacity="0.5"/>
          <circle cx="52" cy="40" r="1.3" fill="#fff780" opacity="0.7"/>
          <circle cx="36" cy="17" r="1.1" fill="#fffbc0" opacity="0.6"/>
          <circle cx="18" cy="50" r="1.2" fill="#fffdd2" opacity="0.5"/>
          <circle cx="28" cy="14" r="1.3" fill="#fff780" opacity="0.7"/>
        </g>
      </svg>
      <div class="ai-label glow">Glow</div>
    </div>
  </div>
  <script>
    // --- Hamburgermeny (centrerad) ---
    const menuBtn = document.getElementById("menuBtn");
    const navLinks = document.getElementById("navLinks");
    menuBtn.onclick = () => navLinks.classList.toggle("active");
    document.querySelectorAll('.nav-content a').forEach(a =>
      a.onclick = () => navLinks.classList.remove("active")
    );

    // --- Språkstöd ---
    const translations = {
      sv: {
        createThreadTitle: "Skapa ny tråd",
        createThreadBtn: "Skapa tråd",
        threadTitlePlaceholder: "Titel på tråd (t.ex. Matematik)",
        threadDescPlaceholder: "Beskrivning (valfritt)",
        needLogin: "Du måste vara inloggad.",
        addPostBtn: "Lägg upp inlägg",
        postPlaceholder: "Skriv ett inlägg...",
        addCommentBtn: "Kommentera",
        commentPlaceholder: "Skriv en kommentar...",
        delete: "Ta bort",
        edit: "Redigera",
        save: "Spara",
        cancel: "Avbryt",
        confirmDelete: "Är du säker på att du vill ta bort?",
        loginToPost: "Logga in för att delta.",
        reply: "Svara",
        showReplies: "Visa svar",
        hideReplies: "Dölj svar"
      },
      en: {
        createThreadTitle: "Create New Thread",
        createThreadBtn: "Create Thread",
        threadTitlePlaceholder: "Thread title (e.g. Mathematics)",
        threadDescPlaceholder: "Description (optional)",
        needLogin: "You must be logged in.",
        addPostBtn: "Add Post",
        postPlaceholder: "Write a post...",
        addCommentBtn: "Comment",
        commentPlaceholder: "Write a comment...",
        delete: "Delete",
        edit: "Edit",
        save: "Save",
        cancel: "Cancel",
        confirmDelete: "Are you sure you want to delete?",
        loginToPost: "Log in to participate.",
        reply: "Reply",
        showReplies: "Show replies",
        hideReplies: "Hide replies"
      }
    };
    let lang = localStorage.language === "en" ? "en" : "sv";
    function t(key) { return translations[lang][key] || key; }

    function updateUIStrings() {
      document.getElementById("createThreadTitle").textContent = t("createThreadTitle");
      document.getElementById("createThreadBtn").textContent = t("createThreadBtn");
      document.getElementById("threadTitle").placeholder = t("threadTitlePlaceholder");
      document.getElementById("threadDesc").placeholder = t("threadDescPlaceholder");
      // Inlägg/kommentarers knappar sätts dynamiskt i render
    }
    updateUIStrings();
    window.addEventListener('storage', function(e){
      if(e.key === 'language') {
        lang = localStorage.language === "en" ? "en" : "sv";
        updateUIStrings();
        renderThreads();
      }
    });

    // --- Reaktionsikoner ---
    const REACTIONS = [
      { emoji: "👍", key: "thumbsup" },
      { emoji: "👎", key: "thumbsdown" },
      { emoji: "🙂", key: "smile" },
      { emoji: "😃", key: "bigsmile" },
      { emoji: "😂", key: "laugh" },
      { emoji: "😕", key: "confused" },
      { emoji: "🙁", key: "sad" },
      { emoji: "😢", key: "cry" },
      { emoji: "😡", key: "angry" },
      { emoji: "😳", key: "embarrassed" },
      { emoji: "😇", key: "angel" }
    ];

    // --- Firebase auth + data ---
    let currentUser = null;
    auth.onAuthStateChanged(user => {
      currentUser = user;
      renderThreads();
    });

    // --- Skapa ny tråd ---
    document.getElementById("createThreadForm").onsubmit = async e => {
      e.preventDefault();
      if (!currentUser) return alert(t("needLogin"));
      const title = document.getElementById("threadTitle").value.trim();
      const desc = document.getElementById("threadDesc").value.trim();
      if (!title) return alert(t("threadTitlePlaceholder"));
      await db.collection("threads").add({
        title, description: desc,
        creatorUid: currentUser.uid,
        timestamp: new Date(),
        reactions: {},
      });
      document.getElementById("threadTitle").value = "";
      document.getElementById("threadDesc").value = "";
      renderThreads();
    };

    // --- Rendera trådar ---
    async function renderThreads() {
      const list = document.getElementById("threadList");
      list.innerHTML = "<div style='text-align:center; color:#888;'>Laddar...</div>";
      const query = await db.collection("threads").orderBy("timestamp", "desc").get();
      list.innerHTML = "";
      if (query.empty) {
        list.innerHTML = "<div style='text-align:center; color:#666; font-size:1.25em;'>"+(lang=="sv"?"Inga trådar än. Skapa en!":"No threads yet. Create one!")+"</div>";
      }
      query.forEach(doc => {
        const data = doc.data();
        const id = doc.id;
        // Räkna reaktioner
        const reactions = data.reactions || {};
        const counts = {};
        for (const uid in reactions) {
          const reaction = reactions[uid];
          counts[reaction] = (counts[reaction] || 0) + 1;
        }
        // Tråd div
        const div = document.createElement("div");
        div.className = "thread-item";
        div.innerHTML = `
          <div class="thread-title">${data.title}</div>
          <div class="thread-desc">${data.description||""}</div>
          <div class="reactions-bar" style="margin-bottom:12px;">
            ${REACTIONS.map(r => `
              <button class="reaction-btn${reactions[currentUser?.uid] === r.key ? " selected" : ""}" 
                data-thread="${id}" data-reaction="${r.key}" title="${r.emoji}">
                ${r.emoji}<span class="reaction-count">${counts[r.key] ? counts[r.key] : ""}</span>
              </button>
            `).join("")}
            ${currentUser && data.creatorUid === currentUser.uid
              ? `<button class="delete-thread-btn" data-thread="${id}">${t("delete")}</button>`
              : ""}
          </div>
          <div class="post-section" id="posts-${id}">
            <div class="add-post-form" style="margin-bottom:8px;">
              ${currentUser ? `
                <textarea class="add-post-input" rows="2" placeholder="${t("postPlaceholder")}"></textarea>
                <button class="add-post-btn" data-thread="${id}">${t("addPostBtn")}</button>
              ` : `<div style="color:#bbb; margin-bottom:9px;">${t("loginToPost")}</div>`}
            </div>
            <div class="posts-list"></div>
          </div>
        `;
        list.appendChild(div);
        // Ladda inlägg för tråden
        loadPosts(id, div.querySelector('.posts-list'));
      });
      addReactionsListeners();
      addPostListeners();
      addDeleteThreadListeners();
    }

    // --- Reaktioner på tråd ---
    function addReactionsListeners() {
      document.querySelectorAll(".reaction-btn").forEach(btn => {
        btn.onclick = async function() {
          if (!currentUser) return alert(t("needLogin"));
          const threadId = this.getAttribute("data-thread");
          const reaction = this.getAttribute("data-reaction");
          const ref = db.collection("threads").doc(threadId);
          const snap = await ref.get();
          let reactions = snap.data().reactions || {};
          if (reactions[currentUser.uid] === reaction) {
            delete reactions[currentUser.uid];
          } else {
            reactions[currentUser.uid] = reaction;
          }
          await ref.update({ reactions });
          renderThreads();
        };
      });
    }

    // --- Ta bort tråd ---
    function addDeleteThreadListeners() {
      document.querySelectorAll(".delete-thread-btn").forEach(btn => {
        btn.onclick = async function() {
          if (!confirm(t("confirmDelete"))) return;
          const threadId = this.getAttribute("data-thread");
          await db.collection("threads").doc(threadId).delete();
          renderThreads();
        };
      });
    }

    // --- Lägga upp inlägg i tråd ---
    function addPostListeners() {
      document.querySelectorAll(".add-post-btn").forEach(btn => {
        btn.onclick = async function() {
          const threadId = btn.getAttribute("data-thread");
          const textarea = btn.parentElement.querySelector(".add-post-input");
          const text = textarea.value.trim();
          if (!text) return;
          if (!currentUser) return alert(t("needLogin"));
          await db.collection("threads").doc(threadId)
            .collection("posts").add({
              text, creatorUid: currentUser.uid, timestamp: new Date(),
              reactions: {}
            });
          textarea.value = "";
          loadPosts(threadId, btn.closest(".post-section").querySelector(".posts-list"));
        };
      });
    }

    // --- Ladda inlägg (och rendera) ---
    async function loadPosts(threadId, container) {
      container.innerHTML = "<div style='text-align:center; color:#888;'>Laddar...</div>";
      const postsQuery = await db.collection("threads").doc(threadId)
        .collection("posts").orderBy("timestamp", "asc").get();
      container.innerHTML = "";
      postsQuery.forEach(postDoc => {
        const data = postDoc.data();
        const postId = postDoc.id;
        container.appendChild(renderPost(threadId, postId, data, 0));
      });
    }

    // --- Rendera inlägg + kommentarer (rekursivt, obegränsat djup) ---
    function renderPost(threadId, postId, data, level) {
      const reactions = data.reactions || {};
      const counts = {};
      for (const uid in reactions) {
        const reaction = reactions[uid];
        counts[reaction] = (counts[reaction] || 0) + 1;
      }
      // Inläggs-div
      const postDiv = document.createElement("div");
      postDiv.className = "forum-post" + (level > 0 ? " forum-comment" : "");
      postDiv.style.marginLeft = (level * 30) + "px";
      postDiv.innerHTML = `
        <div class="post-content" style="padding-bottom:6px;">${escapeHtml(data.text)}</div>
        <div class="reactions-bar">
          ${REACTIONS.map(r => `
            <button class="reaction-btn${reactions[currentUser?.uid] === r.key ? " selected" : ""}" 
              data-thread="${threadId}" data-post="${postId}" data-reaction="${r.key}" title="${r.emoji}">
              ${r.emoji}<span class="reaction-count">${counts[r.key] ? counts[r.key] : ""}</span>
            </button>
          `).join("")}
          ${currentUser && data.creatorUid === currentUser.uid
            ? `<button class="delete-post-btn" data-thread="${threadId}" data-post="${postId}">${t("delete")}</button>`
            : ""}
          <button class="reply-btn" data-thread="${threadId}" data-post="${postId}">${t("reply")}</button>
        </div>
        <div class="reply-form" style="display:none;">
          <textarea rows="2" class="reply-input" placeholder="${t("commentPlaceholder")}"></textarea>
          <button class="add-reply-btn" data-thread="${threadId}" data-post="${postId}">${t("addCommentBtn")}</button>
        </div>
        <div class="comments-list"></div>
      `;
      // --- Kommentarer ---
      loadComments(threadId, postId, postDiv.querySelector(".comments-list"), level + 1);

      // --- Svara/visa svar ---
      const replyBtn = postDiv.querySelector(".reply-btn");
      replyBtn.onclick = function() {
        const replyForm = postDiv.querySelector(".reply-form");
        replyForm.style.display = replyForm.style.display === "none" ? "" : "none";
      };
      postDiv.querySelector(".add-reply-btn").onclick = async function() {
        const replyInput = postDiv.querySelector(".reply-input");
        const text = replyInput.value.trim();
        if (!text) return;
        if (!currentUser) return alert(t("needLogin"));
        await db.collection("threads").doc(threadId)
          .collection("posts").doc(postId).collection("comments")
          .add({
            text, creatorUid: currentUser.uid, timestamp: new Date(), reactions: {}
          });
        replyInput.value = "";
        loadComments(threadId, postId, postDiv.querySelector(".comments-list"), level + 1);
      };

      // --- Reaktioner på inlägg ---
      postDiv.querySelectorAll(".reaction-btn").forEach(btn => {
        btn.onclick = async function() {
          if (!currentUser) return alert(t("needLogin"));
          const postId = btn.getAttribute("data-post");
          const threadId = btn.getAttribute("data-thread");
          const reaction = btn.getAttribute("data-reaction");
          let ref = db.collection("threads").doc(threadId).collection("posts").doc(postId);
          if (level > 0) {
            // Kommentarsnivå
            const parentIds = postDiv.parentElement.closest('.forum-post')?.dataset || {};
            ref = db.collection("threads").doc(threadId)
              .collection("posts").doc(parentIds.postId)
              .collection("comments").doc(postId);
          }
          const snap = await ref.get();
          let reactions = snap.data().reactions || {};
          if (reactions[currentUser.uid] === reaction) {
            delete reactions[currentUser.uid];
          } else {
            reactions[currentUser.uid] = reaction;
          }
          await ref.update({ reactions });
          renderThreads();
        };
      });

      // --- Ta bort inlägg/kommentar ---
      if (postDiv.querySelector(".delete-post-btn")) {
        postDiv.querySelector(".delete-post-btn").onclick = async function() {
          if (!confirm(t("confirmDelete"))) return;
          if (level === 0) {
            await db.collection("threads").doc(threadId).collection("posts").doc(postId).delete();
            renderThreads();
          } else {
            const parentIds = postDiv.parentElement.closest('.forum-post')?.dataset || {};
            await db.collection("threads").doc(threadId)
              .collection("posts").doc(parentIds.postId)
              .collection("comments").doc(postId).delete();
            renderThreads();
          }
        };
      }
      postDiv.dataset.postId = postId; // För nested

      return postDiv;
    }

    // --- Ladda kommentarer (obegränsat djup) ---
    async function loadComments(threadId, parentPostId, container, level) {
      container.innerHTML = "";
      const commentsQuery = await db.collection("threads").doc(threadId)
        .collection("posts").doc(parentPostId)
        .collection("comments").orderBy("timestamp", "asc").get();
      commentsQuery.forEach(commentDoc => {
        const data = commentDoc.data();
        const commentId = commentDoc.id;
        container.appendChild(renderPost(threadId, commentId, data, level));
      });
    }

    // --- Helper: escape HTML ---
    function escapeHtml(text) {
      return text.replace(/[&<>"'`]/g, function (m) {
        return ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;',
          '"': '&quot;', "'": '&#39;', '`': '&#96;'
        })[m];
      });
    }
  </script>
</body>
</html>
