<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="profile_title">Min Profil ‚Äì GhostGrid</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background-color: black;
      color: #00ff00;
      font-family: 'Courier New', monospace;
      margin: 0; padding: 0;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh; padding-top: 100px;
    }
    .hidden { display: none !important; }
    nav.navbar { background-color: #000; border-bottom: 2px solid #00ffcc; padding: 12px 40px; position: fixed; width: 100%; top: 0; z-index: 1000; box-shadow: 0 0 20px #bb00ff; display: flex; justify-content: center; }
    .nav-content { display: flex; align-items: center; flex-wrap: wrap; gap: 25px; justify-content: center; }
    .nav-content a { color: white; text-decoration: none; font-size: 1.5em; padding: 6px 10px; border-radius: 4px; text-shadow: 0 0 8px #00ffcc, 0 0 6px #bb00ff; transition: 0.3s;}
    .nav-content a:hover { background-color: #00ffcc; color: #000; box-shadow: 0 0 10px #ffffff; }
    .hamburger { display: none; flex-direction: column; justify-content: center; cursor: pointer; margin-left: 12px;}
    .hamburger span { width: 29px; height: 4px; background: #00ffcc; margin: 4px 0; border-radius: 2px; transition: 0.3s;}
    @media (max-width: 700px) {
      .nav-content { display: none; flex-direction: column; position: fixed; left: 0; right: 0; top: 60px; background: #181f26; box-shadow: 0 4px 28px #00ffcc77; z-index: 1101; padding-bottom: 20px; gap: 0; }
      .nav-content.show { display: flex; }
      .nav-content a { padding: 18px 10px; font-size: 1.15em; width: 100vw; border-radius: 0; text-align: center; border-bottom: 1px solid #3fffd966; }
      .hamburger { display: flex; }
    }
    .login-container { background: rgba(0, 0, 0, 0.7); padding: 30px; border: 2px solid #00ff00; border-radius: 10px; text-align: center; box-shadow: 0 0 15px #00ff00; max-width: 90%; width: 400px; }
    textarea, input[type="file"], select, input[type="text"] { width: 100%; padding: 10px; background-color: black; color: #00ff00; border: 1px solid #00ff00; border-radius: 5px; font-family: 'Courier New', monospace; margin-bottom: 14px;}
    button { margin-top: 15px; padding: 12px 20px; font-size: 1em; color: black; background-color: #00ff00; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #00cc00; }
    #fullscreenPreview { position: fixed; inset: 0; background-color: black; z-index: 9999; color: white; overflow: auto; padding: 20px; }
    #profileContent { margin-top: 60px; }
    #exitPreviewBtn { position: fixed; top: 20px; right: 20px; background-color: #00ff00; color: black; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
    #exitPreviewBtn:hover { background-color: #00cc00; }
    #profilePicNotice { color: #00ff00; margin-top: 6px; min-height: 24px; font-size: 1.06em;}
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="hamburger" id="hamburgerBtn" aria-label="Meny" tabindex="0">
      <span></span><span></span><span></span>
    </div>
    <div class="nav-content" id="navMenu">
      <a href="forum.html" data-i18n="forum">Forum</a>
      <a href="store.html" data-i18n="store">Butik</a>
      <a href="wall.html" data-i18n="wall">V√§ggen</a>
      <a href="upload.html" data-i18n="upload">Ladda upp</a>
      <a href="profile.html" data-i18n="profile">Profil</a>
      <a href="friends.html" data-i18n="friends">V√§nner</a>
    </div>
  </nav>

  <div class="login-container">
    <h2 id="header-txt">Redigera din profil</h2>
    <p id="profile-email">E-post:</p>
    <div style="margin-bottom:14px; text-align:left;">
      <label for="nickname" id="label-nickname">Smeknamn/anv√§ndarnamn:</label>
      <input type="text" id="nickname" maxlength="24" placeholder="V√§lj ditt smeknamn">
      <button id="saveNicknameBtn" type="button">Spara smeknamn</button>
      <div id="nicknameStatus" style="color:#ff8888; margin:6px 0 0 0; min-height:18px"></div>
    </div>
    <label for="profile-pic" id="label-pic">Ladda upp profilbild:</label>
    <input type="file" id="profile-pic" accept="image/*" />
    <button id="saveProfilePicBtn" type="button">Spara profilbild</button>
    <div id="profilePicNotice"></div>

    <!-- Temav√§ljare -->
    <label for="theme" id="label-theme">V√§lj profiltema:</label>
    <select id="theme"></select>

    <label for="custom-code" id="label-customcode">Profilkod (HTML/CSS):</label>
    <textarea id="custom-code" rows="10" placeholder="Skriv eller klistra in din egen HTML/CSS h√§r..."></textarea>

    <button id="saveBtn">Spara kod</button>
    <button onclick="goToProfileView()" id="btn-view-profile">Visa profil</button>
    <button id="editProfileBtn" class="hidden">Redigera profil</button>

    <div id="saveNotice" style="display:none; color:#00ff00; margin-top:10px;">
      ‚úÖ Profil sparad!
    </div>

    <p style="margin-top: 20px;"><a href="#" id="logoutLink">Logga ut</a></p>
  </div>

  <div id="fullscreenPreview" class="hidden">
    <button id="exitPreviewBtn">Redigera profil</button>
    <div id="profileContent"></div>
  </div>

  <script type="module">
    import { auth, db, storage } from './scripts/firebase-init.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { doc, setDoc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

    // Spr√•kfix
    const lang = localStorage.getItem("lang") === "en" ? "en" : "sv";

    // Meny
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const navMenu = document.getElementById('navMenu');
    hamburgerBtn.addEventListener('click', function() {
      navMenu.classList.toggle('show');
    });
    navMenu.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        navMenu.classList.remove('show');
      });
    });

    // ------ PROFILTEMPLATES --------
    const themeTemplates = {
      custom: "",
      "50s": `<div style="background: linear-gradient(135deg, #ffe3ea 0%, #ffeabf 100%); border-radius: 30px; padding: 44px 28px 38px 28px; margin: 40px auto 0 auto; max-width: 950px; box-shadow: 0 0 80px #ff8cce88, 0 0 12px #00d7ff66; font-family: 'Fira Mono', 'Share Tech Mono', 'Courier New', monospace; min-height: 85vh; display: flex; flex-direction: column; justify-content: center; position: relative;">
        <div style="display: flex; align-items: center; gap: 24px;">
          <img src='https://cdn.pixabay.com/photo/2013/07/13/13/41/jukebox-161885_1280.png' alt="Jukebox" style="width:72px; height:72px; border-radius:15px; background:#ffeabf; border: 2.5px solid #f8549a; box-shadow: 0 0 18px #ff8cce;">
          <div>
            <div style="font-size:1.95em; color:#f8549a; font-family:'Pacifico', cursive, monospace; letter-spacing:1.2px;">
              <span style="color:#00baff">Alias:</span>
              <span style="color:#f8549a;">{{smeknamn}}</span>
            </div>
            <div style="font-size:1.13em; color:#2d2d2d; margin-top:8px; font-family:'Share Tech Mono', monospace;">
              Retro√§lskare & v√§n av vinyl, milkshake och dansgolv
            </div>
          </div>
        </div>
        <div style="margin:30px 0 0 8px; line-height:1.66; color:#402a3c; font-size:1.11em; background:rgba(255,255,255,0.78); border-radius:16px; box-shadow:0 0 12px #ffd2d2cc; padding:20px 30px 24px 22px;">
          <b style="color:#f8549a;">Vem √§r {{smeknamn}}?</b><br>
          <span style="color:#ff0080">
            H√§r hittar du en riktig 50-talsentusiast med f√∂rk√§rlek f√∂r rock'n'roll, pasteller och jukeboxens ljuva toner. Lever f√∂r milkshakes, dans och stj√§rnklara sommarkv√§llar p√• en amerikansk diner.
          </span>
          <br><br>
          <b style="color:#00baff;">Favoriter:</b><br>
          üçî Hamburgare<br>
          ü•§ Milkshake (jordgubb, s√•klart!)<br>
          üé∂ Sockhop, jukebox & vinyl<br><br>
          <span style="color:#fff;background:#00baff;padding:7px 13px 7px 13px;border-radius:9px;display:inline-block;font-size:1em; box-shadow:0 0 7px #00baff99;">
            H√§r √§r alla v√§lkomna ‚Äì s√• l√§nge du gillar glada toner, respekt och en gnutta nostalgi!
          </span>
          <br><br>
          <b style="color:#f8549a;">Citat:</b><br>
          <span style="color:#00baff;">"Varje dag √§r en chans till en extra k√∂rsb√§r p√• toppen!"</span><br>
          <span style="color:#f8549a;">#JukeboxLife #RetroSoul #DansP√•Golvet</span>
        </div>
        <div style="margin-top:40px; display:flex; align-items:center; gap:20px; justify-content:center;">
          <img src="https://cdn.pixabay.com/photo/2012/04/01/17/01/beverage-23703_1280.png" alt="Milkshake" style="width:54px;height:54px;filter:drop-shadow(0 0 12px #fff3);">
          <span style="font-size:1.25em;color:#f8549a;font-family:'Pacifico',cursive;">Let's twist!</span>
          <span style="font-size:2em;color:#ffe500;text-shadow:0 0 8px #fffa;">‚òÖ ‚òÖ ‚òÖ</span>
        </div>
        <div style="margin-top:18px;text-align:center;font-size:1em;color:#bbb;">Din 50-talsprofil &copy; <span style="color:#00baff">GhostGrid</span></div>
      </div>`,
      "60s": `<div style="background:#c1e1c1; border-radius:20px; padding:24px; text-align:center;">
        <h2 style="color:#ff8800;font-family:'Dancing Script',cursive;font-size:2em;">‚úåÔ∏è 60-talets Frihetsdr√∂m</h2>
        <p style="color:#333;">Flower power, fred & musik!</p>
      </div>`,
      "70s": `<div style="background:#fcfbb6; border-radius:20px; padding:24px; text-align:center;">
        <h2 style="color:#bb8800;font-family:'Permanent Marker',cursive;font-size:2em;">üåº 70-tals Groove</h2>
        <p style="color:#884400;">Disco, peace & flower power!</p>
      </div>`,
      "80s": `<div style="background:#cdf0ff; border-radius:20px; padding:24px; text-align:center;">
        <h2 style="color:#ff44ee;font-family:'Monoton',cursive;font-size:2em;">üïπÔ∏è 80-tals Neon</h2>
        <p style="color:#0033aa;">Synthwave, pastell & axelvaddar!</p>
      </div>`,
      "90s": `<div style="background:#ffe9f9; border-radius:20px; padding:24px; text-align:center;">
        <h2 style="color:#0055bb;font-family:'Comic Sans MS',cursive;">üìü 90-tals Kid</h2>
        <p style="color:#333;">Gameboy, f√§rgsprak & pogs!</p>
      </div>`,
      "y2k": `<div style="background:#f2faff; border-radius:20px; padding:24px; text-align:center;">
        <h2 style="color:#ff22dd;font-family:'Orbitron',sans-serif;">üíæ Y2K Millennium</h2>
        <p style="color:#444;">Tech, metallic & bling bling!</p>
      </div>`,
      "2010s": `<div style="background:#e2f2ff; border-radius:20px; padding:24px; text-align:center;">
        <h2 style="color:#1b8cff;font-family:'Segoe Script',cursive;">üì± 2010-talet</h2>
        <p style="color:#333;">Instagram, memes, hipsterkaffe & festivaler.</p>
      </div>`,
      "2020s": `<div style="background:#181c21; border-radius:20px; padding:24px; text-align:center;">
        <h2 style="color:#0ff;font-family:'Courier New',monospace;">üåç 2020-talet</h2>
        <p style="color:#fff;">TikTok, AI, pandemi & digital frihet.</p>
      </div>`,
      goth: `<div style="background:#171717;color:#ba00d3;border-radius:16px;padding:15px;text-align:center;"><h2>Goth</h2><p>M√∂rker, mystik & svart l√§der.</p></div>`,
      emo: `<div style="background:#333;color:#fe52a0;border-radius:16px;padding:15px;text-align:center;"><h2>Emo</h2><p>Feeling all the feels.</p></div>`,
      vampyr: `<div style="background:#2d0012;color:#ff0038;border-radius:16px;padding:15px;text-align:center;"><h2>Vampyr</h2><p>Evigt nattliv.</p></div>`,
      metalhead: `<div style="background:#19191a;color:#d8d8d8;border-radius:16px;padding:15px;text-align:center;"><h2>Metalhead</h2><p>L√•ngt h√•r, nitar & h√∂ga riff.</p></div>`,
      h√•rdrockare: `<div style="background:#212121;color:#c00;border-radius:16px;padding:15px;text-align:center;"><h2>H√•rdrockare</h2><p>Skinnjacka & elgitarr.</p></div>`,
      skate: `<div style="background:#d7faff;color:#0d3d7f;border-radius:16px;padding:15px;text-align:center;"><h2>Skate</h2><p>Br√§dor, ramper & street style.</p></div>`,
      gamer: `<div style="background:#222233;color:#55ccff;border-radius:16px;padding:15px;text-align:center;"><h2>Gamer</h2><p>Game on! ‚å®Ô∏èüéÆ</p></div>`,
      anime: `<div style="background:#ffe6f7;color:#c800b0;border-radius:16px;padding:15px;text-align:center;"><h2>Anime</h2><p>Kawaii, cosplay & manga.</p></div>`,
      steampunk: `<div style="background:#453122;color:#fcd35f;border-radius:16px;padding:15px;text-align:center;"><h2>Steampunk</h2><p>M√§ssing, kugghjul & vintage tech.</p></div>`,
      boho: `<div style="background:#faf6e6;color:#a87328;border-radius:16px;padding:15px;text-align:center;"><h2>Boho</h2><p>Fransar, jordn√§ra f√§rger & fri sj√§l.</p></div>`,
      raggare: `<div style="background:#233232;color:#faf211;border-radius:16px;padding:15px;text-align:center;"><h2>Raggare</h2><p>V8, jeansjacka & bilar fr√•n f√∂rr.</p></div>`,
      rockabilly: `<div style="background:#ffedec;color:#d41039;border-radius:16px;padding:15px;text-align:center;"><h2>Rockabilly</h2><p>Pompadour, prickigt & rock'n'roll.</p></div>`,
      streetracer: `<div style="background:#191919;color:#00fdff;border-radius:16px;padding:15px;text-align:center;"><h2>Streetracer</h2><p>Turbo, neon & snabba n√§tter.</p></div>`,
      nerd: `<div style="background:#f5f5ff;color:#3a0088;border-radius:16px;padding:15px;text-align:center;"><h2>N√∂rd</h2><p>Kod, spel & fun facts!</p></div>`,
      fitness: `<div style="background:#e2ffe2;color:#18c700;border-radius:16px;padding:15px;text-align:center;"><h2>Tr√§ningsprofil</h2><p>Stark kropp, stark sj√§l.</p></div>`,
      urbanexplorer: `<div style="background:#313c44;color:#62d0d9;border-radius:16px;padding:15px;text-align:center;"><h2>Urban Explorer</h2><p>St√§der, ruiner & √§ventyr.</p></div>`,
      fantasy: `<div style="background:#dfd3ff;color:#6a32b5;border-radius:16px;padding:15px;text-align:center;"><h2>Fantasy</h2><p>Drakar, magi & √§ventyr.</p></div>`,
      vintage: `<div style="background:#f9f4e2;color:#a1814c;border-radius:16px;padding:15px;text-align:center;"><h2>Vintage</h2><p>Oldschool vibes.</p></div>`,
      retro: `<div style="background:#ffeebb;color:#d46b00;border-radius:16px;padding:15px;text-align:center;"><h2>Retro</h2><p>80- och 90-tals k√§nsla.</p></div>`,
      streetwear: `<div style="background:#0f0f0f;color:#00ff00;border-radius:16px;padding:15px;text-align:center;"><h2>Streetwear</h2><p>Casual, cool & modern.</p></div>`,
      hacker: `<div style="background:#070707;color:#00ff99;border-radius:16px;padding:15px;text-align:center;"><h2>Hacker</h2><p>#include &lt;din v√§rld&gt; // root access granted</p></div>`,
      darkacademia: `<div style="background:#292c2f;color:#eee;border-radius:16px;padding:15px;text-align:center;"><h2>Dark Academia</h2><p>B√∂cker, mystik & klassisk stil.</p></div>`,
      pop: `<div style="background:#ffedfa;color:#d700ad;border-radius:16px;padding:15px;text-align:center;"><h2>Pop</h2><p>Catchy hooks & glitter.</p></div>`,
      hiphop: `<div style="background:#161515;color:#ffc312;border-radius:16px;padding:15px;text-align:center;"><h2>Hiphop</h2><p>Beat, flow & streetpoesi.</p></div>`,
      jazz: `<div style="background:#e4e4e4;color:#6a4a1b;border-radius:16px;padding:15px;text-align:center;"><h2>Jazz</h2><p>Sax, bl√•s & lounge.</p></div>`,
      disco: `<div style="background:#d7d0ff;color:#a637cf;border-radius:16px;padding:15px;text-align:center;"><h2>Disco</h2><p>Discokulor, glitter & groove.</p></div>`,
      metal: `<div style="background:#222;color:#bbb;border-radius:16px;padding:15px;text-align:center;"><h2>Metal</h2><p>Tungt, snabbt & h√∂gt!</p></div>`,
      edm: `<div style="background:#171717;color:#43ffa1;border-radius:16px;padding:15px;text-align:center;"><h2>EDM</h2><p>Drop the bass!</p></div>`,
      techno: `<div style="background:#000214;color:#00eaff;border-radius:16px;padding:15px;text-align:center;"><h2>Techno</h2><p>Beat, rave & puls.</p></div>`,
      house: `<div style="background:#d9fff0;color:#1cd84d;border-radius:16px;padding:15px;text-align:center;"><h2>House</h2><p>Pumpande klubbmusik.</p></div>`,
      reggae: `<div style="background:#fefcce;color:#0d9600;border-radius:16px;padding:15px;text-align:center;"><h2>Reggae</h2><p>Peace, love & vibes.</p></div>`,
      blues: `<div style="background:#dbe7ff;color:#2b3d76;border-radius:16px;padding:15px;text-align:center;"><h2>Blues</h2><p>K√§nsla, gitarr & sj√§l.</p></div>`,
      country: `<div style="background:#ffeedd;color:#c7761b;border-radius:16px;padding:15px;text-align:center;"><h2>Country</h2><p>Boots, hatt & k√§rlek.</p></div>`,
      indie: `<div style="background:#ffe2e2;color:#264586;border-radius:16px;padding:15px;text-align:center;"><h2>Indie</h2><p>Eget sound, egen v√§g.</p></div>`,
      synthwave: `<div style="background:#0e0526;color:#d600ff;border-radius:16px;padding:15px;text-align:center;"><h2>Synthwave</h2><p>Retro futurism & neon.</p></div>`,
      punk: `<div style="background:#2d2d2d;color:#f50000;border-radius:16px;padding:15px;text-align:center;"><h2>Punk</h2><p>Uppror, nitar & snabb musik.</p></div>`,
      rock: `<div style="background:#2a2020;color:#fff200;border-radius:16px;padding:15px;text-align:center;"><h2>Rock</h2><p>Riff, h√•r & scenn√§rvaro.</p></div>`,
      romantik: `<div style="background:#fff0f6;color:#b8004b;border-radius:16px;padding:15px;text-align:center;"><h2>Romantik</h2><p>K√§rlek, poesi & k√§nslor.</p></div>`
    };

    // Listor f√∂r dropdown
    const dec = { "50s":"50-tal", "60s":"60-tal", "70s":"70-tal", "80s":"80-tal", "90s":"90-tal", "y2k":"Y2K", "2010s":"2010-tal", "2020s":"2020-tal" };
    const life = { goth:"Goth", emo:"Emo", vampyr:"Vampyr", metalhead:"Metalhead", h√•rdrockare:"H√•rdrockare", skate:"Skate", gamer:"Gamer", anime:"Anime", steampunk:"Steampunk", boho:"Boho", raggare:"Raggare", rockabilly:"Rockabilly", streetracer:"Streetracer", nerd:"N√∂rd", fitness:"Tr√§ningsprofil", urbanexplorer:"Urban Explorer", fantasy:"Fantasy", vintage:"Vintage", retro:"Retro", streetwear:"Streetwear", hacker:"Hacker", darkacademia:"Dark Academia" };
    const music = { pop:"Pop", hiphop:"Hiphop", jazz:"Jazz", disco:"Disco", metal:"Metal", edm:"EDM", techno:"Techno", house:"House", reggae:"Reggae", blues:"Blues", country:"Country", indie:"Indie", synthwave:"Synthwave", punk:"Punk", rock:"Rock", romantik:"Romantik" };

    // Teman i dropdown
    const themeSelect = document.getElementById("theme");
    themeSelect.innerHTML = "";
    themeSelect.appendChild(new Option(lang === "en" ? "Custom code (advanced!)" : "Egen kod (avancerat!)", "custom"));
    Object.keys(dec).forEach(key => themeSelect.appendChild(new Option(dec[key], key)));
    Object.keys(life).forEach(key => themeSelect.appendChild(new Option(life[key], key)));
    Object.keys(music).forEach(key => themeSelect.appendChild(new Option(music[key], key)));

    // Temabyte => kod
    themeSelect.addEventListener('change', function(e) {
      document.getElementById('custom-code').value = themeTemplates[e.target.value] || "";
    });

    // ---------- LOGIK OCH SPARA -----------
    let currentUser = null;
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        document.getElementById('profile-email').innerText = (lang === "en" ? "Email:" : "E-post:") + " " + (user.email || "");
        const snap = await getDoc(doc(db, "profiles", user.uid));
        if (snap.exists()) {
          const data = snap.data();
          document.getElementById('nickname').value = data.nickname || '';
          if (data.profileTheme) themeSelect.value = data.profileTheme;
          document.getElementById('custom-code').value = data.profileCode || '';
        }
      }
    });

    // Spara smeknamn
    document.getElementById('saveNicknameBtn').onclick = async () => {
      if (!currentUser) return alert(lang === "en" ? "You are not logged in." : "Du √§r inte inloggad.");
      const newNick = document.getElementById('nickname').value.trim();
      if (!newNick) {
        document.getElementById('nicknameStatus').textContent = lang === "en" ? "You must enter a nickname." : "Du m√•ste ange ett smeknamn.";
        return;
      }
      const q = query(collection(db, "profiles"), where("nickname", "==", newNick));
      const snap = await getDocs(q);
      let taken = false;
      snap.forEach(docu => { if (docu.id !== currentUser.uid) taken = true; });
      if (taken) {
        document.getElementById('nicknameStatus').textContent = lang === "en" ? "Nickname is already taken!" : "Smeknamnet √§r upptaget!";
        return;
      }
      await setDoc(doc(db, "profiles", currentUser.uid), { nickname: newNick }, { merge: true });
      document.getElementById('nicknameStatus').style.color = "#00ff00";
      document.getElementById('nicknameStatus').textContent = lang === "en" ? "Nickname saved!" : "Smeknamn sparat!";
      setTimeout(() => { document.getElementById('nicknameStatus').textContent = ""; }, 2500);
    };

    // Spara kod/tema
    document.getElementById('saveBtn').onclick = async () => {
      if (!currentUser) return;
      await setDoc(doc(db, "profiles", currentUser.uid), {
        profileCode: document.getElementById('custom-code').value,
        profileTheme: themeSelect.value
      }, { merge: true });
      document.getElementById('saveNotice').style.display = "block";
      setTimeout(() => document.getElementById('saveNotice').style.display = "none", 3000);
    };

    // Spara profilbild
    document.getElementById('saveProfilePicBtn').onclick = async () => {
      const profilePicInput = document.getElementById('profile-pic');
      const notice = document.getElementById('profilePicNotice');
      if (!currentUser) {
        notice.textContent = "Du √§r inte inloggad.";
        return;
      }
      const file = profilePicInput.files[0];
      if (!file) {
        notice.textContent = "Ingen bild vald.";
        return;
      }
      try {
        const storageRef = ref(storage, `profile_pics/${currentUser.uid}/${file.name}`);
        await uploadBytes(storageRef, file);
        const downloadUrl = await getDownloadURL(storageRef);
        await setDoc(doc(db, "profiles", currentUser.uid), {
          profilePic: downloadUrl
        }, { merge: true });
        notice.textContent = "Profilbild uppladdad!";
        setTimeout(() => notice.textContent = "", 2500);
      } catch (err) {
        notice.textContent = "Fel vid uppladdning.";
      }
    };

    // Visa profil
    window.goToProfileView = function() {
      if (!currentUser) return alert(lang === "en" ? "You are not logged in." : "Du √§r inte inloggad.");
      window.location.href = `profile-view.html?uid=${currentUser.uid}`;
    };

    // Preview
    const preview = document.getElementById("fullscreenPreview");
    const profileContent = document.getElementById("profileContent");
    const editBtn = document.getElementById("editProfileBtn");
    document.getElementById('btn-view-profile').addEventListener('click', () => {
      profileContent.innerHTML = document.getElementById('custom-code').value;
      preview.classList.remove("hidden");
      editBtn.classList.remove("hidden");
    });
    editBtn.addEventListener("click", () => { preview.classList.add("hidden"); });

    // Logga ut
    document.getElementById("logoutLink").addEventListener("click", () => {
      auth.signOut().then(() => location.href = "login.html");
    });
  </script>
</body>
</html>
