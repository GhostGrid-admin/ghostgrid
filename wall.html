<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GhostGrid – Väggen</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background: #0a0a0a;
      color: #e0ffff;
      font-family: 'Courier New', monospace;
      min-height: 100vh;
      margin: 0;
      padding-top: 85px;
      position: relative;
      overflow-x: hidden;
    }
    .glow-left, .glow-right {
      position: fixed;
      top: 0;
      width: 170px;
      height: 100vh;
      pointer-events: none;
      z-index: 0;
    }
    .glow-left {
      left: 0;
      background: radial-gradient(circle at left, #d900ff 0%, #7200ffcc 40%, transparent 85%);
      box-shadow: 0 0 80px 40px #d900ffbb, 0 0 240px 80px #00ffe0aa, 0 0 400px 120px #9400ff66;
    }
    .glow-right {
      right: 0;
      background: radial-gradient(circle at right, #d900ff 0%, #7200ffcc 40%, transparent 85%);
      box-shadow: 0 0 80px 40px #d900ffbb, 0 0 240px 80px #00ffe0aa, 0 0 400px 120px #9400ff66;
    }
    .side-banner {
      position: fixed;
      top: 87px;
      bottom: 0;
      width: 170px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      z-index: 1002;
      background: none;
      pointer-events: none;
    }
    .side-banner .banner-inner {
      width: 150px;
      height: 100%;
      background: transparent;
      border-radius: 12px;
      box-shadow: 0 0 18px #7b00ff99;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: auto;
    }
    .side-banner img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
      background: #220043;
      cursor: pointer;
      transition: box-shadow 0.3s;
      box-shadow: 0 0 10px #8800ff70;
      pointer-events: auto;
      min-height: 200px;
    }
    .side-banner.left { left: 0; }
    .side-banner.right { right: 0; }
    @media (max-width: 1100px) {
      .side-banner, .glow-left, .glow-right { width: 85px; }
      .side-banner .banner-inner { width: 75px; }
    }
    @media (max-width: 900px) {
      .side-banner, .glow-left, .glow-right { display: none; }
    }
    nav.navbar {
      background-color: #000;
      border-bottom: 2px solid #00ffcc;
      padding: 0;
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      z-index: 1000;
      box-shadow: 0 0 20px #bb00ff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 60px;
      transition: top 0.3s;
    }
    .nav-center {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .nav-links {
      display: flex;
      gap: 26px;
      list-style: none;
      margin: 0 auto;
      padding: 0;
      align-items: center;
    }
    .nav-links li { display: flex; }
    .nav-links a {
      color: white;
      text-decoration: none;
      font-size: 1.2em;
      padding: 7px 10px;
      border-radius: 4px;
      text-shadow: 0 0 8px #00ffcc, 0 0 6px #bb00ff;
      transition: 0.3s;
      font-family: inherit;
    }
    .nav-links a:hover {
      background-color: #00ffcc;
      color: #000;
      box-shadow: 0 0 10px #ffffff;
    }
    .logout-btn {
      position: fixed;
      top: 12px;
      right: 12px;
      background: #000;
      color: #00ffcc;
      border: 2px solid #00ffcc;
      padding: 8px 24px 7px 24px;
      font-size: 1.1em;
      border-radius: 9px;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      box-shadow: 0 0 15px #00ffcc88, 0 0 8px #bb00ff99;
      transition: 0.18s;
      cursor: pointer;
      opacity: 0.98;
      margin: 0;
      z-index: 1500;
      display: block;
    }
    .hamburger {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 55px;
      z-index: 2002;
      background: none;
      border: none;
      cursor: pointer;
    }
    .hamburger span {
      width: 32px;
      height: 4px;
      background: #00ffcc;
      margin: 5px 0;
      border-radius: 2px;
      transition: 0.3s;
      display: block;
    }
    @media (max-width: 900px) {
      .nav-center, .logout-btn { display: none !important; }
      .hamburger { display: flex !important; }
      nav.navbar { min-height: 55px; border-bottom-width: 2px;}
    }
    .nav-mobile {
      display: none;
      flex-direction: column;
      align-items: center;
      position: absolute;
      top: 55px;
      left: 50%;
      transform: translateX(-50%);
      min-width: 220px;
      width: 92vw;
      max-width: 400px;
      background: #181f26;
      box-shadow: 0 4px 28px #00ffcc77;
      z-index: 1201;
      padding-bottom: 20px;
      border-radius: 0 0 16px 16px;
      animation: dropin 0.16s;
      text-align: center;
    }
    .nav-mobile.show { display: flex; }
    .nav-mobile a, .nav-mobile .logout-link-mobile {
      padding: 18px 0px;
      font-size: 1.15em;
      width: 100%;
      border-radius: 0;
      text-align: center;
      border-bottom: 1px solid #3fffd966;
      background: none;
      color: #00ffcc;
      font-weight: bold;
      border: none;
      box-shadow: none;
      display: block;
      margin: 0;
      font-family: inherit;
    }
    .nav-mobile .logout-link-mobile {
      cursor: pointer;
      background: none;
    }
    .nav-mobile a:last-child {
      margin-top: 8px;
      background: #000;
      color: #00ffcc;
      border-bottom: 1px solid #3fffd966;
      font-weight: bold;
    }
    .nav-mobile a:hover { background: #00ffcc; color: #000; }
    @media (max-width: 600px) {
      nav.navbar { transition: top 0.3s; }
      nav.navbar.hide-navbar { top: -70px; }
      .nav-mobile { min-width: 160px; width: 98vw; }
    }
    .wall-box {
      border: 2px solid #66ffcc;
      border-radius: 12px;
      padding: 30px 20px 22px 20px;
      margin: 36px auto 32px auto;
      max-width: 440px;
      background-color: rgba(0, 0, 0, 0.88);
      box-shadow: 0 0 15px #00ffcc33;
      position: relative;
      z-index: 2;
      min-width: 0;
    }
    @media (max-width: 700px) {
      .wall-box {
        padding: 12px 2vw 10px 2vw;
        max-width: 99vw;
      }
    }
    .wall-title { font-size: 2.4em; text-align: center; color: #f5f5f5; margin: 16px 0 28px 0; text-shadow: 0 2px 12px #222, 0 1px 0 #fff; font-weight: bold; letter-spacing: 0.04em; }
    .filter-row { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 18px;}
    .filter-btn { padding: 7px 16px; border-radius: 5px; border: 2px solid #00ffcc; background: #121e2a; color: #00ffcc; font-family: inherit; font-size: 1em; cursor: pointer; box-shadow: 0 0 8px #00ffcc66; transition: 0.2s; margin-bottom: 4px;}
    .filter-btn.active, .filter-btn:focus, .filter-btn:active { background: #00ffcc; color: #19191b; font-weight: bold; box-shadow: 0 0 12px #00ffcc; }
    .wall-search-row { display: flex; justify-content: center; margin-bottom: 10px; }
    .wall-search-row input { padding: 9px 15px; border: 2px solid #00ffcc; border-radius: 7px; background: #14181e; color: #baffff; font-size: 1.12em; box-shadow: 0 0 8px #7b00ff55; width: 96%; max-width: 370px; margin: 0 auto 7px auto;}
    .post-list { width:100%; max-width:650px; margin:24px auto;}
    .post { background: #181f26; border: 1.5px solid #66ffcc; border-radius: 9px; box-shadow: 0 0 10px #00ffcc30; margin-bottom: 24px; padding: 18px 13px; color: #e0ffff; word-break: break-word; overflow: auto; }
    .post .post-header { font-size: 1em; color: #00ffd9; margin-bottom: 6px;}
    .post .post-content { font-size: 1.19em;}
    .post .post-time { color: #9df; font-size: 0.91em; margin-top: 6px;}
    .post img, .post video, .post audio { max-width: 100%; border-radius: 7px; margin-top: 7px;}
    /* ===== EMOJI COLLAPSE ===== */
    .emoji-row-collapsed { 
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 7px 0 3px 0;
      user-select: none;
      width: fit-content;
      position: relative;
    }
    .emoji-main-btn {
      font-size: 1.3em;
      background: none;
      border: none;
      cursor: pointer;
      outline: none;
      padding: 2px 6px;
    }
    .emoji-toggle-arrow {
      font-size: 1.3em;
      margin-left: 2px;
      transition: transform 0.18s;
      display: inline-block;
      user-select: none;
      cursor: pointer;
    }
    .emoji-toggle-arrow.open { transform: rotate(90deg);}
    .emoji-popup {
      display: none;
      position: absolute;
      top: 140%;
      left: 0;
      background: #191d2b;
      border: 1.5px solid #00ffcc;
      box-shadow: 0 0 10px #00ffcc99;
      border-radius: 12px;
      padding: 8px 7px 5px 7px;
      z-index: 999;
      min-width: 180px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .emoji-popup.show { display: flex; animation: fadeIn 0.17s; }
    @keyframes fadeIn { from{ opacity:0;} to{opacity:1;} }
    .emoji-btn {
      background: none;
      border: none;
      font-size: 1.15em;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      margin: 2px 2px;
      transition: filter 0.14s, background 0.14s;
    }
    .emoji-btn.selected, .emoji-btn:hover {
      filter: brightness(1.3) drop-shadow(0 0 5px #00ffcc);
      background: #00ffcc2a;
    }
    .emoji-user-pick {
      margin-left: 6px;
      font-size: 1.24em;
      background: none;
      border: none;
      padding: 2px 6px;
      border-radius: 6px;
      outline: none;
      cursor: pointer;
      color: #0a0a0a;
      background: #00ffcc;
      font-weight: bold;
      box-shadow: 0 0 7px #00ffcc7a;
    }
    .emoji-user-pick:hover { background: #19ffc5; }
    .emoji-summary { margin-left: 9px; font-size: 1.11em; color: #00ffd9; cursor: pointer; }
    /* ========================= */
    .emoji-viewer-list {
      display: none;
      position: absolute;
      left: 0;
      top: 110%;
      z-index: 2000;
      min-width: 200px;
      background: #191d2b;
      color: #fff;
      border: 1.5px solid #00ffcc;
      border-radius: 11px;
      box-shadow: 0 0 16px #00ffcc77;
      padding: 10px 13px 7px 13px;
      font-size: 1.1em;
      text-align: left;
      max-height: 300px;
      overflow-y: auto;
    }
    .emoji-viewer-list.show { display: block; animation: fadeIn 0.15s; }
    .emoji-viewer-list .emoji-head { font-size:1.12em; font-weight:600; margin-bottom:7px; color:#00ffd9;}
    .emoji-viewer-list ul { margin: 0 0 0 12px; padding: 0; }
    .emoji-viewer-list li { margin-bottom: 2px; list-style: disc; }
    .emoji-viewer-list .emoji-key { margin-right: 6px;}
  </style>
  <!-- FIREBASE SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script>
    // -- DIN KONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyCR8q40Dc4wcfYBDlxdpOriA2e3RTmAesg",
      authDomain: "ghostgrid-fb278.firebaseapp.com",
      projectId: "ghostgrid-fb278",
      storageBucket: "ghostgrid-fb278.appspot.com",
      messagingSenderId: "283208202937",
      appId: "1:283208202937:web:11c0cea81fd81a31163968",
      measurementId: "G-B0WCKJCNT9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
  </script>
</head>
<body>
  <div class="glow-left"></div>
  <div class="glow-right"></div>
  <div class="side-banner left">
    <div class="banner-inner">
      <a id="leftBannerLink" href="#" target="_blank">
        <img id="leftBannerImg" src="https://dummyimage.com/150x1800/7b00ff/fff&text=Reklam+1" alt="Reklam" />
      </a>
    </div>
  </div>
  <div class="side-banner right">
    <div class="banner-inner">
      <a id="rightBannerLink" href="#" target="_blank">
        <img id="rightBannerImg" src="https://dummyimage.com/150x1800/222299/fff&text=Reklam+2" alt="Reklam" />
      </a>
    </div>
  </div>
<nav class="navbar">
  <div class="hamburger" id="hamburgerBtn" aria-label="Meny" tabindex="0">
    <span></span><span></span><span></span>
  </div>
  <div class="nav-center">
    <ul class="nav-links">
      <li><a href="forum.html" data-i18n="forum">Forum</a></li>
      <li><a href="wall.html" data-i18n="wall" class="active">Väggen</a></li>
      <li><a href="upload.html" data-i18n="upload">Ladda upp</a></li>
      <li><a href="profile.html" data-i18n="profile">Profil</a></li>
      <li><a href="friends.html" data-i18n="friends">Vänner</a></li>
      <li><a href="ghost&glow.html" data-i18n="ghostglow">Ghost&Glow</a></li>
      <li><a href="store.html" data-i18n="store">Butik</a></li>
    </ul>
  </div>
  <button class="logout-btn" id="logoutDesktopBtn">Logga ut</button>
  <div class="nav-mobile" id="navMobile">
    <a href="forum.html" data-i18n="forum">Forum</a>
    <a href="wall.html" data-i18n="wall" class="active">Väggen</a>
    <a href="upload.html" data-i18n="upload">Ladda upp</a>
    <a href="profile.html" data-i18n="profile">Profil</a>
    <a href="friends.html" data-i18n="friends">Vänner</a>
    <a href="ghost&glow.html" data-i18n="ghostglow">Ghost&Glow</a>
    <a href="store.html" data-i18n="store">Butik</a>
    <a href="#" class="logout-link-mobile" id="logoutMobileBtn">Logga ut</a>
  </div>
</nav>
<div class="wall-box">
  <div class="wall-title" data-i18n="wall_title">Väggen</div>
  <div class="filter-row" id="filterRow">
    <button class="filter-btn active" data-type="all" data-i18n="all">Alla</button>
    <button class="filter-btn" data-type="text" data-i18n="post">Inlägg</button>
    <button class="filter-btn" data-type="image" data-i18n="image">Bilder</button>
    <button class="filter-btn" data-type="video" data-i18n="video">Klipp</button>
    <button class="filter-btn" data-type="audio" data-i18n="audio">Ljud</button>
    <button class="filter-btn" data-type="mic" data-i18n="mic">Röst</button>
  </div>
  <div class="wall-search-row">
    <input type="text" id="wallSearchInput" autocomplete="off" placeholder="Sök i valda kategorin...">
  </div>
  <div id="postList" class="post-list"></div>
</div>
<script type="module">
// -- JS börjar här --

const translations = {
  sv: {
    forum: "Forum", store: "Butik", wall: "Väggen", upload: "Ladda upp", profile: "Profil", friends: "Vänner", ghostglow: "Ghost&Glow",
    wall_title: "Väggen",
    all: "Alla", post: "Inlägg", image: "Bilder", video: "Klipp", audio: "Ljud", mic: "Röst",
    loading: "Laddar inlägg...", no_posts: "Inga inlägg hittades.",
    user: "Användare", comment: "Kommentera", comment_placeholder: "Kommentera...", login_to_comment: "Logga in för att kommentera.",
    edit: "Redigera", delete: "Radera", save: "Spara", cancel: "Avbryt", reply: "Svara",
    guest: "Gäst", at: "kl", comment_deleted: "Kommentaren har raderats.",
    max_200: "Max 200 tecken per kommentar!", no_spam: "Du kan inte spamma!", wait: "Vänta några sekunder innan du kommenterar igen.",
    login_to_react: "Logga in för att reagera.", comment_empty: "Kommentaren får ej vara tom.", delete_confirm: "Radera kommentaren?", all_fields: "Alla fält måste fyllas i.",
    logout: "Logga ut", reacted_by: "Reagerat med"
  },
  en: {
    forum: "Forum", store: "Store", wall: "Wall", upload: "Upload", profile: "Profile", friends: "Friends", ghostglow: "Ghost&Glow",
    wall_title: "Wall",
    all: "All", post: "Posts", image: "Images", video: "Videos", audio: "Audio", mic: "Voice",
    loading: "Loading posts...", no_posts: "No posts found.",
    user: "User", comment: "Comment", comment_placeholder: "Comment...", login_to_comment: "Login to comment.",
    edit: "Edit", delete: "Delete", save: "Save", cancel: "Cancel", reply: "Reply",
    guest: "Guest", at: "at", comment_deleted: "Comment deleted.",
    max_200: "Max 200 characters per comment!", no_spam: "You can't spam!", wait: "Wait a few seconds before commenting again.",
    login_to_react: "Login to react.", comment_empty: "Comment cannot be empty.", delete_confirm: "Delete this comment?", all_fields: "All fields are required.",
    logout: "Log out", reacted_by: "Reacted by"
  }
};
function t(key) {
  const lang = localStorage.lang === "en" ? "en" : "sv";
  return translations[lang][key] || key;
}
const emojis = [
  { emoji: "❤️", key: "heart" },
  { emoji: "👍", key: "thumbsup" },
  { emoji: "😂", key: "laugh" },
  { emoji: "😃", key: "bigsmile" },
  { emoji: "🙂", key: "smile" },
  { emoji: "😇", key: "angel" },
  { emoji: "😳", key: "embarrassed" },
  { emoji: "😕", key: "confused" },
  { emoji: "🙁", key: "sad" },
  { emoji: "😢", key: "cry" },
  { emoji: "😡", key: "angry" },
  { emoji: "👎", key: "thumbsdown" },
  { emoji: "💔", key: "brokenheart" },
];

import { auth, db } from "./scripts/firebase-init.js";
import {
  collection, query, orderBy, getDocs, addDoc, updateDoc, deleteDoc, doc, setDoc
} from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

function escapeHTML(str) {
  if (!str) return "";
  return str.replace(/[<>&"]/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;' }[c]));
}
let currentUser = null;
let userMap = {};
let allPosts = [];
let searchTerm = "";
let currentFilter = "all";

// --- NAV, FILTER, LOGOUT ---
document.addEventListener("DOMContentLoaded", function() {
  const hamburgerBtn = document.getElementById('hamburgerBtn');
  const navMobile = document.getElementById('navMobile');
  if (hamburgerBtn && navMobile) {
    hamburgerBtn.addEventListener('click', function () {
      navMobile.classList.toggle('show');
    });
    navMobile.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        navMobile.classList.remove('show');
      });
    });
    const logoutBtn = document.getElementById("logoutMobileBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", function (e) {
        e.preventDefault();
        navMobile.classList.remove('show');
        doLogout();
      });
    }
  }
  // FILTER
  const filterRow = document.getElementById("filterRow");
  if (filterRow) {
    filterRow.addEventListener("click", function(e) {
      if (e.target.classList.contains("filter-btn")) {
        filterRow.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
        e.target.classList.add("active");
        currentFilter = e.target.getAttribute("data-type");
        renderPosts(currentFilter, searchTerm);
      }
    });
  }
});
function doLogout() {
  signOut(auth).then(() => { window.location.href = "login.html"; });
}
async function fetchUsers() {
  userMap = {};
  const snap = await getDocs(collection(db, "profiles"));
  snap.docs.forEach(docu => userMap[docu.id] = docu.data().nickname || docu.data().displayName || t("guest"));
}
async function loadWallPosts() { 
  const postList = document.getElementById("postList");
  postList.innerHTML = `<div style="color:#00ffcc; text-align:center;">${t("loading")}</div>`;
  await fetchUsers();
  const q = query(collection(db, "wall"), orderBy("createdAt", "desc"));
  const snapshot = await getDocs(q);
  allPosts = snapshot.docs
    .map(doc => ({ ...doc.data(), id: doc.id }))
    .filter(post => {
      if (post.type === "text") {
        return (post.text_sv && post.text_sv.trim() !== "") || (post.text_en && post.text_en.trim() !== "");
      } else if (post.type === "image") {
        return !!post.imageUrl;
      } else if (post.type === "video") {
        return !!post.videoUrl;
      } else if (post.type === "audio") {
        return !!post.audioUrl;
      } else if (post.type === "mic") {
        return !!post.micAudioUrl;
      }
      return false;
    });
  renderPosts(currentFilter, searchTerm);
}
async function loadReactions(postId) {
  const snap = await getDocs(collection(db, "wall", postId, "reactions"));
  return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
}
function emojiSummary(reactions) {
  if (!reactions || reactions.length === 0) return "";
  let counts = {};
  reactions.forEach(r => counts[r.emoji] = (counts[r.emoji] || 0) + 1);
  return Object.entries(counts).map(([k, v]) => {
    const e = emojis.find(e => e.key === k);
    return `<span class="emoji-summary-item" data-emoji="${k}">${e ? e.emoji : ""} <b>${v}</b></span>`;
  }).join(" ");
}
async function renderPosts(type, search) {
  const postList = document.getElementById("postList");
  let posts = type === "all" ? allPosts : allPosts.filter(p => p.type === type);
  if (search && search.length > 0) {
    posts = posts.filter(post => {
      const user = userMap[post.user] || "";
      return (
        (post.text_sv && post.text_sv.toLowerCase().includes(search)) ||
        (post.text_en && post.text_en.toLowerCase().includes(search)) ||
        (user.toLowerCase().includes(search))
      );
    });
  }
  if (!posts.length) {
    postList.innerHTML = `<div style='color:#00ffcc; text-align:center;'>${t("no_posts")}</div>`;
    return;
  }
  postList.innerHTML = "";
  for (let post of posts) {
    const reactions = await loadReactions(post.id);
    const userReaction = currentUser ? reactions.find(r => r.user === currentUser.uid) : null;
    let name = userMap[post.user] || t("guest");
    let canDelete = currentUser && currentUser.uid === post.user;
    postList.innerHTML += `
      <div class="post" data-postid="${post.id}">
        <div class="post-header">
          ${t("user")}: <a href="profile-view.html?uid=${post.user}" class="profile-link">${name}</a>
          ${canDelete ? `<button class="delete-post-btn" data-postid="${post.id}" style="margin-left:10px; color:#ff5d5d; background:#222; border:none; cursor:pointer;">${t("delete")}</button>` : ""}
        </div>
        <div class="post-content">
          ${
            post.type === "text"
              ? escapeHTML(post[`text_${localStorage.lang}`] || post.text || "")
              : post.type === "image"
              ? `<img src="${post.imageUrl}" alt="Bild" />`
              : post.type === "video"
              ? `<video controls src="${post.videoUrl}"></video>`
              : post.type === "audio"
              ? `<audio controls src="${post.audioUrl}"></audio>`
              : post.type === "mic"
              ? `<audio controls src="${post.micAudioUrl}"></audio>`
              : ""
          }
        </div>
        <div class="emoji-row-collapsed" data-postid="${post.id}">
          <button class="emoji-main-btn" type="button">😊</button>
          <span class="emoji-toggle-arrow">&#9654;</span>
          ${
            userReaction
              ? `<button class="emoji-user-pick" title="${t('delete_confirm')}">${emojis.find(e => e.key === userReaction.emoji)?.emoji || "❓"}</button>`
              : ""
          }
          <span class="emoji-summary">${emojiSummary(reactions)}</span>
          <div class="emoji-popup"></div>
          <div class="emoji-viewer-list"></div>
        </div>
        <div class="post-time">${post.createdAt && post.createdAt.toDate ? post.createdAt.toDate().toLocaleString(localStorage.lang === "en" ? "en-GB" : "sv-SE") : ""}</div>
      </div>`;
  }
  setupEmojiRow();
  addDeleteListeners();
}
// === EMOJI LOGIK ===
function setupEmojiRow() {
  document.querySelectorAll('.emoji-row-collapsed').forEach(row => {
    const postId = row.dataset.postid;
    const popup = row.querySelector('.emoji-popup');
    const arrow = row.querySelector('.emoji-toggle-arrow');
    const btn = row.querySelector('.emoji-main-btn');
    const viewer = row.querySelector('.emoji-viewer-list');
    if (popup.childElementCount === 0) {
      emojis.forEach(e => {
        const emojiBtn = document.createElement('button');
        emojiBtn.className = "emoji-btn";
        emojiBtn.innerText = e.emoji;
        emojiBtn.title = e.emoji;
        emojiBtn.dataset.emoji = e.key;
        emojiBtn.onclick = async function(ev) {
          ev.stopPropagation();
          if (!currentUser) return alert(t("login_to_react"));
          const ref = doc(db, "wall", postId, "reactions", currentUser.uid);
          const snap = await getDocs(collection(db, "wall", postId, "reactions"));
          const userReactionDoc = snap.docs.find(d => d.id === currentUser.uid);
          if (userReactionDoc && userReactionDoc.data().emoji === e.key) {
            await deleteDoc(ref);
          } else {
            await setDoc(ref, { emoji: e.key, user: currentUser.uid });
          }
          loadWallPosts();
        };
        popup.appendChild(emojiBtn);
      });
    }
    function togglePopup(e) {
      e.stopPropagation();
      const open = popup.classList.toggle('show');
      if (open) arrow.classList.add('open');
      else arrow.classList.remove('open');
    }
    btn.onclick = togglePopup;
    arrow.onclick = togglePopup;
    popup.onclick = e => e.stopPropagation();
    const userPick = row.querySelector('.emoji-user-pick');
    if (userPick) {
      userPick.onclick = async function(ev) {
        ev.stopPropagation();
        if (!currentUser) return;
        const ref = doc(db, "wall", postId, "reactions", currentUser.uid);
        await deleteDoc(ref);
        loadWallPosts();
      };
    }
    // ----- Visa vilka som reagerat -----
    row.querySelectorAll('.emoji-summary-item').forEach(sumBtn => {
      sumBtn.onclick = async function(ev) {
        ev.stopPropagation();
        // TOGGLE: Om redan öppen på denna emoji -> stäng!
        if (viewer.classList.contains('show') && viewer.dataset.emoji === sumBtn.dataset.emoji) {
          viewer.classList.remove('show');
          viewer.style.display = "none";
          viewer.dataset.emoji = "";
          return;
        }
        // Stäng ALLA andra öppna viewer-listor!
        document.querySelectorAll('.emoji-viewer-list.show').forEach(openViewer => {
          openViewer.classList.remove('show');
          openViewer.style.display = "none";
          openViewer.dataset.emoji = "";
        });
        // Visa och fyll denna viewer
        viewer.innerHTML = `<span class="emoji-head">${t('reacted_by')} ${emojis.find(e => e.key === sumBtn.dataset.emoji)?.emoji || ""}</span><ul></ul>`;
        viewer.classList.add('show');
        viewer.style.display = "block";
        viewer.dataset.emoji = sumBtn.dataset.emoji;
        // Hämta reaktioner på just denna emoji
        const snap = await getDocs(collection(db, "wall", postId, "reactions"));
        const reacts = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
          .filter(r => r.emoji === sumBtn.dataset.emoji);
        const ul = viewer.querySelector('ul');
        ul.innerHTML = reacts.length
          ? reacts.map(r =>
            `<li>
              <a href="profile-view.html?uid=${r.user}" class="profile-link">${userMap[r.user] || t("guest")}</a>
              <span class="emoji-key">${emojis.find(e => e.key === r.emoji)?.emoji || ""}</span>
            </li>`
            ).join("")
          : `<li style="color:#bbb;">${t('no_posts')}</li>`;
      };
    });
  }); // slut på forEach .emoji-row-collapsed
} // <-- Stänger setupEmojiRow här!
                                                            
// ---- DELETE KNAPP ----
function addDeleteListeners() {
  document.querySelectorAll(".delete-post-btn").forEach(btn => {
    btn.onclick = async function(e) {
      e.preventDefault();
      const postId = this.dataset.postid;
      if (confirm(t("delete_confirm"))) {
        await deleteDoc(doc(db, "wall", postId));
        loadWallPosts();
      }
    };
  });
}
// ---- Språk & auth ----
function applyTranslations() {
  document.querySelectorAll("[data-i18n]").forEach(el => { el.textContent = t(el.getAttribute("data-i18n")); });
  document.title = "GhostGrid – " + t("wall");
  document.querySelector(".wall-title").textContent = t("wall_title");
  document.getElementById("wallSearchInput").placeholder = localStorage.lang === "en" ? "Search selected category..." : "Sök i valda kategorin...";
  document.getElementById("logoutDesktopBtn").textContent = t("logout") || "Logga ut";
  document.getElementById("logoutMobileBtn").textContent = t("logout") || "Logga ut";
}
// ---- SÖK & AUTH STATE ----
onAuthStateChanged(auth, user => {
  currentUser = user;
  applyTranslations();
  loadWallPosts();
  document.getElementById("logoutDesktopBtn").onclick = doLogout;
  document.getElementById("logoutMobileBtn").onclick = doLogout;
  document.getElementById("wallSearchInput").addEventListener("input", function () {
    searchTerm = this.value.toLowerCase().trim();
    renderPosts(currentFilter, searchTerm);
  });
});

document.addEventListener('click', function() { 
  document.querySelectorAll('.emoji-popup').forEach(popup => popup.classList.remove('show'));
  document.querySelectorAll('.emoji-toggle-arrow').forEach(arrow => arrow.classList.remove('open'));
  document.querySelectorAll('.emoji-viewer-list').forEach(viewer => {
    viewer.classList.remove('show');
    viewer.style.display = "none";
    viewer.dataset.emoji = "";
  });
});
    
</script>
</body>
</html>
