<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GhostGrid ‚Äì Ladda upp</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* --- (Samma CSS som du redan har ‚Äì klippt f√∂r √∂versiktlighet, men ta med hela!) --- */
    body {
      background: #0a0a0a;
      color: #e0ffff;
      font-family: 'Courier New', monospace;
      min-height: 100vh;
      margin: 0;
      padding-top: 85px;
      position: relative;
      overflow-x: hidden;
    }
    /* ... (resten av din CSS √§r identisk med det du postat ovan!) ... */
    .upload-section { display: none; }
    .upload-section.active { display: block; }
    .post { background:#191933; margin-bottom:18px; padding:18px 12px 12px 12px; border-radius:9px; border-left:4px solid #00ffcc; box-shadow:0 0 10px #4ef2ff18; }
    .delete-post-btn { background:#d62e6e; border:none; color:white; border-radius:7px; padding:3px 15px; font-size:1em; margin-top:11px; margin-bottom:2px; cursor:pointer; float:right; }
    .delete-post-btn:hover { background:#a50044; }
  </style>
</head>
<body>
  <div class="glow-left"></div>
  <div class="glow-right"></div>
  <!-- V√§nster sidbanner -->
  <div class="side-banner left">
    <div class="banner-inner">
      <a id="leftBannerLink" href="#" target="_blank">
        <img id="leftBannerImg" src="https://dummyimage.com/120x1800/7b00ff/fff&text=Reklam+1" alt="Reklam" />
      </a>
    </div>
  </div>
  <!-- H√∂ger sidbanner -->
  <div class="side-banner right">
    <div class="banner-inner">
      <a id="rightBannerLink" href="#" target="_blank">
        <img id="rightBannerImg" src="https://dummyimage.com/120x1800/222299/fff&text=Reklam+2" alt="Reklam" />
      </a>
    </div>
  </div>
  <nav class="navbar">
    <div class="hamburger" id="hamburgerBtn" aria-label="Meny" tabindex="0">
      <span></span><span></span><span></span>
    </div>
    <div class="nav-content" id="navMenu">
      <a href="forum.html">Forum</a>
      <a href="store.html">Store</a>
      <a href="wall.html">V√§ggen</a>
      <a href="upload.html">Ladda upp</a>
      <a href="profile.html">Profil</a>
      <a href="friends.html">V√§nner</a>
      <div class="search-container">
        <input type="text" placeholder="S√∂k p√• hela sidan..." id="searchInput" />
      </div>
    </div>
  </nav>
  <div class="upload-box" id="uploadBox">
    <div class="upload-title">Ladda upp inneh√•ll</div>
    <img id="spinner" src="spinner-asg.png" alt="Laddar..." />
    <div class="upload-switcher">
      <button class="switch-btn active" data-section="text">üìù Inl√§gg</button>
      <button class="switch-btn" data-section="image">üñºÔ∏è Bild</button>
      <button class="switch-btn" data-section="video">üé¨ Klipp</button>
      <button class="switch-btn" data-section="audio">üéµ Ljud</button>
      <button class="switch-btn" data-section="mic">üé§ R√∂st</button>
    </div>
    <form id="uploadForm">
      <!-- TEXT -->
      <div class="upload-section active" data-section="text">
        <label for="text">Skriv ett inl√§gg:</label>
        <textarea id="text" placeholder="Vad vill du dela med dig av?" maxlength="1500"></textarea>
      </div>
      <!-- BILD -->
      <div class="upload-section" data-section="image">
        <label for="image">Ladda upp en bild (max 5 MB):</label>
        <input type="file" id="image" accept="image/*" />
      </div>
      <!-- VIDEO -->
      <div class="upload-section" data-section="video">
        <label for="video">Ladda upp ett klipp (max 30 MB):</label>
        <input type="file" id="video" accept="video/mp4,video/webm,video/ogg" />
      </div>
      <!-- AUDIO -->
      <div class="upload-section" data-section="audio">
        <label for="audio">Ladda upp ljudfil (max 5 MB):</label>
        <input type="file" id="audio" accept="audio/*" />
      </div>
      <!-- R√ñSTINSPELNING -->
      <div class="upload-section" data-section="mic">
        <label>Mikrofoninspelning (max 2 MB):</label>
        <button type="button" id="recordButton">üé§ Starta inspelning</button>
        <button type="button" id="stopButton" disabled>üõë Stoppa</button>
        <audio id="audioPreview" controls></audio>
      </div>
      <label style="margin-top:18px;">
        <input type="checkbox" id="temporary" />
        G√∂r detta till ett tillf√§lligt inl√§gg (f√∂rsvinner om 24h)
      </label>
      <button type="submit" style="margin-top:18px;">Ladda upp</button>
    </form>
  </div>

  <!-- *** H√ÑR VISAS INL√ÑGG SOM FINNS P√Ö "V√ÑGGEN" *** -->
  <div id="myWall" style="max-width:700px;margin:50px auto 25px auto"></div>

  <!-- BOTTENREKLAM -->
  <footer class="ad-footer" id="adFooter">
    <div class="ad-banner">
      <a href="#" target="_blank">
        <img id="bannerImageLeft" src="https://dummyimage.com/728x90/7b00ff/fff&text=Reklam+1" alt="Reklam v√§nster" />
      </a>
    </div>
    <div class="ad-banner">
      <a href="#" target="_blank">
        <img id="bannerImageRight" src="https://dummyimage.com/728x90/00ffcc/222&text=Reklam+2" alt="Reklam h√∂ger" />
      </a>
    </div>
  </footer>

  <!-- Banners, menyer osv ‚Äì ingen √§ndring beh√∂vs -->
  <script>
    // ... All din befintliga JS f√∂r banners, hamburgermeny etc. (of√∂r√§ndrad) ...
    // (Se tidigare kod)
  </script>

  <!-- *** UPPLADDNING (of√∂r√§ndrad, se tidigare) *** -->
  <script type="module">
    import { auth, db, storage } from "./scripts/firebase-init.js";
    import {
      collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import {
      ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    const MAX_IMAGE_SIZE = 5 * 1024 * 1024;
    const MAX_VIDEO_SIZE = 30 * 1024 * 1024;
    const MAX_AUDIO_SIZE = 5 * 1024 * 1024;
    const MAX_MIC_SIZE = 2 * 1024 * 1024;

    const uploadForm = document.getElementById("uploadForm");
    const spinner = document.getElementById("spinner");
    const uploadBox = document.getElementById("uploadBox");

    // D√∂lj uppladdningsformul√§r om inte inloggad
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        uploadBox.innerHTML = `
          <div style="text-align:center;padding:36px 0;font-size:1.23em;color:#ff7788;">
            Du m√•ste vara inloggad f√∂r att ladda upp inneh√•ll.<br><br>
            <a href="login.html" style="color:#00ffcc;font-weight:bold;">Logga in h√§r</a>
          </div>
        `;
      }
    });

    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!auth.currentUser) {
        alert("Du m√•ste vara inloggad f√∂r att ladda upp.");
        return;
      }
      spinner.style.display = "block";
      const activeSection = document.querySelector('.switch-btn.active').getAttribute('data-section');
      let postData = {
        createdAt: serverTimestamp(),
        user: auth.currentUser.uid,
        type: activeSection,
        temporary: document.getElementById("temporary").checked,
      };
      let filesToUpload = [];

      if (activeSection === "text") {
        postData.text = document.getElementById("text").value;
      }
      if (activeSection === "image") {
        const img = document.getElementById("image").files[0];
        if (img && img.size > MAX_IMAGE_SIZE) {
          spinner.style.display = "none";
          return alert(`Bilden √§r f√∂r stor! Maxstorlek: 5 MB.`);
        }
        filesToUpload.push({ file: img, key: "imageUrl" });
      }
      if (activeSection === "video") {
        const vid = document.getElementById("video").files[0];
        if (vid && vid.size > MAX_VIDEO_SIZE) {
          spinner.style.display = "none";
          return alert(`Videoklippet √§r f√∂r stort! Maxstorlek: 30 MB.`);
        }
        filesToUpload.push({ file: vid, key: "videoUrl" });
      }
      if (activeSection === "audio") {
        const aud = document.getElementById("audio").files[0];
        if (aud && aud.size > MAX_AUDIO_SIZE) {
          spinner.style.display = "none";
          return alert(`Ljudfilen √§r f√∂r stor! Maxstorlek: 5 MB.`);
        }
        filesToUpload.push({ file: aud, key: "audioUrl" });
      }
      if (activeSection === "mic") {
        const micBlob = window.lastRecordedAudioBlob;
        if (micBlob && micBlob.size > MAX_MIC_SIZE) {
          spinner.style.display = "none";
          return alert(`R√∂stinspelningen √§r f√∂r stor! Maxstorlek: 2 MB.`);
        }
        if (micBlob) filesToUpload.push({ file: micBlob, key: "micAudioUrl" });
      }

      // Ladda upp filer (om det finns)
      for (let upload of filesToUpload) {
        if (!upload.file) continue;
        const storageRef = ref(storage, `uploads/${Date.now()}_${upload.file.name}`);
        await uploadBytes(storageRef, upload.file);
        const url = await getDownloadURL(storageRef);
        postData[upload.key] = url;
      }

      // Spara posten p√• "v√§ggen"
      await addDoc(collection(db, "wall"), postData);

      spinner.style.display = "none";
      alert("‚úÖ Inl√§gget har laddats upp!");
      uploadForm.reset();
      window.location.href = "wall.html";
    });

    // --- R√∂stinspelning ---
    let mediaRecorder, audioChunks = [];
    const recordBtn = document.getElementById("recordButton");
    const stopBtn = document.getElementById("stopButton");
    const audioPreview = document.getElementById("audioPreview");
    if (recordBtn && stopBtn && audioPreview) {
      recordBtn.onclick = async function () {
        audioChunks = [];
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        recordBtn.disabled = true;
        stopBtn.disabled = false;

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
          window.lastRecordedAudioBlob = audioBlob;
          audioPreview.src = URL.createObjectURL(audioBlob);
          recordBtn.disabled = false;
          stopBtn.disabled = true;
        };
      };
      stopBtn.onclick = function () {
        mediaRecorder && mediaRecorder.stop();
      };
    }
  </script>

  <!-- *** WALL/‚ÄùMIN V√ÑGG‚Äù - BARA POSTAT MEDIA SYNS *** -->
  <script type="module">
    import { auth, db } from "./scripts/firebase-init.js";
    import {
      collection, query, orderBy, onSnapshot, doc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    // Hantera b√§ddade media/l√§nkar
    function embedMedia(text = "") {
      if (!text) return "";
      // YouTube
      if (text.match(/(?:youtube\.com|youtu\.be)/)) {
        let vid = text.match(/(?:youtube\.com.*[?&]v=|youtu\.be\/)([\w\-]+)/);
        if (vid && vid[1]) {
          return `<iframe width="360" height="215" style="max-width:97%" src="https://www.youtube.com/embed/${vid[1]}" frameborder="0" allowfullscreen></iframe>`;
        }
      }
      // TikTok
      if (text.match(/tiktok\.com/)) {
        return `<blockquote class="tiktok-embed" cite="${text}" data-video-id="" style="max-width:325px;min-width:220px;">
          <a href="${text}">TikTok</a>
        </blockquote>
        <script async src="https://www.tiktok.com/embed.js"></script>`;
      }
      // Spotify
      if (text.match(/open\.spotify\.com/)) {
        return `<iframe src="https://open.spotify.com/embed${text.split('spotify.com')[1]}"
          width="320" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media" style="max-width:99%"></iframe>`;
      }
      // SoundCloud
      if (text.match(/soundcloud\.com/)) {
        return `<iframe width="100%" height="120" scrolling="no" frameborder="no" allow="autoplay"
          src="https://w.soundcloud.com/player/?url=${encodeURIComponent(text)}&color=%2300ffcc"></iframe>`;
      }
      // Bildl√§nk direkt
      if (text.match(/\.(jpeg|jpg|png|gif|webp)$/i)) {
        return `<img src="${text}" alt="Bild" style="max-width:99%;border-radius:8px;margin-top:6px;" />`;
      }
      // Annan l√§nk
      if (text.match(/^https?:\/\//)) {
        return `<a href="${text}" target="_blank" rel="noopener">${text}</a>`;
      }
      // Vanlig text
      return text;
    }

    function renderPostSimple(post, postId, isMine) {
      let show = post.text
        ? `<div>${post.text.split(/\s+/).map(embedMedia).join('<br>')}</div>`
        : "";
      // Visa endast media-f√§lt OM det finns
      if (post.imageUrl) show += `<img src="${post.imageUrl}" alt="Bild" style="max-width:99%;border-radius:8px;margin-top:8px;">`;
      if (post.videoUrl) show += `<video src="${post.videoUrl}" controls style="max-width:99%;border-radius:8px;margin-top:8px;"></video>`;
      if (post.audioUrl) show += `<audio src="${post.audioUrl}" controls style="margin-top:8px;width:99%"></audio>`;
      if (post.micAudioUrl) show += `<audio src="${post.micAudioUrl}" controls style="margin-top:8px;width:99%"></audio>`;
      return `
        <div class="post">
          ${show}
          ${isMine ? `<button class="delete-post-btn" onclick="window.deleteWallPost('${postId}')">üóëÔ∏è Ta bort</button>` : ""}
        </div>
      `;
    }

    window.deleteWallPost = async function(postId) {
      if (!confirm("Vill du ta bort detta inl√§gg?")) return;
      await deleteDoc(doc(db, "wall", postId));
    };

    // Visa alla inl√§gg p√• v√§ggen
    let currentUserUid = null;
    auth.onAuthStateChanged((user) => {
      currentUserUid = user ? user.uid : null;
      showWall();
    });

    function showWall() {
      const wallDiv = document.getElementById("myWall");
      if (!wallDiv) return;
      wallDiv.innerHTML = "Laddar inl√§gg...";
      const q = query(collection(db, "wall"), orderBy("createdAt", "desc"));
      onSnapshot(q, (snapshot) => {
        let html = "";
        snapshot.forEach(docSnap => {
          const post = docSnap.data();
          const postId = docSnap.id;
          const isMine = post.user === currentUserUid;
          html += renderPostSimple(post, postId, isMine);
        });
        wallDiv.innerHTML = html || "<div style='color:#aaa;text-align:center'>Inga inl√§gg √§nnu!</div>";
      });
    }
  </script>
</body>
</html>
