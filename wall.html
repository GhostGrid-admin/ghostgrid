<!DOCTYPE html>
<html lang="sv">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V√§ggen ‚Äì GhostGrid</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      margin: 0;
      padding-top: 85px;
      background-color: #0a0a0a;
      color: #e0ffff;
      font-family: 'Courier New', monospace;
      min-height: 100vh;
    }
    nav.navbar {
      background-color: #000;
      border-bottom: 2px solid #00ffcc;
      padding: 12px 0;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
      box-shadow: 0 0 20px #bb00ff;
      display: flex;
      justify-content: center;
      transition: top 0.3s;
    }
    .nav-content {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 16px;
      max-width: 900px;
      width: 100%;
      align-items: center;
      text-align: center;
    }
    .nav-content a {
      color: white;
      text-decoration: none;
      font-size: 1.2em;
      padding: 7px 10px;
      border-radius: 4px;
      text-shadow: 0 0 8px #00ffcc, 0 0 6px #bb00ff;
      transition: 0.3s;
    }
    .nav-content a:hover {
      background-color: #00ffcc;
      color: #000;
      box-shadow: 0 0 10px #ffffff;
    }
    .wall-container {
      max-width: 700px;
      margin: 0 auto;
      padding: 10px;
      width: 100%;
    }
    .wall-title {
      font-size: 2em;
      text-align: center;
      color: #aaffee;
      margin: 10px 0 22px 0;
      text-shadow: 0 0 8px #ffffff;
    }
    .search-filter, .filter-search {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 10px;
      font-size: 1em;
    }
    .search-filter button, .filter-search label {
      background-color: #8000ff;
      border: none;
      padding: 7px 14px;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.99em;
    }
    .search-filter button.active {
      background-color: #00ffcc;
      color: #000;
      font-weight: bold;
    }
    .filter-search input[type="text"] {
      padding: 8px;
      width: 72vw;
      max-width: 370px;
      border-radius: 6px;
      border: 1px solid #7b00ff;
      background-color: #1a1a1a;
      color: #fff;
      font-size: 1em;
      margin-top: 2px;
      margin-bottom: 2px;
    }
    .post {
      background-color: rgba(0, 0, 0, 0.88);
      padding: 15px 12px 8px 12px;
      border-radius: 10px;
      border-left: 4px solid #00ffcc;
      margin-bottom: 20px;
      word-break: break-word;
      box-shadow: 0 0 10px #4ef2ff11;
    }
    .post strong {
      color: #ccffff;
      font-size: 1.08em;
    }
    .post .post-media {
      margin-top: 8px;
      margin-bottom: 4px;
      max-width: 100%;
      border-radius: 8px;
      box-shadow: 0 0 8px #0ff7;
    }
    .reactions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 7px 0 0 0;
      align-items: center;
    }
    .reactions button {
      font-size: 1.25em;
      background: none;
      border: none;
      cursor: pointer;
      padding: 3px 8px;
      border-radius: 6px;
      margin: 0;
      transition: background 0.17s;
    }
    .reactions button.selected, .reactions button:hover {
      background: #00ffcc44;
      color: #000;
      font-weight: bold;
    }
    .reaction-count {
      font-size: 0.92em;
      margin-left: 3px;
      margin-right: 10px;
      color: #ccc;
    }
    .comments {
      margin-top: 10px;
      background: #141626;
      border-radius: 7px;
      padding: 7px;
    }
    .comment {
      margin-bottom: 8px;
      display: flex;
      align-items: flex-start;
      gap: 5px;
    }
    .comment-content {
      background: #21243a;
      color: #fff;
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 1em;
      flex: 1;
    }
    .delete-comment-btn {
      background: #d62e6e;
      border: none;
      color: white;
      border-radius: 50%;
      cursor: pointer;
      padding: 0 6px;
      font-size: 0.95em;
      margin-left: 4px;
      margin-top: 2px;
    }
    .comments input[type="text"] {
      width: 90%;
      padding: 7px;
      border-radius: 5px;
      border: 1px solid #00ffcc;
      background-color: #191929;
      color: white;
      font-size: 1em;
      margin-right: 8px;
      margin-top: 7px;
      margin-bottom: 2px;
    }
    .comments button.add-comment-btn {
      background: #00ffcc;
      color: #000;
      font-weight: bold;
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 6px;
    }
    /* ---- Mobil: navbar och global s√∂k f√∂rsvinner vid scroll ner ---- */
    @media (max-width: 600px) {
      nav.navbar {
        transition: top 0.3s;
      }
      nav.navbar.hide-navbar {
        top: -70px;
      }
      .nav-content { font-size: 1em; gap: 7px; }
      .wall-container { padding: 3vw; }
      .wall-title { font-size: 1.2em; }
      .post { padding: 10px 3vw 7px 3vw; font-size: 0.97em; }
      .filter-search input[type="text"] { width: 98vw; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-content">
      <a href="forum.html">Forum</a>
      <a href="store.html">Store</a>
      <a href="wall.html">V√§ggen</a>
      <a href="upload.html">Ladda upp</a>
      <a href="profile.html">Profil</a>
      <a href="friends.html">V√§nner</a>
      <div class="search-container">
        <input type="text" placeholder="S√∂k p√• hela sidan..." id="searchInputGlobal" />
      </div>
    </div>
  </nav>

  <div class="wall-container">
    <h1 class="wall-title" id="wallTitle">Gemensamma Inl√§gg</h1>
    <div class="search-filter">
      <button onclick="setFilter('all')" class="active">Alla</button>
      <button onclick="setFilter('text')">Text</button>
      <button onclick="setFilter('image')">Bild</button>
      <button onclick="setFilter('audio')">Ljud</button>
      <button onclick="setFilter('video')">Klipp</button>
      <button onclick="setFilter('combo')">Kombinerat</button>
    </div>
    <div class="filter-search">
      <input type="text" id="localSearchInput" placeholder="S√∂k inl√§gg p√• v√§ggen..." oninput="filterPosts()" />
    </div>
    <div id="postsContainer"></div>
  </div>

  <script type="module">
    import { auth, db } from './scripts/firebase-init.js';
    import {
      collection, query, orderBy, onSnapshot, doc, getDocs, setDoc, addDoc, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    
    // REACTIONS: Emojis & texter
    const reactionsList = [
      { key: "heart", emoji: "‚ù§Ô∏è" },
      { key: "broken_heart", emoji: "üíî" },
      { key: "happy", emoji: "üòä" },
      { key: "sad", emoji: "üò¢" },
      { key: "laugh", emoji: "üòÇ" },
      { key: "cry", emoji: "üò≠" },
      { key: "embarrassed", emoji: "üò≥" },
      { key: "surprised", emoji: "üò≤" },
      { key: "angel", emoji: "üòá" }
    ];
    
    let currentUser = null;
    auth.onAuthStateChanged(user => { currentUser = user; });

    // FILTER
    let currentTypeFilter = 'all', currentSearch = '';
    function setFilter(type) {
      currentTypeFilter = type;
      document.querySelectorAll('.search-filter button').forEach(btn =>
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(type) || (type === 'all' && btn.textContent.toLowerCase() === 'alla'))
      );
      filterPosts();
    }
    window.setFilter = setFilter;

    function filterPosts() {
      const search = document.getElementById("localSearchInput").value.toLowerCase();
      currentSearch = search;
      document.querySelectorAll('.post').forEach(postEl => {
        const text = postEl.innerText.toLowerCase();
        const type = postEl.dataset.type;
        const showType = (currentTypeFilter === 'all' || type === currentTypeFilter);
        const showSearch = !search || text.includes(search);
        postEl.style.display = (showType && showSearch) ? '' : 'none';
      });
    }

    // LADDA IN ALLA INL√ÑGG
    function renderMedia(post) {
      let html = "";
      if (post.imageUrl) html += `<img class="post-media" src="${post.imageUrl}" alt="Bild" />`;
      if (post.videoUrl) html += `<video class="post-media" src="${post.videoUrl}" controls></video>`;
      if (post.audioUrl) html += `<audio class="post-media" src="${post.audioUrl}" controls></audio>`;
      if (post.micAudioUrl) html += `<audio class="post-media" src="${post.micAudioUrl}" controls></audio>`;
      return html;
    }

    function renderReactions(post, postId, userReaction, counts) {
      return `
        <div class="reactions">
          ${reactionsList.map(r => `
            <button
              ${userReaction === r.key ? 'class="selected"' : ''}
              onclick="window.setReaction('${postId}','${r.key}')"
              title="Reagera med ${r.emoji}"
              >${r.emoji} <span class="reaction-count">${counts[r.key] || ''}</span></button>
          `).join("")}
          ${userReaction ? `<button onclick="window.removeReaction('${postId}')">‚ùå Ta bort reaktion</button>` : ""}
        </div>`;
    }

    window.setReaction = async (postId, key) => {
      if (!currentUser) { alert("Du m√•ste vara inloggad f√∂r att reagera."); return; }
      const ref = doc(db, "wall", postId, "reactions", currentUser.uid);
      await updateDoc(ref, { type: key }, { merge: true }).catch(async() => {
        await setDoc(ref, { type: key });
      });
    };
    window.removeReaction = async (postId) => {
      if (!currentUser) return;
      await deleteDoc(doc(db, "wall", postId, "reactions", currentUser.uid));
    };

    // KOMMENTARER
    window.addComment = async (postId, inputId) => {
      const input = document.getElementById(inputId);
      const content = input.value.trim();
      if (!content) return;
      if (!currentUser) { alert("Du m√•ste vara inloggad f√∂r att kommentera."); return; }
      if (content.split(/\s+/).length > 200) { alert("Max 200 ord!"); return; }
      await addDoc(collection(db, "wall", postId, "comments"), {
        content, user: currentUser.uid, createdAt: new Date()
      });
      input.value = "";
    };
    window.deleteComment = async (postId, commentId) => {
      if (!currentUser) return;
      await deleteDoc(doc(db, "wall", postId, "comments", commentId));
    };

    // Rendera v√§ggen
    function renderPost(post, postId, userReaction, reactionCounts, comments, userId) {
      return `
        <div class="post" data-type="${post.type}">
          <div>
            <strong>${post.text ? post.text : ''}</strong>
            ${renderMedia(post)}
          </div>
          ${renderReactions(post, postId, userReaction, reactionCounts)}
          <div class="comments">
            <div>
              ${comments.map(c =>
                `<div class="comment"><div class="comment-content">${c.content}</div>
                  ${currentUser && c.user === currentUser.uid
                    ? `<button class="delete-comment-btn" title="Ta bort" onclick="window.deleteComment('${postId}','${c.id}')">üóëÔ∏è</button>` : ''}
                 </div>`
              ).join("")}
            </div>
            ${currentUser ? `
              <input type="text" placeholder="Kommentera..." id="comment-input-${postId}" maxlength="1000" />
              <button class="add-comment-btn" onclick="window.addComment('${postId}','comment-input-${postId}')">Kommentera</button>
            ` : '<div style="color:#f44;font-size:0.96em;">Logga in f√∂r att kommentera</div>'}
          </div>
        </div>
      `;
    }

    function listenToWall() {
      const postsContainer = document.getElementById("postsContainer");
      const q = query(collection(db, "wall"), orderBy("createdAt", "desc"));
      onSnapshot(q, async snapshot => {
        postsContainer.innerHTML = "Laddar...";
        let html = "";
        let postsArr = [];
        for (const docSnap of snapshot.docs) {
          const post = docSnap.data();
          post.id = docSnap.id;
          postsArr.push(post);
        }

        for (const post of postsArr) {
          let reactionsDocs = await getDocs(collection(db, "wall", post.id, "reactions"));
          let reactionCounts = {}, userReaction = null;
          reactionsDocs.forEach(rDoc => {
            const r = rDoc.data().type;
            if (rDoc.id === (currentUser && currentUser.uid)) userReaction = r;
            reactionCounts[r] = (reactionCounts[r] || 0) + 1;
          });

          let commentsDocs = await getDocs(collection(db, "wall", post.id, "comments"));
          let comments = [];
          commentsDocs.forEach(cDoc => {
            let c = cDoc.data();
            c.id = cDoc.id;
            comments.push(c);
          });
          comments.sort((a, b) => a.createdAt && b.createdAt ? a.createdAt.seconds - b.createdAt.seconds : 0);

          html += renderPost(post, post.id, userReaction, reactionCounts, comments, post.user);
        }
        postsContainer.innerHTML = html || '<div style="text-align:center;color:#99d">Inga inl√§gg √§nnu!</div>';
        filterPosts();
      });
    }
    listenToWall();

    document.getElementById("searchInputGlobal").addEventListener("keydown", e => {
      if (e.key === "Enter") {
        const q = e.target.value.trim();
        if (q.length > 1) window.location.href = "search.html?q=" + encodeURIComponent(q);
      }
    });
  </script>

  <!-- --- NAVBAR SCROLL-HIDE FOR MOBIL --- -->
  <script>
    if (window.innerWidth <= 600) {
      let lastScrollY = window.scrollY;
      let navbar = document.querySelector('.navbar');
      window.addEventListener('scroll', function () {
        if (window.scrollY > lastScrollY && window.scrollY > 70) {
          navbar.classList.add('hide-navbar');
        } else {
          navbar.classList.remove('hide-navbar');
        }
        lastScrollY = window.scrollY;
      });
    }
  </script>
<!-- --- REKLAMBANNER / FOOTER --- -->
<footer class="ad-footer">
  <div class="ad-banner">
    <!-- H√§r kan du l√§gga in Adsense-kod, en bild, en iframe, eller vad du vill -->
    REKLAM H√ÑR
  </div>
</footer></body>
</html>
