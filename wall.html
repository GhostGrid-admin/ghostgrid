<!DOCTYPE html>
<html lang="sv">
<head>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V√§ggen ‚Äì GhostGrid</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ... (all din CSS som tidigare, klippt f√∂r utrymme) ... */
  </style>
</head>
<body>
  <!-- SIDBANNERS -->
  <div class="side-banner left">
    <div class="banner-inner">
      <a id="leftBannerLink" href="#" target="_blank">
        <img id="leftBannerImg" src="https://dummyimage.com/120x1800/7b00ff/fff&text=Reklam+1" alt="Reklam" />
      </a>
    </div>
  </div>
  <div class="side-banner right">
    <div class="banner-inner">
      <a id="rightBannerLink" href="#" target="_blank">
        <img id="rightBannerImg" src="https://dummyimage.com/120x1800/222299/fff&text=Reklam+2" alt="Reklam" />
      </a>
    </div>
  </div>
  <!-- NAVBAR -->
  <nav class="navbar">
    <button id="menuBtn" aria-label="Meny">&#9776;</button>
    <div class="nav-content" id="navLinks">
      <a href="forum.html" data-t="forum">Forum</a>
      <a href="store.html" data-t="store">Store</a>
      <a href="wall.html" data-t="wall">V√§ggen</a>
      <a href="upload.html" data-t="upload">Ladda upp</a>
      <a href="profile.html" data-t="profile">Profil</a>
      <a href="friends.html" data-t="friends">V√§nner</a>
      <div class="search-container">
        <input type="text" id="searchInputGlobal" data-tph="searchSite" />
      </div>
    </div>
  </nav>

  <div class="wall-container">
    <h1 class="wall-title" id="wallTitle" data-t="wallTitle">Gemensamma Inl√§gg</h1>
    <div class="search-filter">
      <button onclick="setFilter('all')" class="active" data-t="all">Alla</button>
      <button onclick="setFilter('text')" data-t="text">Text</button>
      <button onclick="setFilter('image')" data-t="image">Bild</button>
      <button onclick="setFilter('audio')" data-t="audio">Ljud</button>
      <button onclick="setFilter('video')" data-t="video">Klipp</button>
      <button onclick="setFilter('combo')" data-t="combo">Kombinerat</button>
    </div>
    <div class="filter-search">
      <input type="text" id="localSearchInput" data-tph="searchWall" oninput="filterPosts()" />
    </div>
    <div id="postsContainer"></div>
  </div>

  <!-- ========== ALLA SCRIPT LIGGER NU EFTER INNEH√ÖLLET! ========== -->
  <script type="module">
    // SPR√ÖKST√ñD
    const lang = localStorage.getItem('language') || 'sv';
    const texts = {
      sv: { /* ... */ },
      en: { /* ... */ }
    };
    function tr(key) { return (texts[lang] && texts[lang][key]) || key; }
    function applyLang() {
      document.querySelectorAll('[data-t]').forEach(el => el.textContent = tr(el.getAttribute('data-t')));
      document.querySelectorAll('[data-tph]').forEach(el => el.placeholder = tr(el.getAttribute('data-tph')));
    }
    applyLang();

    import { auth, db } from './scripts/firebase-init.js';
    import {
      collection, query, orderBy, onSnapshot, doc, getDocs, setDoc, addDoc, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    // REACTIONS
    const reactionsList = [
      { key: "heart", emoji: "‚ù§Ô∏è" }, { key: "thumbs_up", emoji: "üëç" }, { key: "laugh", emoji: "üòÇ" },
      { key: "happy", emoji: "üòä" }, { key: "embarrassed", emoji: "üò≥" }, { key: "angel", emoji: "üòá" },
      { key: "surprised", emoji: "üò≤" }, { key: "sad", emoji: "üò¢" }, { key: "cry", emoji: "üò≠" },
      { key: "thumbs_down", emoji: "üëé" }, { key: "broken_heart", emoji: "üíî" }
    ];
    let currentUser = null;
    auth.onAuthStateChanged(user => { currentUser = user; });

    // FILTER
    let currentTypeFilter = 'all', currentSearch = '';
    function setFilter(type) {
      currentTypeFilter = type;
      document.querySelectorAll('.search-filter button').forEach(btn =>
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(type) || (type === 'all' && btn.textContent.toLowerCase() === tr('all').toLowerCase()))
      );
      filterPosts();
    }
    window.setFilter = setFilter;
    function filterPosts() {
      const search = document.getElementById("localSearchInput").value.toLowerCase();
      currentSearch = search;
      document.querySelectorAll('.post').forEach(postEl => {
        const text = postEl.innerText.toLowerCase();
        const type = postEl.dataset.type;
        const showType = (currentTypeFilter === 'all' || type === currentTypeFilter);
        const showSearch = !search || text.includes(search);
        postEl.style.display = (showType && showSearch) ? '' : 'none';
      });
    }

    // INB√ÑDDNING AV L√ÑNKAR (YouTube, Spotify, TikTok, m.fl.)
    function embedLinks(text) {
      if (!text) return "";
      let html = text.replace(/(https?:\/\/[^\s]+)/g, url => {
        // YouTube
        if (/youtu\.be|youtube\.com/.test(url)) {
          let vid = url.match(/(?:youtu\.be\/|youtube\.com.*[?&]v=)([\w\-]+)/);
          if (vid && vid[1]) {
            return `<iframe width="360" height="210" style="max-width:95%;" src="https://www.youtube.com/embed/${vid[1]}" frameborder="0" allowfullscreen></iframe>`;
          }
        }
        // TikTok
        if (/tiktok\.com/.test(url)) {
          return `<blockquote class="tiktok-embed" cite="${url}" data-video-id="" style="max-width:325px;min-width:220px;">
                    <a href="${url}">TikTok</a>
                  </blockquote>
                  <script async src="https://www.tiktok.com/embed.js"></script>`;
        }
        // Spotify
        if (/open\.spotify\.com/.test(url)) {
          return `<iframe src="https://open.spotify.com/embed${url.split('spotify.com')[1]}" width="320" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media" style="max-width:99%"></iframe>`;
        }
        // Annars: l√§nk som vanligt
        return `<a href="${url}" target="_blank" rel="noopener">${url}</a>`;
      });
      return html;
    }

    // WALL RENDER
    function renderMedia(post) {
      let html = "";
      if (post.imageUrl) html += `<img class="post-media" src="${post.imageUrl}" alt="Bild" />`;
      if (post.videoUrl) html += `<video class="post-media" src="${post.videoUrl}" controls></video>`;
      if (post.audioUrl) html += `<audio class="post-media" src="${post.audioUrl}" controls></audio>`;
      if (post.micAudioUrl) html += `<audio class="post-media" src="${post.micAudioUrl}" controls></audio>`;
      return html;
    }

    function renderReactions(post, postId, userReaction, counts) {
      return `
        <div class="reactions">
          ${reactionsList.map(r => `
            <button
              ${userReaction === r.key ? 'class="selected"' : ''}
              onclick="window.setReaction('${postId}','${r.key}')"
              title="Reagera med ${r.emoji}"
              >${r.emoji} <span class="reaction-count">${counts[r.key] || ''}</span></button>
          `).join("")}
          ${userReaction ? `<button onclick="window.removeReaction('${postId}')">${tr('removeReaction')}</button>` : ""}
        </div>`;
    }

    // Reagera p√• post
    window.setReaction = async (postId, key) => {
      if (!currentUser) { alert(tr("needLoginReact")); return; }
      const ref = doc(db, "wall", postId, "reactions", currentUser.uid);
      await updateDoc(ref, { type: key }, { merge: true }).catch(async() => {
        await setDoc(ref, { type: key });
      });
    };
    window.removeReaction = async (postId) => {
      if (!currentUser) return;
      await deleteDoc(doc(db, "wall", postId, "reactions", currentUser.uid));
    };

    // Kommentera och svara
    window.addComment = async (postId, inputId, parentCommentId = null) => {
      const input = document.getElementById(inputId);
      const content = input.value.trim();
      if (!content) return;
      if (!currentUser) { alert(tr("needLoginComment")); return; }
      if (content.split(/\s+/).length > 200) { alert(tr("maxWords")); return; }
      await addDoc(collection(db, "wall", postId, "comments"), {
        content, user: currentUser.uid, createdAt: new Date(), parent: parentCommentId || null
      });
      input.value = "";
    };
    window.deleteComment = async (postId, commentId) => {
      if (!currentUser) return;
      await deleteDoc(doc(db, "wall", postId, "comments", commentId));
    };

    // Radera post
    window.deletePost = async (postId, userId) => {
      if (!currentUser || currentUser.uid !== userId) return;
      if (!confirm(tr("confirmDelete"))) return;
      await deleteDoc(doc(db, "wall", postId));
    };

    // Visa kommentarer i tr√•dstruktur
    function renderComments(comments, postId, parentId = null, level = 0) {
      return comments
        .filter(c => c.parent === parentId)
        .map(c =>
          `<div class="comment" style="margin-left:${level*18}px">
            <div class="comment-content">${embedLinks(c.content)}</div>
            ${currentUser && c.user === currentUser.uid
              ? `<button class="delete-comment-btn" title="${tr('deleteComment')}" onclick="window.deleteComment('${postId}','${c.id}')">${tr('deleteComment')}</button>`
              : ''
            }
            <button class="add-comment-btn" onclick="window.replyToComment('${postId}','${c.id}')" style="margin-left:7px;font-size:0.92em;">${tr('replyBtn')}</button>
            <div id="reply-box-${postId}-${c.id}" style="margin-left:2px"></div>
            ${renderComments(comments, postId, c.id, level+1)}
          </div>`
        ).join("");
    }
    window.replyToComment = function(postId, commentId) {
      const box = document.getElementById(`reply-box-${postId}-${commentId}`);
      if (!box.innerHTML) {
        box.innerHTML = `<input type="text" id="reply-input-${postId}-${commentId}" placeholder="${tr('commentPlaceholder')}" maxlength="500" style="margin-top:5px;width:92%" />
          <button class="add-comment-btn" onclick="window.addComment('${postId}','reply-input-${postId}-${commentId}','${commentId}')">${tr('commentBtn')}</button>`;
      } else {
        box.innerHTML = "";
      }
    }

    function renderPost(post, postId, userReaction, reactionCounts, comments, userId) {
      return `
        <div class="post" data-type="${post.type}">
          ${currentUser && currentUser.uid === userId ?
            `<button class="delete-post-btn" onclick="window.deletePost('${postId}','${userId}')">${tr('deletePost')}</button>` : ""}
          <div>
            <strong>${post.text ? embedLinks(post.text) : ''}</strong>
            ${renderMedia(post)}
          </div>
          ${renderReactions(post, postId, userReaction, reactionCounts)}
          <div class="comments">
            <div>
              ${renderComments(comments, postId)}
            </div>
            ${currentUser ? `
              <input type="text" placeholder="${tr('commentPlaceholder')}" id="comment-input-${postId}" maxlength="1000" />
              <button class="add-comment-btn" onclick="window.addComment('${postId}','comment-input-${postId}')">${tr('commentBtn')}</button>
            ` : `<div style="color:#f44;font-size:0.96em;">${tr('loginComment')}</div>`}
          </div>
        </div>
      `;
    }

    // LADDA IN V√ÑGG
    function listenToWall() {
      const postsContainer = document.getElementById("postsContainer");
      const q = query(collection(db, "wall"), orderBy("createdAt", "desc"));
      onSnapshot(q, async snapshot => {
        postsContainer.innerHTML = tr("loading");
        let html = "";
        let postsArr = [];
        for (const docSnap of snapshot.docs) {
          const post = docSnap.data();
          post.id = docSnap.id;
          postsArr.push(post);
        }
        for (const post of postsArr) {
          let reactionsDocs = await getDocs(collection(db, "wall", post.id, "reactions"));
          let reactionCounts = {}, userReaction = null;
          reactionsDocs.forEach(rDoc => {
            const r = rDoc.data().type;
            if (rDoc.id === (currentUser && currentUser.uid)) userReaction = r;
            reactionCounts[r] = (reactionCounts[r] || 0) + 1;
          });

          let commentsDocs = await getDocs(collection(db, "wall", post.id, "comments"));
          let comments = [];
          commentsDocs.forEach(cDoc => {
            let c = cDoc.data();
            c.id = cDoc.id;
            comments.push(c);
          });
          comments.sort((a, b) => a.createdAt && b.createdAt ? a.createdAt.seconds - b.createdAt.seconds : 0);

          html += renderPost(post, post.id, userReaction, reactionCounts, comments, post.user);
        }
        postsContainer.innerHTML = html || `<div style="text-align:center;color:#99d">${tr('noPosts')}</div>`;
        filterPosts();
      });
    }
    listenToWall();

    // S√∂k globalt
    document.getElementById("searchInputGlobal").addEventListener("keydown", e => {
      if (e.key === "Enter") {
        const q = e.target.value.trim();
        if (q.length > 1) window.location.href = "search.html?q=" + encodeURIComponent(q);
      }
    });
  </script>

  <!-- SIDBANNERS ‚Äì Rotera var 6:e sekund -->
  <script>
    const banners = [
      {
        left: { src: "https://dummyimage.com/120x1800/7b00ff/fff&text=Reklam+1", alt: "Reklam Banner 1", url: "#" },
        right: { src: "https://dummyimage.com/120x1800/222299/fff&text=Reklam+2", alt: "Reklam Banner 2", url: "#" }
      },
      {
        left: { src: "https://dummyimage.com/120x1800/ff0088/fff&text=Bli+medlem!", alt: "Bli medlem", url: "register.html" },
        right: { src: "https://dummyimage.com/120x1800/0077ff/fff&text=Annonsera+H√§r", alt: "Annonsera", url: "#" }
      }
    ];
    let bannerIndex = 0;
    function updateBanners() {
      const left = banners[bannerIndex].left;
      const right = banners[bannerIndex].right;
      document.getElementById('leftBannerImg').src = left.src;
      document.getElementById('leftBannerImg').alt = left.alt;
      document.getElementById('leftBannerLink').href = left.url;
      document.getElementById('rightBannerImg').src = right.src;
      document.getElementById('rightBannerImg').alt = right.alt;
      document.getElementById('rightBannerLink').href = right.url;
    }
    updateBanners();
    setInterval(() => {
      bannerIndex = (bannerIndex + 1) % banners.length;
      updateBanners();
    }, 6000);
  </script>

  <!-- NAVBAR SCROLL-HIDE F√ñR MOBIL & hamburgermeny -->
  <script>
    if (window.innerWidth <= 600) {
      let lastScrollY = window.scrollY;
      let navbar = document.querySelector('.navbar');
      window.addEventListener('scroll', function () {
        if (window.scrollY > lastScrollY && window.scrollY > 70) {
          navbar.classList.add('hide-navbar');
        } else {
          navbar.classList.remove('hide-navbar');
        }
        lastScrollY = window.scrollY;
      });
    }
    // Hamburger meny-funktion
    const menuBtn = document.getElementById("menuBtn");
    const navLinks = document.getElementById("navLinks");
    menuBtn.onclick = () => navLinks.classList.toggle("active");
    document.querySelectorAll('.nav-content a').forEach(a =>
      a.onclick = () => navLinks.classList.remove("active")
    );
  </script>
</body>
</html>
