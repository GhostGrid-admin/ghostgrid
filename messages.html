<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Meddelanden â€“ GhostGrid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { background: #101918; color: #b2ffb2; font-family: 'Share Tech Mono', monospace; margin: 0; }
    .messages-container { max-width: 950px; margin: 30px auto 0; padding: 32px 12px; background: #1d2b26bb; border-radius: 28px; box-shadow: 0 0 60px #21ff2144; display: flex; gap: 32px; }
    .convo-list { min-width: 220px; max-width: 320px; border-right: 2px solid #21ff21aa; }
    .convo { display: flex; align-items: center; padding: 12px 14px; border-radius: 18px; margin-bottom: 6px; background: #19221e; cursor: pointer; transition: background 0.2s;}
    .convo.active, .convo:hover { background: #203b24; }
    .convo img { width: 38px; height: 38px; border-radius: 50%; margin-right: 13px; }
    .convo .name { font-size: 1.15em; }
    .convo .badge { margin-left: auto; background: #19ff19; color: #0a2a0a; min-width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; border-radius: 16px; font-weight: bold; font-size: 1.05em; box-shadow: 0 0 10px #15ff1584; }
    .chat-window { flex: 1; min-width: 0; padding-left: 24px; }
    .chat-messages { max-height: 62vh; overflow-y: auto; padding-right: 12px; margin-bottom: 18px;}
    .chat-bubble-row { display: flex; align-items: flex-end; gap: 6px; margin-bottom: 8px; }
    .chat-bubble { background: #16ff16; color: #19221e; display: inline-block; padding: 10px 16px; border-radius: 14px 14px 4px 14px; margin: 0; max-width: 62vw; word-break: break-word; }
    .chat-bubble.me { background: #0e2f1b; color: #7cff7c; border-radius: 14px 4px 14px 14px; margin-left: auto;}
    .chat-meta { font-size: 0.75em; color: #47ff9e; margin-top: 2px; }
    .chat-input-row { display: flex; gap: 10px; }
    .chat-input { flex: 1; padding: 8px 16px; border-radius: 14px; border: none; font-size: 1.08em; }
    .send-btn { background: #21ff21; color: #222; font-weight: bold; border: none; border-radius: 14px; padding: 8px 26px; font-size: 1em; cursor: pointer; }
    .delete-btn { background: #ff4040; color: #fff; border: none; border-radius: 10px; padding: 6px 16px; font-size: 1em; cursor: pointer; margin-bottom: 12px; margin-left: 6px; }
    .msg-checkbox { transform: scale(1.35); accent-color: #00ff7e; margin-right: 6px;}
    .block-btn, .unblock-btn {
      background: #222; border: 2px solid #ff4444; color: #ff4444;
      padding: 6px 18px; border-radius: 14px; margin-bottom: 16px; margin-top: 4px;
      font-weight: bold; cursor: pointer; font-size: 1em; transition: all 0.15s;
    }
    .block-btn:hover, .unblock-btn:hover { background: #ff4444; color: #fff; }
    .blocked-warning {
      color: #ff4444; background: #330000bb; border-radius: 10px;
      padding: 8px 15px; font-weight: bold; margin-bottom: 10px; margin-top: 10px; text-align: center;
    }
    .chat-image { max-width: 150px; max-height: 150px; border-radius: 10px; box-shadow: 0 0 10px #21ff21aa;}
    @media (max-width: 900px) {
      .messages-container { flex-direction: column; gap: 8px; padding: 8px;}
      .convo-list, .chat-window { width: 100%; max-width: 100%; display: block;}
      .chat-window { padding-left: 0; }
      .chat-bubble { max-width: 90vw;}
    }
  </style>
</head>
<body>
  <div class="messages-container">
    <div class="convo-list" id="convo-list">
      <h2 style="text-align:center; color:#19ff19; margin:12px 0;">Meddelanden</h2>
    </div>
    <div class="chat-window" id="chat-window">
      <div style="text-align:center; margin-top:42px; color:#6ad96a;">VÃ¤lj en konversation eller bÃ¶rja skriva till nÃ¥gon!</div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, orderBy, getDocs, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCjWQB0hAO1r686hVdpBKBJkaIYMXOM8l8",
      authDomain: "ghostgrid-fb278.firebaseapp.com",
      projectId: "ghostgrid-fb278",
      storageBucket: "ghostgrid-fb278.appspot.com",
      messagingSenderId: "283208202937",
      appId: "1:283208202937:web:11c0cea81fd18a31163968"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let currentUser, conversations = [], activeConvoId = null, activeOtherUser = null, convoUserProfiles = {}, blockedMap = {};

    // HjÃ¤lpfunktioner
    function getConversationId(uid1, uid2) {
      return [uid1, uid2].sort().join("_");
    }
    async function getUserProfile(uid) {
      const ref = doc(db, 'profiles', uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) return { displayName: "OkÃ¤nd", photoURL: "default-avatar.png" };
      const data = snap.data();
      return {
        displayName: data.displayName || "OkÃ¤nd",
        photoURL: data.profilePicUrl || "default-avatar.png"
      };
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        document.body.innerHTML = `<div style="text-align:center;margin-top:110px;font-size:1.4em;color:#f66;">
          Du Ã¤r inte inloggad.<br>
          <a href="login.html" style="color:#22ffff;font-size:1.2em;">Logga in hÃ¤r</a>
        </div>`;
        return;
      }
      currentUser = user;
      await loadConversations();

      // Hantera ?to=
      const params = new URLSearchParams(window.location.search);
      const toUserId = params.get('to');
      if (toUserId) {
        const convoId = getConversationId(currentUser.uid, toUserId);
        activeConvoId = convoId;
        activeOtherUser = toUserId;
        if (!conversations.find(c => c.id === convoId)) {
          const toProfile = await getUserProfile(toUserId);
          conversations.unshift({
            id: convoId,
            users: [currentUser.uid, toUserId],
            other: toProfile,
            lastMessage: "",
            unread: 0,
            blocked: {}
          });
        }
        renderConversations();
        openConversation(convoId, toUserId);
      }
    });

    async function loadConversations() {
      const q = query(collection(db, "conversations"), where("users", "array-contains", currentUser.uid), orderBy("updatedAt", "desc"));
      const snap = await getDocs(q);
      conversations = [];
      for (const docu of snap.docs) {
        const data = docu.data();
        const otherId = data.users.find(uid => uid !== currentUser.uid);
        if (!convoUserProfiles[otherId]) {
          convoUserProfiles[otherId] = await getUserProfile(otherId);
        }
        conversations.push({
          id: docu.id,
          users: data.users,
          other: convoUserProfiles[otherId],
          lastMessage: data.lastMessage,
          unread: data.unread && data.unread[currentUser.uid] ? data.unread[currentUser.uid] : 0,
          blocked: data.blocked || {}
        });
        blockedMap[docu.id] = data.blocked || {};
      }
      renderConversations();
    }

    function renderConversations() {
      const list = document.getElementById('convo-list');
      list.innerHTML = `<h2 style="text-align:center; color:#19ff19; margin:12px 0;">Meddelanden</h2>`;
      if (conversations.length === 0) {
        list.innerHTML += `<div style="color:#85ff7e; text-align:center; margin-top:44px;">Inga konversationer Ã¤n.</div>`;
        return;
      }
      conversations.forEach(convo => {
        list.innerHTML += `
          <div class="convo${convo.id === activeConvoId ? ' active' : ''}" onclick="window.openConversation('${convo.id}')">
            <img src="${convo.other.photoURL}" alt="Profilbild" />
            <div>
              <div class="name">${convo.other.displayName}</div>
              <div style="font-size:0.9em; color:#6bffbb">${convo.lastMessage ? convo.lastMessage.slice(0, 32) : "Ingen konvo Ã¤n."}</div>
            </div>
            ${convo.unread > 0 ? `<div class="badge">${convo.unread}</div>` : ""}
            ${(convo.blocked && (convo.blocked[currentUser.uid] || convo.blocked[convo.users.find(u => u !== currentUser.uid)])) ? `<span style="color:#ff4444;margin-left:8px;">ðŸš«</span>` : ''}
          </div>
        `;
      });
    }

    window.openConversation = openConversation;
    async function openConversation(convoId, otherId=null) {
      activeConvoId = convoId;
      renderConversations();

      const chatDiv = document.getElementById('chat-window');
      chatDiv.innerHTML = `<div style="color:#99ffbb;text-align:center;">Laddar...</div>`;

      // HÃ¤mta eller skapa konvo
      let convoRef = doc(db, 'conversations', convoId);
      let convoDoc = await getDoc(convoRef);
      let convoData = convoDoc.exists() ? convoDoc.data() : null;
      if (!convoData && otherId) {
        await setDoc(convoRef, {
          users: [currentUser.uid, otherId],
          lastMessage: "",
          updatedAt: serverTimestamp(),
          unread: { [currentUser.uid]: 0, [otherId]: 0 },
          blocked: {}
        });
        convoDoc = await getDoc(convoRef);
        convoData = convoDoc.data();
      }
      // Blockeringsstatus
      const blockedObj = convoData && convoData.blocked ? convoData.blocked : {};
      const isBlockedByMe = blockedObj[currentUser.uid];
      const isBlockedByOther = convoData && convoData.users && convoData.users.length === 2
        ? blockedObj[convoData.users.find(u => u !== currentUser.uid)] : false;

      // Ladda meddelanden
      const messagesSnap = await getDocs(query(collection(convoRef, "messages"), orderBy("sentAt", "asc")));
      let html = '';
      // Blockeringsinfo & knappar
      if (isBlockedByMe) {
        html += `<div class="blocked-warning">Du har blockerat denna anvÃ¤ndare.<br><button class="unblock-btn" onclick="window.unblockUser('${convoId}')">Avblockera</button></div>`;
      } else if (isBlockedByOther) {
        html += `<div class="blocked-warning">Du Ã¤r blockerad av denna anvÃ¤ndare.</div>`;
      } else {
        html += `<button class="block-btn" style="float:right;" onclick="window.blockUser('${convoId}')">Blockera anvÃ¤ndare</button>`;
      }
      // Radera-knapp
      html += `<button class="delete-btn" onclick="window.deleteSelectedMessages()">Radera markerade</button>`;
      // Meddelanden
      html += `<div class="chat-messages" id="chat-messages">`;
      messagesSnap.forEach(docu => {
        const m = docu.data();
        const isMine = m.from === currentUser.uid;
        html += `
          <div class="chat-bubble-row">
            <input type="checkbox" class="msg-checkbox" value="${docu.id}">
            <div class="chat-bubble${isMine ? ' me' : ''}">
              ${m.text ? m.text : ""}
              ${m.imageUrl ? `<br><img src="${m.imageUrl}" class="chat-image" alt="Bildmeddelande"/>` : ""}
              <div class="chat-meta">${m.from === currentUser.uid ? 'Du' : 'Den andre'} â€“ ${m.sentAt && m.sentAt.seconds ? new Date(m.sentAt.seconds*1000).toLocaleString("sv-SE", { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' }) : ""}</div>
            </div>
          </div>
        `;
      });
      html += `</div>
        <form id="sendForm" class="chat-input-row" autocomplete="off" enctype="multipart/form-data">
          <input type="text" id="msgInput" class="chat-input" placeholder="Skriv meddelande..." maxlength="2000" ${isBlockedByMe || isBlockedByOther ? "disabled" : ""}/>
          <label for="fileInput" style="cursor:pointer; margin-right:6px;">
            <img src="image-icon.svg" style="width:30px;vertical-align:middle;" title="Bifoga bild"/>
          </label>
          <input type="file" id="fileInput" accept="image/*" style="display:none;" ${isBlockedByMe || isBlockedByOther ? "disabled" : ""}/>
          <button class="send-btn" type="submit" ${isBlockedByMe || isBlockedByOther ? "disabled" : ""}>Skicka</button>
        </form>
        <div id="uploadingStatus" style="color:#0ff; margin-top:2px;"></div>
      `;
      chatDiv.innerHTML = html;

      setTimeout(() => {
        const cm = document.getElementById('chat-messages');
        if (cm) cm.scrollTop = 99999;
      }, 100);

      // NollstÃ¤ll notiser nÃ¤r man Ã¶ppnar
      await updateDoc(convoRef, { [`unread.${currentUser.uid}`]: 0 });

      // Skicka meddelande (med bild)
      document.getElementById('sendForm').onsubmit = async (e) => {
        e.preventDefault();
        const msg = document.getElementById('msgInput').value.trim();
        const fileInput = document.getElementById('fileInput');
        let imageUrl = null;
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const ext = file.name.split('.').pop();
          const imgRef = storageRef(storage, `conversations/${activeConvoId}/${Date.now()}.${ext}`);
          document.getElementById('uploadingStatus').innerText = "Laddar upp bild...";
          await uploadBytes(imgRef, file);
          imageUrl = await getDownloadURL(imgRef);
          document.getElementById('uploadingStatus').innerText = "";
        }
        if (!msg && !imageUrl) return;
        await addDoc(collection(convoRef, "messages"), {
          text: msg,
          imageUrl: imageUrl || null,
          from: currentUser.uid,
          sentAt: serverTimestamp()
        });
        // Uppdatera konvo med sista meddelandet + notis fÃ¶r andra
        let otherUser = (convoData ? convoData.users : [currentUser.uid, otherId]).find(u => u !== currentUser.uid);
        await updateDoc(convoRef, {
          lastMessage: msg || "[Bild]",
          updatedAt: serverTimestamp(),
          [`unread.${otherUser}`]: (convoData && convoData.unread && convoData.unread[otherUser] ? convoData.unread[otherUser] + 1 : 1)
        });
        document.getElementById('msgInput').value = "";
        document.getElementById('fileInput').value = "";
        openConversation(convoId, otherId);
        await loadConversations();
      };
    }

    // === Blockera/avblockera ===
    window.blockUser = async function(convoId) {
      const convoRef = doc(db, 'conversations', convoId);
      await updateDoc(convoRef, { [`blocked.${currentUser.uid}`]: true });
      openConversation(convoId);
      await loadConversations();
    };
    window.unblockUser = async function(convoId) {
      const convoRef = doc(db, 'conversations', convoId);
      await updateDoc(convoRef, { [`blocked.${currentUser.uid}`]: false });
      openConversation(convoId);
      await loadConversations();
    };

    // === RADERA MARKERADE MEDDELANDEN ===
    window.deleteSelectedMessages = async function() {
      const boxes = document.querySelectorAll('.msg-checkbox:checked');
      if (boxes.length === 0) return;
      if (!confirm("Ã„r du sÃ¤ker pÃ¥ att du vill radera valda meddelanden?")) return;
      const convoRef = doc(db, 'conversations', activeConvoId);
      for (const box of boxes) {
        await deleteDoc(doc(convoRef, "messages", box.value));
      }
      openConversation(activeConvoId);
    };
  </script>
</body>
</html>
