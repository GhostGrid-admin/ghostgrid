<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Meddelanden – GhostGrid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { background: #101918; color: #b2ffb2; font-family: 'Share Tech Mono', monospace; margin: 0; }
    .messages-container { max-width: 950px; margin: 30px auto 0; padding: 32px 12px; background: #1d2b26bb; border-radius: 28px; box-shadow: 0 0 60px #21ff2144; }
    .convo-list { border-right: 2px solid #21ff21aa; min-width: 220px; max-width: 320px; }
    .convo-list, .chat-window { display: inline-block; vertical-align: top; }
    .convo-list { width: 32%; min-height: 75vh; }
    .chat-window { width: 66%; min-height: 75vh; padding-left: 28px; }
    .convo { display: flex; align-items: center; padding: 12px 14px; border-radius: 18px; margin-bottom: 6px; background: #19221e; cursor: pointer; transition: background 0.2s;}
    .convo.active, .convo:hover { background: #203b24; }
    .convo img { width: 38px; height: 38px; border-radius: 50%; margin-right: 13px; }
    .convo .name { font-size: 1.15em; }
    .convo .badge { margin-left: auto; background: #19ff19; color: #0a2a0a; min-width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; border-radius: 16px; font-weight: bold; font-size: 1.05em; box-shadow: 0 0 10px #15ff1584; }
    .chat-messages { max-height: 62vh; overflow-y: auto; padding-right: 12px; margin-bottom: 24px;}
    .chat-bubble { background: #16ff16; color: #19221e; display: inline-block; padding: 10px 16px; border-radius: 14px 14px 4px 14px; margin: 6px 0; }
    .chat-bubble.me { background: #0e2f1b; color: #7cff7c; border-radius: 14px 4px 14px 14px; margin-left: auto;}
    .chat-meta { font-size: 0.75em; color: #47ff9e; margin-top: 2px; }
    .chat-input-row { display: flex; gap: 10px; }
    .chat-input { flex: 1; padding: 8px 16px; border-radius: 14px; border: none; font-size: 1.08em; }
    .send-btn { background: #21ff21; color: #222; font-weight: bold; border: none; border-radius: 14px; padding: 8px 26px; font-size: 1em; cursor: pointer; }
    @media (max-width: 900px) {
      .convo-list, .chat-window { width: 100%; max-width: 100%; display: block;}
      .messages-container { padding: 6px; }
      .chat-window { padding-left: 0; }
    }
  </style>
</head>
<body>
  <div class="messages-container">
    <div class="convo-list" id="convo-list">
      <h2 style="text-align:center; color:#19ff19; margin:12px 0;">Meddelanden</h2>
      <!-- Konversationslistan laddas här -->
    </div>
    <div class="chat-window" id="chat-window">
      <!-- Chatten med användaren laddas här -->
      <div style="text-align:center; margin-top:42px; color:#6ad96a;">Välj en konversation eller börja skriva till någon!</div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
  <script>
    // === 1. INIT FIREBASE (byt config till din) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCR8q40Dc4wcfYBDlxdpOriA2e3RTmAesg",
      authDomain: "ghostgrid-fb278.firebaseapp.com",
      projectId: "ghostgrid-fb278",
      storageBucket: "ghostgrid-fb278.appspot.com",
      messagingSenderId: "283208202937",
      appId: "1:283208202937:web:11c0cea81fd81a31163968",
      measurementId: "G-B0WCKJCNT9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // === 2. HJÄLPFUNKTIONER ===
    // Skapar ett samtals-ID som alltid är samma för två användare oavsett ordning
    function getConversationId(uid1, uid2) {
      return [uid1, uid2].sort().join("_");
    }
    // Hämta användarinfo (displayName, foto) från profiles
    async function getUserProfile(uid) {
      const ref = db.collection('profiles').doc(uid);
      const snap = await ref.get();
      if (!snap.exists) return { displayName: "Okänd", photoURL: "default-avatar.png" };
      const data = snap.data();
      return {
        displayName: data.displayName || "Okänd",
        photoURL: data.photoURL || "default-avatar.png"
      };
    }

    // === 3. MAIN LOGIK ===
    let currentUser, conversations = [], activeConvoId = null;
    let convoUserProfiles = {}; // cache för snabb rendering

    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      await loadConversations();

      // Om vi kom hit via profilknapp: ?to=anvandarid
      const params = new URLSearchParams(window.location.search);
      const toUserId = params.get('to');
      if (toUserId) {
        // Hitta existerande konvo eller skapa ny
        const convoId = getConversationId(currentUser.uid, toUserId);
        activeConvoId = convoId;
        // Om konvo redan finns i lista, öppna den – annars skapa & ladda
        if (!conversations.find(c => c.id === convoId)) {
          // Lägg till temporär konvo till listan
          const toProfile = await getUserProfile(toUserId);
          conversations.unshift({
            id: convoId,
            users: [currentUser.uid, toUserId],
            other: toProfile,
            lastMessage: "",
            unread: 0
          });
        }
        renderConversations();
        openConversation(convoId, toUserId);
      }
    });

    // === 4. LADDA OCH VISA INKORG ===
    async function loadConversations() {
      // Hämta konversationer där currentUser.uid ingår i users-array
      const convosSnap = await db.collection('conversations')
        .where('users', 'array-contains', currentUser.uid)
        .orderBy('updatedAt', 'desc')
        .get();
      conversations = [];
      for (const doc of convosSnap.docs) {
        const data = doc.data();
        // Ta fram "andra användaren"
        const otherId = data.users.find(uid => uid !== currentUser.uid);
        if (!convoUserProfiles[otherId]) {
          convoUserProfiles[otherId] = await getUserProfile(otherId);
        }
        conversations.push({
          id: doc.id,
          users: data.users,
          other: convoUserProfiles[otherId],
          lastMessage: data.lastMessage,
          unread: data.unread && data.unread[currentUser.uid] ? data.unread[currentUser.uid] : 0
        });
      }
      renderConversations();
    }

    function renderConversations() {
      const list = document.getElementById('convo-list');
      list.innerHTML = `<h2 style="text-align:center; color:#19ff19; margin:12px 0;">Meddelanden</h2>`;
      if (conversations.length === 0) {
        list.innerHTML += `<div style="color:#85ff7e; text-align:center; margin-top:44px;">Inga konversationer än.</div>`;
        return;
      }
      conversations.forEach(convo => {
        list.innerHTML += `
          <div class="convo${convo.id === activeConvoId ? ' active' : ''}" onclick="openConversation('${convo.id}')">
            <img src="${convo.other.photoURL}" alt="Profilbild" />
            <div>
              <div class="name">${convo.other.displayName}</div>
              <div style="font-size:0.9em; color:#6bffbb">${convo.lastMessage ? convo.lastMessage.slice(0, 32) : "Ingen konvo än."}</div>
            </div>
            ${convo.unread > 0 ? `<div class="badge">${convo.unread}</div>` : ""}
          </div>
        `;
      });
    }

    // === 5. VISA CHATT OCH MEDDELANDEN ===
    async function openConversation(convoId, otherId=null) {
      activeConvoId = convoId;
      renderConversations();

      const chatDiv = document.getElementById('chat-window');
      chatDiv.innerHTML = `<div style="color:#99ffbb;text-align:center;">Laddar...</div>`;

      // Hämta eller skapa konvo
      let convoRef = db.collection('conversations').doc(convoId);
      let convoDoc = await convoRef.get();
      if (!convoDoc.exists && otherId) {
        // Skapa första gången om den inte finns
        await convoRef.set({
          users: [currentUser.uid, otherId],
          lastMessage: "",
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          unread: { [currentUser.uid]: 0, [otherId]: 0 }
        });
        convoDoc = await convoRef.get();
      }
      // Hämta meddelanden
      const messagesSnap = await convoRef.collection('messages')
        .orderBy('sentAt', 'asc').get();
      let html = `<div class="chat-messages" id="chat-messages">`;
      for (const doc of messagesSnap.docs) {
        const m = doc.data();
        html += `
          <div class="chat-bubble${m.from === currentUser.uid ? ' me' : ''}">
            ${m.text}
            <div class="chat-meta">${new Date(m.sentAt.seconds*1000).toLocaleString("sv-SE", { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' })}</div>
          </div>
        `;
      }
      html += `</div>
        <form id="sendForm" class="chat-input-row" autocomplete="off">
          <input type="text" id="msgInput" class="chat-input" placeholder="Skriv meddelande..." required maxlength="2000" />
          <button class="send-btn" type="submit">Skicka</button>
        </form>
      `;
      chatDiv.innerHTML = html;

      // Skrolla längst ner
      setTimeout(() => {
        document.getElementById('chat-messages').scrollTop = 99999;
      }, 100);

      // Nollställ notiser när man öppnar
      await convoRef.update({ [`unread.${currentUser.uid}`]: 0 });

      // Lägg till event på formulär
      document.getElementById('sendForm').onsubmit = async (e) => {
        e.preventDefault();
        const msg = document.getElementById('msgInput').value.trim();
        if (!msg) return;
        // Spara meddelande
        await convoRef.collection('messages').add({
          text: msg,
          from: currentUser.uid,
          sentAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        // Uppdatera konvo med sista meddelandet + notis för andra
        let otherUser = (convoDoc.data() ? convoDoc.data().users : [currentUser.uid, otherId]).find(u => u !== currentUser.uid);
        await convoRef.update({
          lastMessage: msg,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          [`unread.${otherUser}`]: firebase.firestore.FieldValue.increment(1)
        });
        document.getElementById('msgInput').value = "";
        openConversation(convoId); // ladda om chatten
        await loadConversations();
      }
    }

    // Gör funktionen global så onclick funkar från renderConversations
    window.openConversation = openConversation;
  </script>
</body>
</html>
