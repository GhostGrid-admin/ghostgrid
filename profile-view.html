<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profilvisning – GhostGrid</title>
  <style>
    body {
      background: black;
      color: #00ff00;
      font-family: monospace;
      margin: 0;
      padding: 0;
    }
    .profile-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      padding: 24px 0 0 0;
      gap: 30px;
      width: 100vw;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .profile-main-content {
      flex: 1 1 340px;
      max-width: 660px;
      min-width: 260px;
      width: 100%;
      margin: 0 auto 0 0;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    #profile-nickname-view {
      font-family: 'Courier New', monospace;
      font-size: 2.1em;
      margin: 35px 0 10px 0;
      color: #00ff00;
      text-shadow: 0 0 10px #00ffcc, 0 0 6px #bb00ff;
      letter-spacing: 1px;
      word-break: break-all;
      text-align: center;
    }
    #profile-output {
      width: 100%;
      min-height: 340px;
      margin: 0 auto;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: none;
      box-sizing: border-box;
      padding: 0 5vw 30px 5vw;
    }
    .album-gallery {
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
      margin-bottom: 20px;
    }
    .album-thumb {
      width: 100px;
      height: 100px;
      border: 2px solid #00ff00;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: #111;
      cursor: pointer;
      position: relative;
      font-size: 1.1em;
      color: #00ffcc;
      transition: box-shadow .2s;
    }
    .album-thumb:hover {
      box-shadow: 0 0 12px #00ffcc;
      background: #161a20;
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      color: white;
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      z-index: 1000;
    }
    .modal img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border: 1px solid #00ff00;
      margin: 10px;
      border-radius: 6px;
      position: relative;
    }
    .delete-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      background: red;
      border: none;
      color: white;
      border-radius: 50%;
      font-size: 12px;
      cursor: pointer;
    }
    .modal-controls button {
      margin: 5px;
      padding: 8px 12px;
      font-family: monospace;
      font-size: 14px;
      border-radius: 5px;
      cursor: pointer;
    }
    .confirm-box {
      background: #111;
      border: 1px solid #00ff00;
      padding: 10px;
      border-radius: 8px;
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }
    .btn-yes {
      background-color: #00ff00;
      color: black;
      border: none;
    }
    .btn-no {
      background-color: #ff0033;
      color: white;
      border: none;
    }
    #editProfileBtn {
      display: none;
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #00ff00;
      color: black;
      border: none;
      border-radius: 7px;
      padding: 12px 24px;
      font-size: 1em;
      cursor: pointer;
      z-index: 1010;
      font-family: inherit;
    }
    #editProfileBtn:hover {
      background-color: #00cc00;
    }
    @media (max-width: 850px) {
      .profile-main-content { max-width: 97vw; min-width: 90vw; }
      #profile-output { padding: 0 2vw 20px 2vw; }
    }
  </style>
</head>
<body>
  <button id="editProfileBtn" onclick="window.location.href='profile.html'">Redigera profil</button>
  <div class="profile-container">
    <div class="profile-main-content">
      <h2 id="profile-nickname-view"></h2>
      <div id="profile-output"></div>
      <div class="album-gallery" id="albumGallery"></div>
    </div>
  </div>
  <!-- Album Modal -->
  <div class="modal" id="albumModal">
    <h2 id="albumName"></h2>
    <input type="file" id="uploadImage" accept="image/*">
    <div style="display: flex; flex-wrap: wrap;" id="albumImages"></div>
    <div class="modal-controls">
      <button id="renameBtn"></button>
      <button id="deleteBtn"></button>
      <button onclick="document.getElementById('albumModal').style.display='none'">Stäng / Close</button>
    </div>
    <div id="confirmBox" class="confirm-box" style="display:none">
      <span id="confirmText"></span>
      <button class="btn-yes" onclick="deleteAlbumConfirmed()">Ja / Yes</button>
      <button class="btn-no" onclick="document.getElementById('confirmBox').style.display='none'">Nej / No</button>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './scripts/firebase-init.js';
    import {
      getDoc, doc, collection, getDocs, deleteDoc, addDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    const uid = new URLSearchParams(window.location.search).get("uid");
    const lang = document.documentElement.lang || 'sv';
    const texts = {
      sv: { rename: "Byt namn", delete: "Ta bort album", confirm: "Är du säker?" },
      en: { rename: "Rename", delete: "Delete album", confirm: "Are you sure?" }
    };
    const t = texts[lang] || texts.sv;

    document.getElementById("renameBtn").textContent = t.rename;
    document.getElementById("deleteBtn").textContent = t.delete;
    document.getElementById("confirmText").textContent = t.confirm;

    const profileOutput = document.getElementById("profile-output");
    const albumGallery = document.getElementById("albumGallery");
    let currentUser;
    let currentAlbumId = "";

    onAuthStateChanged(auth, async user => {
      if (!user) return (window.location.href = "login.html");
      currentUser = user;

      // Redigera-knapp bara på egen profil
      if (user.uid === uid) {
        document.getElementById("editProfileBtn").style.display = "block";
      }

      // PROFILDATA
      const profileRef = doc(db, "profiles", uid);
      const profileSnap = await getDoc(profileRef);
      if (profileSnap.exists()) {
        const data = profileSnap.data();
        document.getElementById("profile-nickname-view").innerText = data?.nickname || "Ingen smeknamn satt";
        profileOutput.innerHTML = data?.profileCode || `<p style='color:red;'>Ingen profilkod hittades.</p>`;
      } else {
        document.getElementById("profile-nickname-view").innerText = "Ingen profil hittades";
        profileOutput.innerHTML = "<p style='color:red;'>Den här användaren har ingen profil ännu.</p>";
      }

      // ALBUM (precis som innan)
      const albumsRef = collection(db, "users", uid, "albums");
      const albumsSnap = await getDocs(albumsRef);
      albumGallery.innerHTML = "";
      albumsSnap.forEach(albumDoc => {
        const album = document.createElement("div");
        album.className = "album-thumb";
        album.innerText = albumDoc.data().name;
        album.onclick = () => openAlbum(albumDoc.id, albumDoc.data().name);
        albumGallery.appendChild(album);
      });
    });

    // Album modal
    async function openAlbum(albumId, albumName) {
      currentAlbumId = albumId;
      const modal = document.getElementById("albumModal");
      document.getElementById("albumName").innerText = albumName;
      modal.style.display = "flex";

      const imageContainer = document.getElementById("albumImages");
      imageContainer.innerHTML = "";
      const imgCol = collection(db, "users", uid, "albums", albumId, "images");
      const imgSnap = await getDocs(imgCol);
      imgSnap.forEach(imgDoc => {
        const wrapper = document.createElement("div");
        wrapper.style.position = "relative";
        const img = document.createElement("img");
        img.src = imgDoc.data().url;
        wrapper.appendChild(img);
        if (currentUser.uid === uid) {
          const btn = document.createElement("button");
          btn.className = "delete-btn";
          btn.innerText = "X";
          btn.onclick = async () => {
            if (confirm(t.confirm)) {
              await deleteDoc(doc(db, "users", uid, "albums", albumId, "images", imgDoc.id));
              wrapper.remove();
            }
          };
          wrapper.appendChild(btn);
        }
        imageContainer.appendChild(wrapper);
      });

      const uploader = document.getElementById("uploadImage");
      uploader.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onloadend = async () => {
          const url = reader.result;
          await addDoc(collection(db, "users", uid, "albums", albumId, "images"), { url });
          openAlbum(albumId, albumName);
        };
        reader.readAsDataURL(file);
      };
    }

    window.renameAlbum = async function () {
      const newName = prompt(t.rename);
      if (!newName) return;
      await updateDoc(doc(db, "users", uid, "albums", currentAlbumId), { name: newName });
      location.reload();
    };

    window.confirmDeleteAlbum = function () {
      document.getElementById("confirmBox").style.display = "flex";
    };

    window.deleteAlbumConfirmed = async function () {
      const imagesSnap = await getDocs(collection(db, "users", uid, "albums", currentAlbumId, "images"));
      for (let img of imagesSnap.docs) {
        await deleteDoc(img.ref);
      }
      await deleteDoc(doc(db, "users", uid, "albums", currentAlbumId));
      location.reload();
    };
  </script>
</body>
</html>
