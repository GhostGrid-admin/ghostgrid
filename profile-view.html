<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profilvisning – GhostGrid</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    html, body {
      background: #0a0a0a;
      color: #e0ffff;
      font-family: 'Courier New', monospace;
      margin: 0;
      min-height: 100vh;
      width: 100vw;
      box-sizing: border-box;
      overflow-x: hidden;
      scroll-behavior: smooth;
      padding-top: 85px;
    }
    .main-content {
      width: 100vw;
      max-width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    /* UFO LOADER */
    #ufo-loader {
      position: fixed;
      top: 105px;
      left: 0;
      width: 100vw;
      height: 160px;
      z-index: 3100;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: none;
      pointer-events: none;
      transition: opacity .22s;
    }
    #ufo-loader.hide { opacity: 0; pointer-events: none; }

    .ufo-wrap {
      width: 110px; height: 70px; position: relative;
      animation: ufo-float 1.15s ease-in-out infinite alternate;
    }
    @keyframes ufo-float {
      0% { transform: translateY(0px);}
      100% { transform: translateY(14px);}
    }
    .ufo-body {
      width: 84px; height: 34px;
      background: radial-gradient(ellipse at 60% 80%, #0ff 55%, #098 100%);
      border-radius: 49% 52% 37% 37% / 69% 98% 100% 78%;
      position: absolute; left: 13px; top: 18px;
      box-shadow: 0 6px 30px #00ffe588, 0 0 12px #8000ff66;
      border-bottom: 7px solid #044; border-top: 4px solid #c0fffe77;
    }
    .ufo-glass {
      width: 38px; height: 21px;
      background: radial-gradient(ellipse at 60% 60%, #c7ffffb8 70%, #0ee7 100%);
      border-radius: 44% 53% 46% 48% / 65% 98% 96% 79%;
      position: absolute; left: 36px; top: 3px;
      box-shadow: 0 3px 11px #c7fff844;
      border-top: 2.5px solid #fff;
      border-bottom: 1.7px solid #6ef;
    }
    .ufo-lights {
      position: absolute; left: 13px; top: 40px; width: 84px; height: 13px;
      display: flex; justify-content: space-between; align-items: center;
      pointer-events: none;
    }
    .ufo-lights::before, .ufo-lights::after, .ufo-lights span {
      content: ""; display: block;
      width: 11px; height: 11px; border-radius: 50%;
      background: radial-gradient(circle, #ff0 60%, #ff0a 90%, #fff0 100%);
      box-shadow: 0 0 8px 2px #ffe06699, 0 0 1px #fff;
      animation: ufo-lights 1.1s infinite alternate;
    }
    .ufo-lights::before { background: #0ff; animation-delay: 0s;}
    .ufo-lights span    { background: #0f0; animation-delay: 0.4s;}
    .ufo-lights::after  { background: #f0f; animation-delay: 0.8s;}
    @keyframes ufo-lights {
      0% { filter: brightness(0.9) drop-shadow(0 0 2px #fff);}
      100% { filter: brightness(1.8) drop-shadow(0 0 8px #fff);}
    }

    /* ---- Resten av din profil- och box-stil, samma som wall ---- */
    .profile-header {
      width: 98vw;
      max-width: 670px;
      margin: 36px auto 32px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(18,30,40,0.98);
      border-radius: 32px;
      box-shadow: 0 0 28px #00ffe577, 0 0 18px #8000ff55;
      padding: 48px 8vw 28px 8vw;
      box-sizing: border-box;
      position: relative;
      word-break: break-word;
      overflow-wrap: break-word;
    }
    .profile-picture {
      width: 148px;
      height: 148px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 22px;
      box-shadow: 0 0 37px #00ff80cc, 0 0 17px #0ff;
      border: 3.5px solid #0ff;
      background: #111;
      display: block;
    }
    .profile-info-main {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 95vw;
      text-align: center;
    }
    .username-label {
      color: #0ff;
      font-weight: bold;
      font-size: 1.12em;
      margin-bottom: 5px;
      letter-spacing: 0.09em;
      width: 100%;
      text-align: center;
    }
    .profile-username-box {
      background: #fff;
      color: #181f21;
      padding: 13px 5vw;
      border-radius: 17px;
      font-size: 2.35em;
      font-weight: bold;
      box-shadow: 0 0 12px #0ff5, 0 0 18px #0ff2;
      border: 2.5px solid #00ffcc;
      margin: 0 0 13px 0;
      max-width: 93vw;
      word-break: normal;
      overflow-wrap: normal;
      white-space: nowrap;
      text-align: center;
    }
    .user-id-label {
      color: #0ff;
      font-weight: bold;
      font-size: 1.12em;
      margin-top: 5px;
      margin-bottom: 2px;
    }
    .user-id {
      color: #fff;
      font-size: 1.18em;
      font-family: monospace;
      background: none;
      padding: 0;
      border: none;
      text-shadow: 0 0 6px #00ffe2;
      word-break: break-all;
      overflow-wrap: break-word;
    }
    .ghostgrid-message-link {
      margin: 16px 0 0 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.4em;
      color: #00ff00;
      cursor: pointer;
      width: 100%;
    }
    .ghostgrid-message-link:hover { color: #0ff; }
    .profile-section, .profile-section * {
      box-sizing: border-box;
      max-width: 98vw !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      white-space: pre-line !important;
    }
    .profile-section {
      margin: 18px auto 0 auto;
      padding: 22px 4vw;
      border-radius: 17px;
      box-shadow: 0 0 15px #00ffe222;
      background: linear-gradient(120deg, #0e123a 70%, #202020 100%);
      font-size: 1.18em;
      color: #bff;
      word-break: break-word;
      overflow-wrap: break-word;
      width: 100%;
      max-width: 670px;
      text-align: left;
    }
    .profile-section code,
    .profile-section pre,
    .profile-section blockquote {
      max-width: 97vw !important;
      word-break: break-word !important;
      overflow-x: auto;
      display: block;
    }
    .profile-section blockquote {
      font-style: italic;
      color: #fff;
      background: #11182b;
      border-left: 4px solid #00ffcc;
      padding: 9px 12px;
      border-radius: 8px;
      margin: 12px 0;
    }
    @media (max-width: 700px) {
      .profile-header {
        max-width: 99vw;
        padding: 21px 2vw 14px 2vw;
        border-radius: 18px;
      }
      .profile-picture {
        width: 89px;
        height: 89px;
      }
      .profile-username-box {
        font-size: 1.12em;
        padding: 7px 2vw;
      }
      .profile-section {
        font-size: 0.99em;
        padding: 8px 1vw;
        max-width: 98vw;
      }
      .profile-section code, .profile-section pre, .profile-section blockquote {
        font-size: 0.92em;
        padding: 5px 2vw;
      }
    }
  </style>
</head>
<body>
  <!-- UFO Loader -->
  <div id="ufo-loader">
    <div class="ufo-wrap">
      <div class="ufo-body"></div>
      <div class="ufo-glass"></div>
      <div class="ufo-lights"><span></span></div>
    </div>
  </div>
  <nav class="navbar">
    <div class="hamburger" id="hamburgerBtn" aria-label="Meny" tabindex="0">
      <span></span><span></span><span></span>
    </div>
    <div class="nav-center">
      <ul class="nav-links">
        <li><a href="forum.html" data-i18n="forum">Forum</a></li>
        <li><a href="wall.html" data-i18n="wall">Väggen</a></li>
        <li><a href="upload.html" data-i18n="upload">Ladda upp</a></li>
        <li><a href="profile.html" data-i18n="profile">Profil</a></li>
        <li><a href="friends.html" data-i18n="friends">Vänner</a></li>
        <li><a href="ghost&glow.html" data-i18n="ghostglow">Ghost&Glow</a></li>
        <li><a href="store.html" data-i18n="store">Butik</a></li>
      </ul>
    </div>
    <button class="logout-btn" id="logoutDesktopBtn">Logga ut</button>
    <div class="nav-mobile" id="navMobile">
      <a href="forum.html" data-i18n="forum">Forum</a>
      <a href="wall.html" data-i18n="wall">Väggen</a>
      <a href="upload.html" data-i18n="upload">Ladda upp</a>
      <a href="profile.html" data-i18n="profile">Profil</a>
      <a href="friends.html" data-i18n="friends">Vänner</a>
      <a href="ghost&glow.html" data-i18n="ghostglow">Ghost&Glow</a>
      <a href="store.html" data-i18n="store">Butik</a>
      <a href="#" class="logout-link-mobile" id="logoutMobileBtn">Logga ut</a>
    </div>
  </nav>
  <div class="main-content">
    <div id="profile-output"></div>
  </div>
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCjWQB0hAO1r686hVdpBKBJkaIYMXOM8l8",
  authDomain: "ghostgrid-fb278.firebaseapp.com",
  projectId: "ghostgrid-fb278",
  storageBucket: "ghostgrid-fb278.appspot.com",
  messagingSenderId: "283208202937",
  appId: "1:283208202937:web:11c0cea81fd18a31163968"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const uid = new URLSearchParams(window.location.search).get("uid");
const profileOut = document.getElementById("profile-output");
const ufoLoader = document.getElementById("ufo-loader");
let userId = null;
let unreadTotal = 0;

function showUFO(show = true) {
  if (show) ufoLoader.classList.remove("hide");
  else ufoLoader.classList.add("hide");
}

function showStatus(text, color = "#0ff") {
  profileOut.innerHTML = `<div style="color:${color};font-size:1.15em;">${text}</div>`;
}

async function getUnreadMessagesCount() {
  if (!userId) return 0;
  let total = 0;
  try {
    const convosRef = collection(db, "conversations");
    const q = query(convosRef, where("participants", "array-contains", userId));
    const snap = await getDocs(q);
    snap.forEach(docu => {
      const data = docu.data();
      if (data.unread && typeof data.unread[userId] === "number") {
        total += data.unread[userId];
      }
    });
  } catch (err) {}
  return total;
}

async function renderProfile() {
  showUFO(true);
  try {
    if (!uid) {
      showUFO(false);
      showStatus("Ingen användare angiven.", "red");
      return;
    }
    const profileRef = doc(db, "profiles", uid);
    const snap = await getDoc(profileRef);
    if (!snap.exists()) {
      showUFO(false);
      showStatus("Ingen profil hittades.", "red");
      return;
    }
    const data = snap.data();
    const showUsername = (data.nickname || data.username || "Okänd användare");
    let profileHeader = `
      <div class="profile-header">
        ${data.profilePicUrl ? `<img src="${data.profilePicUrl}" alt="Profilbild" class="profile-picture" id="profilePicOnView">` : ""}
        <div class="profile-info-main">
          <span class="username-label">Användarnamn:</span>
          <span class="profile-username-box" id="userNameBox">${showUsername}</span>
          <span class="user-id-label">Användar-id:</span>
          <span class="user-id" id="userIdTxt">${uid}</span>
          ${userId ? `
            <a href="${userId === uid ? 'messages.html' : 'messages.html?to=' + uid}" class="ghostgrid-message-link" title="Meddelanden">
              <svg viewBox="0 0 54 54" width="38" height="38" class="ghostgrid-message-svg" aria-label="Meddelanden">
                <rect x="2.5" y="6.5" rx="12" ry="12" width="49" height="41" fill="#171c19" stroke="#19ff19" stroke-width="3"/>
                <polyline points="7,11 27,33 47,11" fill="none" stroke="#fff" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="7,43 18,27 27,37 36,27 47,43" fill="none" stroke="#19ff19" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              ${(userId === uid && unreadTotal > 0) ? `<span class="ghostgrid-badge">${unreadTotal}</span>` : ""}
            </a>
          ` : ""}
        </div>
      </div>
    `;
    let profileHtml = `
      ${profileHeader}
      <div class="profile-section">
        ${data.profileCode || `<p style='color:red'>Ingen profilkod sparad.</p>`}
      </div>
    `;
    profileOut.innerHTML = profileHtml;
    showUFO(false);
  } catch (err) {
    showUFO(false);
    showStatus("Kunde inte ladda profil.<br>" + err.message, "red");
  }
}

// === Bara här triggas laddningen, inget annat! ===
onAuthStateChanged(auth, async user => {
  userId = user ? user.uid : null;
  if (!userId) {
    showUFO(false);
    showStatus('Du är inte inloggad.<br><a href="login.html" style="color:#0ff;">Logga in här</a>', "red");
    return;
  }
  if (userId === uid) unreadTotal = await getUnreadMessagesCount();
  else unreadTotal = 0;
  await renderProfile();
});

// Logga ut-knapp
function doLogout() {
  signOut(auth).then(() => {
    window.location.href = "login.html";
  });
}
document.getElementById("logoutDesktopBtn").onclick = doLogout;
  </script>
</body>
</html>
