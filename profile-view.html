<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profilvisning ‚Äì GhostGrid</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background: black;
      color: #00ff00;
      font-family: monospace;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      box-sizing: border-box;
    }
    nav.navbar {
      width: 100%;
      background: #0a0020;
      border-bottom: 2.5px solid #bb00ff;
      box-shadow: 0 0 24px #bb00ff66;
      padding: 0;
      position: fixed;
      z-index: 999;
      top: 0;
      left: 0;
      text-align: center;
    }
    .nav-content {
      display: flex;
      gap: 56px;
      justify-content: center;
      align-items: center;
      padding: 18px 0;
    }
    .nav-content a {
      color: white;
      text-decoration: none;
      font-size: 1.32em;
      letter-spacing: 2.5px;
      text-shadow: 0 0 8px #bb00ff, 0 0 8px #00ffcc;
      font-family: 'Share Tech Mono', monospace;
      transition: 0.2s;
      padding: 3px 12px;
    }
    .nav-content a:hover { background: #00ffcc33; border-radius: 6px; color: #00fff7; }
    .profile-centerbox {
      margin: 100px auto 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 75vh;
      max-width: 600px;
      width: 96vw;
      padding-bottom: 36px;
    }
    .profile-custom {
      width: 100%;
      max-width: 620px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 350px;
      justify-content: center;
    }
    /* Reaktioner: fixera nere till h√∂ger */
    .reaction-float {
      position: fixed;
      right: 3vw;
      bottom: 3vw;
      z-index: 12;
      background: #130028ee;
      border-radius: 18px;
      border: 2px solid #00fff7;
      padding: 18px 36px 14px 36px;
      color: #fff;
      font-size: 1.12em;
      box-shadow: 0 0 28px #00fff777, 0 0 10px #ff003e66;
      font-family: monospace;
      min-width: 164px;
      text-align: center;
    }
    .reaction-btn {
      font-size: 2.0em;
      margin: 10px 8px 0 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      transition: transform 0.08s;
    }
    .reaction-btn:active {
      transform: scale(1.25);
      filter: brightness(1.5);
    }
    @media (max-width: 700px) {
      .profile-centerbox, .profile-custom { max-width: 98vw; width: 98vw;}
      .reaction-float { right: 1vw; min-width: 120px; }
      .nav-content { gap: 10px; font-size: 0.85em; padding: 7px 0; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-content">
      <a href="forum.html">Forum</a>
      <a href="store.html">Store</a>
      <a href="wall.html">V√§ggen</a>
      <a href="upload.html">Ladda upp</a>
      <a href="profile.html">Profil</a>
      <a href="friends.html">V√§nner</a>
    </div>
  </nav>
  <div class="profile-centerbox">
    <div id="profile-output" class="profile-custom"></div>
  </div>
  <div class="reaction-float" id="profileReactions">
    <span style="font-size:1.07em;">Gilla profilen:</span>
    <div>
      <button class="reaction-btn" id="profile-heart">‚ù§Ô∏è</button> <span id="profile-heart-count">0</span>
      <button class="reaction-btn" id="profile-thumb">üëç</button> <span id="profile-thumb-count">0</span>
    </div>
  </div>
  <script type="module">
    import { auth, db } from './scripts/firebase-init.js';
    import { getDoc, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    // H√§mta uid fr√•n URL
    const uid = new URLSearchParams(window.location.search).get("uid");
    const profileOutput = document.getElementById("profile-output");
    const heartBtn = document.getElementById("profile-heart");
    const thumbBtn = document.getElementById("profile-thumb");
    const heartCount = document.getElementById("profile-heart-count");
    const thumbCount = document.getElementById("profile-thumb-count");

    let currentUser = null;
    let reactions = { heart: 0, thumb: 0, userHearts: [], userThumbs: [] };

    async function renderProfile() {
      // H√§mta anv√§ndarens profilkod & profilbildsl√§nk
      const snap = await getDoc(doc(db, "profiles", uid));
      if (snap.exists()) {
        const data = snap.data();
        // Ers√§tt ${profilePicUrl} om n√•gon profil anv√§nder det i koden
        let code = data.profileCode || "";
        if (data.profilePicUrl) {
          code = code.replace(/\$\{profilePicUrl\}/g, data.profilePicUrl);
        }
        profileOutput.innerHTML = code;
      } else {
        profileOutput.innerHTML = `<div style="color:red;text-align:center;">Ingen profil hittades.</div>`;
      }
    }

    async function renderReactions() {
      // H√§mta och visa reaktionsdata fr√•n Firestore
      const snap = await getDoc(doc(db, "profiles", uid));
      if (snap.exists()) {
        const data = snap.data();
        reactions.heart = data.heartCount || 0;
        reactions.thumb = data.thumbCount || 0;
        reactions.userHearts = data.userHearts || [];
        reactions.userThumbs = data.userThumbs || [];
        heartCount.innerText = reactions.heart;
        thumbCount.innerText = reactions.thumb;
      }
    }

    async function addReaction(type) {
      // Undvik att samma anv√§ndare kan gilla flera g√•nger
      if (!currentUser) return alert("Du m√•ste vara inloggad!");
      const field = type === "heart" ? "userHearts" : "userThumbs";
      const userArr = reactions[field] || [];
      if (userArr.includes(currentUser.uid)) return;
      userArr.push(currentUser.uid);
      // Spara +1 och array till Firestore
      const update = {};
      update[type + "Count"] = (reactions[type] || 0) + 1;
      update[field] = userArr;
      await updateDoc(doc(db, "profiles", uid), update);
      renderReactions();
    }

    onAuthStateChanged(auth, async user => {
      currentUser = user;
      await renderProfile();
      await renderReactions();
    });

    heartBtn.onclick = () => addReaction("heart");
    thumbBtn.onclick = () => addReaction("thumb");
  </script>
</body>
</html>
