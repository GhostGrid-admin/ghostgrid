<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profilvisning ‚Äì GhostGrid</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background: black;
      color: #00ff00;
      font-family: 'Courier New', monospace;
      margin: 0; padding: 0; min-height: 100vh;
    }
    nav.navbar {
      background: #000;
      border-bottom: 3px solid #8d37ff;
      padding: 16px 0;
      width: 100%;
      box-shadow: 0 0 18px #8d37ff;
      display: flex;
      justify-content: center;
      align-items: center;
      position: sticky; top: 0; z-index: 99;
    }
    .nav-content { display: flex; gap: 48px; justify-content: center; }
    .nav-content a {
      color: #fff; text-decoration: none; font-size: 1.33em;
      font-family: 'Courier New', monospace; font-weight: bold;
      text-shadow: 0 0 9px #fff, 0 0 5px #bb00ff;
      padding: 3px 16px; border-radius: 7px; transition: 0.15s;
    }
    .nav-content a:hover { background: #8d37ff; color: #000; }
    .profile-main {
      display: flex; flex-direction: column; align-items: center;
      width: 100%; min-height: calc(100vh - 60px); box-sizing: border-box; padding-top: 30px;
    }
    #profileContent {
      margin: 0 auto; width: 100%; max-width: 600px;
      min-height: 350px; background: none; display: flex;
      flex-direction: column; align-items: center; position: relative;
    }
    /* Profilbild + like */
    .profile-header-flex {
      display: flex; flex-direction: row; align-items: flex-start; justify-content: center; width: 100%;
    }
    .profile-img-big {
      width: 140px; height: 140px; border-radius: 50%; border: 3px solid #00ff00;
      box-shadow: 0 0 13px #00ffcc, 0 0 8px #bb00ff; object-fit: cover; background: #111;
    }
    .profile-like-box {
      display: flex; flex-direction: column; align-items: flex-end; gap: 9px; margin-left: 24px;
      position: relative; min-width: 160px; background: #1a1a1a; border-radius: 14px;
      box-shadow: 0 0 16px #8d37ff55; border: 1px solid #00ffcc; padding: 9px 20px 10px 14px; font-size: 1em;
    }
    .profile-like-label { font-size: 1.07em; color: #fff; margin-bottom: 6px; }
    .like-btn-pic, .thumb-btn-pic, .like-btn, .thumb-btn {
      background: none; border: none; font-size: 1.45em; cursor: pointer;
      margin-left: 7px; margin-right: 2px; color: #ff4da6; transition: transform .1s;
      vertical-align: middle;
    }
    .like-btn.active, .like-btn-pic.active { color: #ff4da6; transform: scale(1.2);}
    .thumb-btn, .thumb-btn-pic { color: #00ffcc; margin-left: 12px;}
    .thumb-btn.active, .thumb-btn-pic.active { color: #00ffcc; transform: scale(1.2);}
    .like-count, .thumb-count { font-size: 1.02em; margin-right: 6px; font-weight: bold;}
    /* Flytande ruta nere i h√∂gra h√∂rnet f√∂r hela profilen */
    .floating-profile-like-box {
      position: fixed; right: 36px; bottom: 32px;
      background: #181a24ee; color: #fff; border: 2px solid #8d37ff;
      border-radius: 15px; box-shadow: 0 0 25px #00ffcc66;
      padding: 15px 32px; z-index: 1300; font-size: 1.09em; text-align: center;
      min-width: 160px;
    }
    @media (max-width: 850px) {
      .profile-header-flex { flex-direction: column; align-items: center; }
      .profile-like-box { margin-left: 0; margin-top: 14px; min-width: 90vw; width: 95vw; align-items: center; }
      .floating-profile-like-box { right: 8px; bottom: 12px; padding: 9px 8px; min-width: 120px; }
      #profileContent { max-width: 98vw;}
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-content">
      <a href="forum.html">Forum</a>
      <a href="store.html">Store</a>
      <a href="wall.html">V√§ggen</a>
      <a href="upload.html">Ladda upp</a>
      <a href="profile.html">Profil</a>
      <a href="friends.html">V√§nner</a>
    </div>
  </nav>
  <div class="profile-main">
    <div id="profileContent"></div>
  </div>
  <div class="floating-profile-like-box" id="profileLikeBox" style="display:none;">
    <div style="margin-bottom: 6px;">Gilla profilen:</div>
    <button class="like-btn" id="profile-heart">‚ù§Ô∏è</button>
    <span class="like-count" id="profile-heart-count">0</span>
    <button class="thumb-btn" id="profile-thumb">üëç</button>
    <span class="thumb-count" id="profile-thumb-count">0</span>
  </div>
  <!-- Firebase/JS -->
  <script type="module">
    import { auth, db } from './scripts/firebase-init.js';
    import { doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    // --- ELEMENT
    const profileContent = document.getElementById("profileContent");
    const profileLikeBox = document.getElementById("profileLikeBox");
    const profileHeartBtn = document.getElementById("profile-heart");
    const profileThumbBtn = document.getElementById("profile-thumb");
    const profileHeartCount = document.getElementById("profile-heart-count");
    const profileThumbCount = document.getElementById("profile-thumb-count");

    // --- UID
    const uid = new URLSearchParams(window.location.search).get("uid");
    let currentUser = null;

    // --- LADDA PROFILDATA OCH VISA
    let profilePicUrl = "";
    let profileHTML = "";

    // H√§mta profil-data fr√•n Firestore och rendera hela profilen
    async function renderProfile() {
      const ref = doc(db, "profiles", uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        profilePicUrl = data.profilePicUrl || "";
        profileHTML = data.profileCode || "";
        // Visa profil
        profileContent.innerHTML = `
          <div class="profile-header-flex">
            <img src="${profilePicUrl}" alt="Profilbild" class="profile-img-big" id="mainProfileImg">
            <div class="profile-like-box">
              <div class="profile-like-label">Gilla profilbilden:</div>
              <button class="like-btn-pic" id="pic-heart">‚ù§Ô∏è</button>
              <span class="like-count" id="pic-heart-count">0</span>
              <button class="thumb-btn-pic" id="pic-thumb">üëç</button>
              <span class="thumb-count" id="pic-thumb-count">0</span>
            </div>
          </div>
          <div style="width:100%;display:flex;justify-content:center;">
            <div id="customProfileHTML" style="margin-top:36px;width:95%;max-width:520px;">
              ${profileHTML}
            </div>
          </div>
        `;
        profileLikeBox.style.display = "block";
        setUpProfilePicReactions();
      } else {
        profileContent.innerHTML = "<h2>Profil hittades inte.</h2>";
      }
    }

    // --- LIVE REAKTIONER P√Ö PROFIL (‚ù§Ô∏èüëç) -- PROFIL, ej profilbild
    function setUpProfileReactions() {
      const profileReactionsRef = doc(db, "profiles", uid, "reactions", "all");
      // Live update
      onSnapshot(profileReactionsRef, (docSnap) => {
        const d = docSnap.exists() ? docSnap.data() : {};
        profileHeartCount.textContent = (d.heart || []).length || 0;
        profileThumbCount.textContent = (d.thumb || []).length || 0;
        if (currentUser) {
          profileHeartBtn.classList.toggle("active", (d.heart||[]).includes(currentUser.uid));
          profileThumbBtn.classList.toggle("active", (d.thumb||[]).includes(currentUser.uid));
        }
      });
      // Klick - hj√§rta
      profileHeartBtn.onclick = async () => {
        if (!currentUser) return alert("Du m√•ste vara inloggad.");
        const d = (await getDoc(profileReactionsRef)).data() || {};
        let arr = d.heart || [];
        if (arr.includes(currentUser.uid)) arr = arr.filter(x => x !== currentUser.uid);
        else arr.push(currentUser.uid);
        await setDoc(profileReactionsRef, { ...d, heart: arr }, { merge: true });
      };
      // Klick - tumme
      profileThumbBtn.onclick = async () => {
        if (!currentUser) return alert("Du m√•ste vara inloggad.");
        const d = (await getDoc(profileReactionsRef)).data() || {};
        let arr = d.thumb || [];
        if (arr.includes(currentUser.uid)) arr = arr.filter(x => x !== currentUser.uid);
        else arr.push(currentUser.uid);
        await setDoc(profileReactionsRef, { ...d, thumb: arr }, { merge: true });
      };
    }

    // --- LIVE REAKTIONER P√Ö PROFILBILD (‚ù§Ô∏èüëç)
    function setUpProfilePicReactions() {
      const picHeartBtn = document.getElementById("pic-heart");
      const picThumbBtn = document.getElementById("pic-thumb");
      const picHeartCount = document.getElementById("pic-heart-count");
      const picThumbCount = document.getElementById("pic-thumb-count");
      const picReactionsRef = doc(db, "profiles", uid, "picReactions", "all");
      // Live update
      onSnapshot(picReactionsRef, (docSnap) => {
        const d = docSnap.exists() ? docSnap.data() : {};
        picHeartCount.textContent = (d.heart || []).length || 0;
        picThumbCount.textContent = (d.thumb || []).length || 0;
        if (currentUser) {
          picHeartBtn.classList.toggle("active", (d.heart||[]).includes(currentUser.uid));
          picThumbBtn.classList.toggle("active", (d.thumb||[]).includes(currentUser.uid));
        }
      });
      // Klick - hj√§rta
      picHeartBtn.onclick = async () => {
        if (!currentUser) return alert("Du m√•ste vara inloggad.");
        const d = (await getDoc(picReactionsRef)).data() || {};
        let arr = d.heart || [];
        if (arr.includes(currentUser.uid)) arr = arr.filter(x => x !== currentUser.uid);
        else arr.push(currentUser.uid);
        await setDoc(picReactionsRef, { ...d, heart: arr }, { merge: true });
      };
      // Klick - tumme
      picThumbBtn.onclick = async () => {
        if (!currentUser) return alert("Du m√•ste vara inloggad.");
        const d = (await getDoc(picReactionsRef)).data() || {};
        let arr = d.thumb || [];
        if (arr.includes(currentUser.uid)) arr = arr.filter(x => x !== currentUser.uid);
        else arr.push(currentUser.uid);
        await setDoc(picReactionsRef, { ...d, thumb: arr }, { merge: true });
      };
    }

    // --- AUTENTISERING & INIT
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      renderProfile();
      setUpProfileReactions();
    });

  </script>
</body>
</html>
