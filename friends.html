<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vänner – GhostGrid</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { background: #090010; color: #00ff90; font-family: 'Courier New', monospace; margin: 0; padding-top: 85px; }
    .navbar { background: #000; border-bottom: 2px solid #00ffcc; box-shadow: 0 0 20px #bb00ff; position: fixed; width: 100%; top: 0; left: 0; z-index: 2000; display: flex; justify-content: center;}
    .nav-content { display: flex; gap: 28px; align-items: center; flex-wrap: wrap; justify-content: center; max-width: 1150px; width: 100%; transition: max-height 0.3s;}
    .nav-content a { color: #fff; text-decoration: none; font-size: 1.18em; border-radius: 6px; padding: 8px 16px; font-weight: 700; background: transparent; text-shadow: 0 0 11px #00ffcc, 0 0 7px #bb00ff; transition: 0.18s;}
    .nav-content a:hover { color: #0ff; background: #191931; box-shadow: 0 0 14px #00ffcc88, 0 0 7px #bb00ff99; }
    .search-container { margin-left: 25px; }
    .search-container input {
      padding: 9px 16px; font-size: 1.07em; background: #111; border: 2px solid #00ffcc;
      border-radius: 9px; color: #fff; box-shadow: 0 0 10px #7b00ff, 0 0 2px #00ffcc; width: 190px;
    }
    .hamburger { display: none; flex-direction: column; justify-content: center; align-items: center; width: 44px; height: 44px; margin-left: 18px; cursor: pointer; }
    .hamburger span { width: 31px; height: 4px; margin: 3.5px 0; background: #00ffcc; border-radius: 2px; transition: all 0.3s; }
    @media (max-width: 800px) {
      .nav-content { flex-direction: column; gap: 11px; max-height: 0; overflow: hidden; width: 100vw; background: #181f26; position: fixed; left: 0; top: 61px; z-index: 2020; padding-bottom: 16px;}
      .nav-content.show { max-height: 500px; box-shadow: 0 5px 25px #00ffcc77; }
      .search-container { margin-left: 0; margin-top: 12px; }
      .hamburger { display: flex; }
    }
    .friends-container { max-width: 620px; margin: 35px auto; padding: 22px 7px; }
    h2 { color: #00ffb6; text-align: center; margin-bottom: 15px; letter-spacing: 1.2px;}
    .friend-card, .search-result, .block-card {
      background: #111c; border: 1px solid #00ff88; border-radius: 9px;
      padding: 15px; margin-bottom: 16px; box-shadow: 0 0 10px #00ff88a0;
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
    }
    .friend-info, .search-info, .block-info { font-size: 1.08em; }
    .icon-btn {
      display: inline-flex; align-items: center; background: none; border: none; cursor: pointer; margin-left: 5px;
      font-size: 1.3em; color: #00ff88; transition: color .19s;
    }
    .icon-btn:hover { color: #0ff; }
    .action-btn {
      margin-left: 9px; padding: 6px 11px; background: #00ff88; color: #141919;
      border: none; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 1em;
      font-weight: 600; transition: background 0.18s;
    }
    .action-btn:hover { background: #00dbaa; }
    .confirm-dialog {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000b; display: flex; align-items: center; justify-content: center; z-index: 99999;
    }
    .confirm-box {
      background: #121c24; border-radius: 18px; padding: 32px 38px; box-shadow: 0 0 42px #00ffd922; text-align: center; color: #fff;
    }
    .confirm-box button { margin: 0 18px; }
    @media (max-width: 600px) { .friends-container { padding: 8px 2vw; } .friend-card, .search-result, .block-card { flex-direction: column; align-items: flex-start; gap: 7px; } }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="hamburger" id="hamburgerBtn" tabindex="0" aria-label="Meny">
      <span></span><span></span><span></span>
    </div>
    <div class="nav-content" id="navLinks">
      <a href="forum.html" data-i18n="forum">Forum</a>
      <a href="store.html" data-i18n="store">Butik</a>
      <a href="wall.html" data-i18n="wall">Väggen</a>
      <a href="upload.html" data-i18n="upload">Ladda upp</a>
      <a href="profile.html" data-i18n="profile">Profil</a>
      <a href="friends.html" data-i18n="friends">Vänner</a>
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Sök på användarnamn eller ID..." />
      </div>
    </div>
  </nav>

  <div class="friends-container">
    <h2 data-i18n="your_friends">Dina vänner</h2>
    <div id="friendList"></div>
    <h2 data-i18n="friend_requests">Inkommande vänförfrågningar</h2>
    <div id="incomingRequests"></div>
    <h2 data-i18n="search_results">Sökresultat</h2>
    <div id="searchResults"></div>
    <h2 data-i18n="blocked">Blockerade användare</h2>
    <div id="blockList"></div>
  </div>
  <div id="confirmDialog" style="display:none;"></div>
  <script type="module">
    // ====== FIREBASE INIT ======
    import { db, auth } from "./scripts/firebase-init.js";
    import {
      collection, doc, getDoc, getDocs, setDoc, deleteDoc, updateDoc, arrayUnion, arrayRemove, serverTimestamp, query, where
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    // ====== TRANSLATIONS ======
    const translations = {
      sv: {
        forum: "Forum", store: "Butik", wall: "Väggen", upload: "Ladda upp", profile: "Profil", friends: "Vänner",
        your_friends: "Dina vänner", friend_requests: "Inkommande vänförfrågningar", search_results: "Sökresultat", blocked: "Blockerade användare",
        search_placeholder: "Sök på användarnamn eller ID...",
        add_friend: "Lägg till vän", message: "Meddela", accept: "Acceptera", decline: "Neka", incoming_request: "skickade en förfrågan.",
        request_sent: "Vänförfrågan skickad till", remove_friend: "Ta bort vän", friend_removed: "Vän borttagen.",
        already_friend: "Redan vän", myself: "Detta är du.", block: "Blockera", unblock: "Avblockera",
        blocked_you: "Du har blockerat denna användare.", remove_block: "Avblockera", confirm_remove_friend: "Ta bort vän?", confirm_block: "Blockera användaren?", confirm_unblock: "Avblockera användaren?", confirm: "Ja", cancel: "Nej", add_back: "Lägg till igen"
      },
      en: {
        forum: "Forum", store: "Store", wall: "Wall", upload: "Upload", profile: "Profile", friends: "Friends",
        your_friends: "Your friends", friend_requests: "Incoming friend requests", search_results: "Search results", blocked: "Blocked users",
        search_placeholder: "Search username or ID...",
        add_friend: "Add friend", message: "Message", accept: "Accept", decline: "Decline", incoming_request: "sent you a friend request.",
        request_sent: "Friend request sent to", remove_friend: "Remove friend", friend_removed: "Friend removed.",
        already_friend: "Already friends", myself: "This is you.", block: "Block", unblock: "Unblock",
        blocked_you: "You have blocked this user.", remove_block: "Unblock", confirm_remove_friend: "Remove friend?", confirm_block: "Block user?", confirm_unblock: "Unblock user?", confirm: "Yes", cancel: "No", add_back: "Add back"
      }
    };
    function t(key) {
      const lang = localStorage.lang === "en" ? "en" : "sv";
      return translations[lang][key] || key;
    }
    function applyTranslations() {
      document.querySelectorAll("[data-i18n]").forEach(el => { el.textContent = t(el.getAttribute("data-i18n")); });
      document.getElementById("searchInput").placeholder = t("search_placeholder");
      document.title = "GhostGrid – " + t("friends");
    }
    applyTranslations();
    // ====== HAMBURGER ======
    const hamburgerBtn = document.getElementById("hamburgerBtn");
    const navLinks = document.getElementById("navLinks");
    hamburgerBtn.addEventListener("click", () => navLinks.classList.toggle("show"));
    navLinks.querySelectorAll('a').forEach(a => a.onclick = () => navLinks.classList.remove("show"));
    // ====== LOGIC ======
    const friendList = document.getElementById("friendList");
    const blockList = document.getElementById("blockList");
    const searchInput = document.getElementById("searchInput");
    const searchResults = document.getElementById("searchResults");
    const incomingDiv = document.getElementById("incomingRequests");
    const confirmDialog = document.getElementById("confirmDialog");
    let currentUserId = null;
    let currentUsername = "";
    let myFriends = [], myBlocked = [];
    function confirmBox(message, yesFn) {
      confirmDialog.innerHTML = `<div class="confirm-dialog">
        <div class="confirm-box">
          <div style="margin-bottom:22px">${message}</div>
          <button class="action-btn" id="yesBtn">${t("confirm")}</button>
          <button class="action-btn" id="noBtn">${t("cancel")}</button>
        </div>
      </div>`;
      confirmDialog.style.display = "";
      document.getElementById("yesBtn").onclick = () => { confirmDialog.style.display = "none"; yesFn(); };
      document.getElementById("noBtn").onclick = () => { confirmDialog.style.display = "none"; };
    }
    // ==== ON AUTH ====
    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "login.html";
      currentUserId = user.uid;
      // Get own username, friends & blocklist
      const meDoc = await getDoc(doc(db, "users", currentUserId));
      if (meDoc.exists()) {
        currentUsername = meDoc.data().username;
        myFriends = meDoc.data().friends || [];
        myBlocked = meDoc.data().blocked || [];
      }
      renderFriends();
      renderBlocks();
      renderRequests();
    });
    // ==== RENDER FRIENDS ====
    async function renderFriends() {
      friendList.innerHTML = "";
      for (let f of myFriends) {
        // Get friend's username if not present
        let username = f.username || (await getDoc(doc(db, "users", f.id))).data()?.username || f.id;
        let el = document.createElement("div");
        el.className = "friend-card";
        el.innerHTML = `
          <span class="friend-info"><b>${username}</b> <span style="font-size:0.93em;opacity:0.65;">(${f.id})</span></span>
          <span>
            <button class="icon-btn" title="${t("message")}" onclick="alert('Meddelanden kommer!')">
              <svg width="25" height="25" viewBox="0 0 54 54"><rect x="2.5" y="6.5" rx="12" width="49" height="41" fill="#171c19" stroke="#19ff19" stroke-width="3"/><polyline points="7,11 27,33 47,11" fill="none" stroke="#fff" stroke-width="3.5" stroke-linecap="round"/><polyline points="7,43 18,27 27,37 36,27 47,43" fill="none" stroke="#19ff19" stroke-width="2.8" stroke-linecap="round"/></svg>
            </button>
            <button class="action-btn" onclick="window.confirmRemoveFriend('${f.id}','${username}')">${t("remove_friend")}</button>
            <button class="action-btn" onclick="window.confirmBlockFriend('${f.id}','${username}')">${t("block")}</button>
          </span>
        `;
        friendList.appendChild(el);
      }
    }
    // ==== RENDER BLOCKS ====
    async function renderBlocks() {
      blockList.innerHTML = "";
      for (let b of myBlocked) {
        let username = b.username || (await getDoc(doc(db, "users", b.id))).data()?.username || b.id;
        let el = document.createElement("div");
        el.className = "block-card";
        el.innerHTML = `
          <span class="block-info"><b>${username}</b> <span style="font-size:0.93em;opacity:0.65;">(${b.id})</span></span>
          <span>
            <button class="action-btn" onclick="window.confirmUnblock('${b.id}','${username}')">${t("unblock")}</button>
          </span>
        `;
        blockList.appendChild(el);
      }
    }
    // ==== FRIEND REQUESTS ====
    async function renderRequests() {
      incomingDiv.innerHTML = "";
      const reqSnap = await getDocs(collection(db, "users", currentUserId, "friendRequests"));
      reqSnap.forEach((docSnap) => {
        const fromId = docSnap.id;
        const fromData = docSnap.data();
        let el = document.createElement("div");
        el.className = "friend-card";
        el.innerHTML = `
          <span class="friend-info"><b>${fromData.username || fromId}</b> <span style="font-size:0.93em;opacity:0.65;">(${fromId})</span> ${t("incoming_request")}</span>
          <span>
            <button class="action-btn" onclick="window.acceptRequest('${fromId}','${fromData.username||fromId}')">${t("accept")}</button>
            <button class="action-btn" onclick="window.declineRequest('${fromId}')">${t("decline")}</button>
          </span>
        `;
        incomingDiv.appendChild(el);
      });
    }
    // ==== SEARCH ====
    searchInput.addEventListener("input", async () => {
      const search = searchInput.value.trim().toLowerCase();
      searchResults.innerHTML = "";
      if (!search || search.length < 2) return;
      // Sök både på username och id
      const q = query(collection(db, "users"));
      const snapshot = await getDocs(q);
      snapshot.forEach(docSnap => {
        if (docSnap.id === currentUserId) return;
        const data = docSnap.data();
        let found = data.username?.toLowerCase().includes(search) || docSnap.id === search;
        // Visa inte vänner eller blockade
        if (found && !myFriends.some(f=>f.id===docSnap.id) && !myBlocked.some(b=>b.id===docSnap.id)) {
          let el = document.createElement("div");
          el.className = "search-result";
          el.innerHTML = `
            <span class="search-info"><b>${data.username}</b> <span style="font-size:0.93em;opacity:0.65;">(${docSnap.id})</span></span>
            <span>
              <button class="icon-btn" title="${t("message")}" onclick="alert('Meddelanden kommer!')">
                <svg width="25" height="25" viewBox="0 0 54 54"><rect x="2.5" y="6.5" rx="12" width="49" height="41" fill="#171c19" stroke="#19ff19" stroke-width="3"/><polyline points="7,11 27,33 47,11" fill="none" stroke="#fff" stroke-width="3.5" stroke-linecap="round"/><polyline points="7,43 18,27 27,37 36,27 47,43" fill="none" stroke="#19ff19" stroke-width="2.8" stroke-linecap="round"/></svg>
              </button>
              <button class="action-btn" onclick="window.sendFriendRequest('${docSnap.id}','${data.username}')">${t("add_friend")}</button>
              <button class="action-btn" onclick="window.confirmBlockFriend('${docSnap.id}','${data.username}')">${t("block")}</button>
            </span>
          `;
          searchResults.appendChild(el);
        }
      });
    });
    // ==== GLOBAL FUNCTIONS ====
    window.sendFriendRequest = async (receiverId, receiverUsername) => {
      if (!currentUserId) return;
      await setDoc(doc(db, "users", receiverId, "friendRequests", currentUserId), {
        username: currentUsername, timestamp: serverTimestamp()
      });
      alert(`${t("request_sent")} ${receiverUsername}!`);
    };
    window.acceptRequest = async (fromId, fromUsername) => {
      await updateDoc(doc(db, "users", currentUserId), { friends: arrayUnion({ id: fromId, username: fromUsername }) });
      await updateDoc(doc(db, "users", fromId), { friends: arrayUnion({ id: currentUserId, username: currentUsername }) });
      await deleteDoc(doc(db, "users", currentUserId, "friendRequests", fromId));
      location.reload();
    };
    window.declineRequest = async (fromId) => {
      await deleteDoc(doc(db, "users", currentUserId, "friendRequests", fromId));
      renderRequests();
    };
    window.confirmRemoveFriend = (id, username) => {
      confirmBox(`${t("confirm_remove_friend")}<br>${username}?`, async ()=>{
        await updateDoc(doc(db, "users", currentUserId), { friends: myFriends.filter(f=>f.id!==id) });
        // (ej permanent: man kan återlägga, så bara ta bort från friends)
        location.reload();
      });
    };
    window.confirmBlockFriend = (id, username) => {
      confirmBox(`${t("confirm_block")}<br>${username}?`, async ()=>{
        await updateDoc(doc(db, "users", currentUserId), {
          blocked: arrayUnion({ id, username }),
          friends: myFriends.filter(f=>f.id!==id)
        });
        location.reload();
      });
    };
    window.confirmUnblock = (id, username) => {
      confirmBox(`${t("confirm_unblock")}<br>${username}?`, async ()=>{
        await updateDoc(doc(db, "users", currentUserId), {
          blocked: myBlocked.filter(b=>b.id!==id)
        });
        location.reload();
      });
    };
  </script>
</body>
</html>
